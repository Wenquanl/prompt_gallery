{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>灵感图库 - AI Prompt Gallery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="{% static 'gallery/favicon.svg' %}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{% static 'gallery/style.css' %}">
    
    <style>
        /* Bilibili 风格分页样式 */
        .bili-pagination-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 50px;
            font-size: 14px;
            color: #666;
            flex-wrap: wrap;
            gap: 5px;
            user-select: none;
        }

        .bili-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 34px;
            min-width: 34px;
            padding: 0 12px;
            margin: 0 2px;
            border: 1px solid #e3e5e7;
            border-radius: 4px;
            background-color: #fff;
            color: #61666d;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            font-family: inherit;
        }

        .bili-btn:hover:not(.disabled):not(.active) {
            border-color: #00aeec; /* B站蓝 */
            color: #00aeec;
            text-decoration: none;
        }

        .bili-btn.active {
            background-color: #00aeec;
            border-color: #00aeec;
            color: #fff;
            cursor: default;
        }

        .bili-btn.disabled {
            background-color: #f6f7f8;
            color: #c0c4cc;
            cursor: not-allowed;
            border-color: #e3e5e7;
            pointer-events: none;
        }

        .bili-ellipsis {
            margin: 0 4px;
            color: #999;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .bili-jump-box {
            display: inline-flex;
            align-items: center;
            margin-left: 15px;
            color: #61666d;
        }

        .bili-input {
            width: 50px;
            height: 34px;
            margin: 0 8px;
            padding: 0 4px;
            border: 1px solid #e3e5e7;
            border-radius: 4px;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
            color: #61666d;
            background: transparent;
        }

        .bili-input:focus {
            border-color: #00aeec;
        }
        
        .bili-input::-webkit-inner-spin-button, 
        .bili-input::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }

        /* 优化 Tooltip 样式以展示长文本 */
        .tooltip-inner {
            max-width: 350px !important; /* 增加宽度 */
            text-align: left !important; /* 左对齐 */
            padding: 10px 12px !important;
            font-size: 0.85rem;
            line-height: 1.4;
            background-color: rgba(0, 0, 0, 0.9) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>

{% include 'gallery/components/navbar.html' %}

<div class="container py-5">
    {% if not search_query and not current_filter and not image_search_active %}
    <div class="row justify-content-center hero-section">
        <div class="col-lg-8">
            <h1 class="hero-title">探索创意图片与提示词</h1>
            <p class="hero-subtitle">发现令人惊叹的 AI 生成图片及其对应的提示词，获取灵感。</p>
        </div>
    </div>
    {% endif %}

    {% if tags_bar %}
    <div class="tags-bar-wrapper">
        <div class="tags-scroll-container">
            <a href="{% url 'home' %}" class="tag-pill {% if not search_query and not image_search_active %}active{% endif %}">
                全部
            </a>

            {% for tag in tags_bar %}
                {% if tag.is_model == 1 %}
                <a href="/?q={{ tag.name }}" 
                   class="tag-pill model-tag {% if search_query == tag.name %}active{% endif %}">
                    <i class="bi bi-robot me-1"></i>
                    {{ tag.name }}
                </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if search_query or image_search_active %}
    <div class="row justify-content-center mb-4">
        <div class="col-12 text-center">
            <span class="badge bg-white text-primary shadow-sm px-3 py-2 rounded-pill fw-normal" 
                  style="backdrop-filter: blur(5px); background: rgba(255,255,255,0.6)!important;">
                {% if image_search_active %}
                    <i class="bi bi-camera-fill me-2"></i>正在显示“以图搜图”结果
                {% else %}
                    正在显示 "{{ search_query }}" 的搜索结果
                {% endif %}
                <a href="/" class="ms-2 text-danger text-decoration-none fw-bold"><i class="bi bi-x-circle-fill"></i></a>
            </span>
        </div>
    </div>
    {% endif %}

    <div id="masonry-grid">
        {% for group in page_obj %}
        <div class="grid-item">
            <div class="gallery-card masonry-entry h-100 d-block position-relative group-card-container" id="group-card-{{ group.pk }}"
                 style="animation-delay: {{ forloop.counter0|stringformat:'d' }}00ms;">
                 
                <button class="btn-card-float position-absolute top-0 end-0 m-2 z-3" 
                        style="right: 52px!important;" 
                        onclick="copyHomePrompt(event, '{{ group.prompt_text|escapejs }}')"
                        title="复制提示词">
                    <i class="bi bi-clipboard text-primary"></i>
                </button>
                
                <button class="btn-card-float position-absolute top-0 end-0 m-2 {% if group.is_liked %}active{% endif %}"
                        onclick="toggleGroupLike(event, {{ group.pk }}, {% if group.is_liked %}true{% else %}false{% endif %})">
                    <i class="bi {% if group.is_liked %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                </button>

                <a href="{% url 'detail' group.pk %}?from=home&page={{ page_obj.number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filter %}&filter={{ current_filter }}{% endif %}" class="text-decoration-none text-dark">
                    <div class="img-wrapper">
                        {% with cover=group.images.first %}
                            {% if cover %}
                                <img src="{{ cover.thumbnail.url }}" alt="{{ group.title }}">
                            {% else %}
                                <div class="d-flex align-items-center justify-content-center h-100 w-100 text-secondary bg-light bg-opacity-50" style="min-height: 200px;">
                                    <i class="bi bi-image fs-1 opacity-50"></i>
                                </div>
                            {% endif %}
                        {% endwith %}
                        
                        {% if group.references.all %}
                        <div class="ref-stack-container">
                            {% for ref in group.references.all|slice:":4" %}
                            <div class="ref-item">
                                <img src="{{ ref.thumbnail.url }}" alt="Ref">
                            </div>
                            {% endfor %}
                            {% if group.references.count > 4 %}
                            <div class="ref-more-badge">+{{ group.references.count|add:"-4" }}</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if group.images.count > 1 %}
                        <div class="img-badge"><i class="bi bi-images me-1"></i>{{ group.images.count }}</div>
                        {% endif %}
                    </div>

                    <div class="card-body p-3">
                        <h5 class="card-title text-truncate mb-2">{{ group.title }}</h5>
                        
                        <div class="mb-2" style="height: 28px; overflow: hidden;">
                            {% for tag in group.tags.all|slice:":3" %}
                            <object><a href="/?q={{ tag.name }}" class="tag-badge">{{ tag.name }}</a></object>
                            {% endfor %}
                            {% if group.tags.count > 3 %}
                            <span class="text-muted small align-middle">+{{ group.tags.count|add:"-3" }}</span>
                            {% endif %}
                        </div>

                        <p class="card-text text-clamp" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="bottom" 
                           title="{{ group.prompt_text }}">
                           {{ group.prompt_text }}
                        </p>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3 border-top border-light pt-2 text-muted small">
                            <span><i class="bi bi-clock me-1"></i>{{ group.created_at|date:"m-d" }}</span>
                            <span>查看详情 &rarr;</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-5 text-muted w-100" style="float: none; width: 100%;">
            <div class="my-5 p-5 gallery-card d-inline-block" style="width: auto;">
                <i class="bi bi-stars fs-1 d-block mb-3 text-primary opacity-50"></i>
                <h4>暂无内容</h4>
                <p class="mb-0">这里空空如也。</p>
                {% if search_query or current_filter %}
                <a href="/" class="btn btn-primary mt-3 btn-sm rounded-pill">查看所有图片</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not image_search_active %}
    {% if page_obj.paginator.num_pages > 1 %}
    <div class="bili-pagination-wrapper">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filter %}&filter={{ current_filter }}{% endif %}" class="bili-btn">上一页</a>
        {% else %}
        <span class="bili-btn disabled">上一页</span>
        {% endif %}

        <a href="?page=1{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filter %}&filter={{ current_filter }}{% endif %}" 
           class="bili-btn {% if page_obj.number == 1 %}active{% endif %}">1</a>

        {% if page_obj.number > 3 %}
            <span class="bili-ellipsis">...</span>
        {% endif %}

        {% if page_obj.number > 2 %}
            <a href="?page={{ page_obj.number|add:'-1' }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filter %}&filter={{ current_filter }}{% endif %}" 
               class="bili-btn">{{ page_obj.number|add:'-1' }}</a>
        {% endif %}

        {% if page_obj.number != 1 and page_obj.number != page_obj.paginator.num_pages %}
            <span class="bili-btn active">{{ page_obj.number }}</span>
        {% endif %}

        {% if page_obj.number < page_obj.paginator.num_pages|add:'-1' %}
            <a href="?page={{ page_obj.number|add:'1' }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filter %}&filter={{ current_filter }}{% endif %}" 
               class="bili-btn">{{ page_obj.number|add:'1' }}</a>
        {% endif %}

        {% if page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
            <span class="bili-ellipsis">...</span>
        {% endif %}

        <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filter %}&filter={{ current_filter }}{% endif %}" 
           class="bili-btn {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}">{{ page_obj.paginator.num_pages }}</a>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_filter %}&filter={{ current_filter }}{% endif %}" class="bili-btn">下一页</a>
        {% else %}
        <span class="bili-btn disabled">下一页</span>
        {% endif %}

        <div class="bili-jump-box">
            共 {{ page_obj.paginator.num_pages }} 页，跳至
            <input type="number" id="jumpPageInput" class="bili-input" min="1" max="{{ page_obj.paginator.num_pages }}" 
                   onkeydown="if(event.key==='Enter') jumpToPage({{ page_obj.paginator.num_pages }})">
            页
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

<div class="d-md-none fixed-bottom p-2 text-center" style="background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.5);">
    <div class="d-flex gap-2 justify-content-center mb-2">
        <a href="{% url 'liked_images_gallery' %}" class="btn btn-sm btn-platform rounded-pill flex-fill"><i class="bi bi-images me-1 text-primary"></i>喜欢的单图</a>
    </div>
    <div class="d-flex gap-2">
         <form action="{% url 'home' %}" method="get" class="d-flex flex-fill" onsubmit="return this.q.value.trim() !== ''">
            <input type="text" name="q" class="form-control form-control-sm rounded-pill me-2" placeholder="搜索..." value="{{ search_query|default:'' }}">
            <button class="btn btn-primary btn-sm rounded-circle" type="submit"><i class="bi bi-search"></i></button>
        </form>
         <button type="button" class="btn btn-outline-primary btn-sm rounded-circle d-flex align-items-center justify-content-center me-2" onclick="document.getElementById('hiddenHomeImageInput').click()" style="width:32px; height:32px;" title="以图搜图"><i class="bi bi-camera-fill"></i></button>
         <a href="{% url 'upload' %}?next={{ request.get_full_path|urlencode }}" class="btn btn-primary btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width:32px; height:32px;"><i class="bi bi-plus-lg"></i></a>
    </div>
</div>

<button class="btn-float-tags d-none d-lg-flex" type="button" data-bs-toggle="offcanvas" data-bs-target="#tagsOffcanvas" aria-controls="tagsOffcanvas" title="更多标签分类">
    <i class="bi bi-grid-fill fs-5"></i>
</button>

<div class="offcanvas offcanvas-start rounded-end-4 border-0 shadow-lg" tabindex="-1" id="tagsOffcanvas" aria-labelledby="tagsOffcanvasLabel" style="width: 320px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);">
    <div class="offcanvas-header pt-4 ps-4">
        <h5 class="offcanvas-title fw-bold text-dark" id="tagsOffcanvasLabel">
            <i class="bi bi-collection-fill text-primary me-2"></i>全部分类
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body ps-4 pe-3">
        <p class="text-muted small mb-3">按标签筛选图片：</p>
        <div class="d-flex flex-wrap gap-2">
            {% for tag in tags_bar %}
                {% if tag.is_model != 1 %} 
                <a href="/?q={{ tag.name }}" 
                   class="drawer-tag {% if search_query == tag.name %}active{% endif %}">
                    {{ tag.name }}
                    <span class="count-badge">{{ tag.use_count }}</span>
                </a>
                {% endif %}
            {% endfor %}
        </div>
        
        {% if not tags_bar %}
        <div class="text-center text-muted py-5 small">
            暂无其他标签
        </div>
        {% endif %}
    </div>
</div>

<button class="btn-float-check" onclick="openCheckModal()" title="全库查重">
    <i class="bi bi-shield-check fs-4"></i>
</button>

<div class="modal fade" id="checkDuplicatesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4" style="overflow:hidden;">
            <div class="modal-header border-0 bg-light">
                <h5 class="modal-title fw-bold text-dark"><i class="bi bi-shield-check text-primary me-2"></i>全库查重工具</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="upload-area-dashed mb-4"></div>
                <div id="checkResultsArea" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">检测结果</h6>
                        <span id="checkSummary" class="badge bg-light text-dark border"></span>
                    </div>
                    <div class="results-scroll-box custom-scrollbar" id="resultsList"></div>
                    <div class="mt-4 text-center" id="actionArea"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<button class="btn-float-manage" onclick="openMergeModal()" title="版本合并管理" 
        style="position: fixed; right: 20px; bottom: 140px; width: 50px; height: 50px; border-radius: 50%; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none; z-index: 1030; display: flex; align-items: center; justify-content: center; transition: all 0.3s; color: #333;">
    <i class="bi bi-intersect fs-4"></i>
</button>

<div class="modal fade" id="mergeManagerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4" style="height: 80vh;">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-intersect text-primary me-2"></i>版本合并管理
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-0 d-flex flex-column h-100">
                <div class="p-3 bg-light border-bottom">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                                <input type="text" id="mergeSearchInput" class="form-control border-start-0 ps-0" placeholder="搜索要合并的提示词组 (标题/Prompt)...">
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="text-muted small">
                                已选中 <span id="mergeSelectedCount" class="fw-bold text-primary fs-5">0</span> 个
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-grow-1 overflow-auto bg-light p-3" id="mergeListContainer">
                    <div id="mergeListContent" class="d-flex flex-column gap-2">
                        </div>
                    
                    <div id="mergeLoadMore" class="text-center py-3" style="display:none;">
                        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="loadMergeData(currentPage + 1)">加载更多</button>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-top-0 pt-0 pb-3 pe-4">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="submitMerge()">
                    <i class="bi bi-check-lg me-1"></i>确认合并
                </button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js"></script>
<script src="{% static 'gallery/js/common.js' %}"></script>
<script src="{% static 'gallery/js/check_duplicates.js' %}"></script>
<script>
    let mergeModal;
    let selectedMergeIds = new Set(); // 存储选中的ID
    let currentPage = 1;
    let currentQuery = '';
    let isLoading = false;

    // 打开弹窗
    function openMergeModal() {
        if (!mergeModal) {
            mergeModal = new bootstrap.Modal(document.getElementById('mergeManagerModal'));
        }
        mergeModal.show();
        
        // 首次打开加载第一页
        if (document.getElementById('mergeListContent').children.length === 0) {
            loadMergeData(1, true);
        }
    }

    // 搜索监听 (防抖)
    let debounceTimer;
    document.getElementById('mergeSearchInput').addEventListener('input', function(e) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            currentQuery = e.target.value.trim();
            loadMergeData(1, true);
        }, 500);
    });

    // 加载数据核心函数
    function loadMergeData(page, reset = false) {
        if (isLoading) return;
        isLoading = true;
        
        const container = document.getElementById('mergeListContent');
        const loadMoreBtn = document.getElementById('mergeLoadMore');
        
        if (reset) {
            container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-hourglass-split me-2"></i>加载中...</div>';
            currentPage = 1;
        }

        fetch(`api/groups/?page=${page}&q=${encodeURIComponent(currentQuery)}`)
            .then(res => res.json())
            .then(data => {
                if (reset) container.innerHTML = '';
                
                if (data.results.length === 0 && reset) {
                    container.innerHTML = '<div class="text-center py-5 text-muted">未找到相关内容</div>';
                    loadMoreBtn.style.display = 'none';
                    return;
                }

                data.results.forEach(item => {
                const isChecked = selectedMergeIds.has(String(item.id)) ? 'checked' : '';
                const activeClass = isChecked ? 'border-primary bg-primary bg-opacity-10' : 'border-0 bg-white';
                
                // 【新增】判断是否显示数量徽章
                let badgeHtml = '';
                if (item.count > 1) {
                    badgeHtml = `<span class="badge bg-primary bg-opacity-75 rounded-pill position-absolute top-0 end-0 m-2 shadow-sm" style="font-size: 0.7rem;">
                                    <i class="bi bi-layers-fill me-1"></i>${item.count} 个版本
                                </span>`;
                }
                
                const html = `
                    <div class="card shadow-sm merge-item-card ${activeClass} position-relative" 
                        onclick="toggleMergeSelection(this, '${item.id}')" 
                        style="cursor: pointer; transition: all 0.2s;">
                        
                        ${badgeHtml} <div class="card-body p-2 d-flex align-items-center">
                            <div class="me-3 ps-2">
                                <input type="checkbox" class="form-check-input merge-checkbox" 
                                    ${isChecked} style="transform: scale(1.2); pointer-events: none;">
                            </div>
                            
                            <div class="rounded overflow-hidden bg-secondary me-3" style="width: 60px; height: 60px; flex-shrink: 0;">
                                ${item.cover_url ? `<img src="${item.cover_url}" class="w-100 h-100 object-fit-cover">` : '<div class="w-100 h-100 d-flex align-items-center justify-content-center text-white"><i class="bi bi-image"></i></div>'}
                            </div>
                            
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="d-flex justify-content-between align-items-center pe-2">
                                    <h6 class="mb-1 text-truncate fw-bold text-dark" style="max-width: 70%;">${item.title}</h6>
                                    <span class="badge bg-light text-muted border fw-normal">${item.created_at}</span>
                                </div>
                                <div class="small text-muted text-truncate">${item.prompt_text}</div>
                                <div class="small text-primary mt-1">
                                    <i class="bi bi-robot me-1"></i>${item.model_info || '未知模型'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });

                // 处理分页按钮
                if (data.has_next) {
                    loadMoreBtn.style.display = 'block';
                    currentPage = page;
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            })
            .catch(err => {
                console.error(err);
                if(reset) container.innerHTML = '<div class="text-center text-danger py-4">加载失败，请重试</div>';
            })
            .finally(() => {
                isLoading = false;
            });
    }

    // 切换选中状态
    function toggleMergeSelection(card, id) {
        const checkbox = card.querySelector('.merge-checkbox');
        id = String(id);
        
        if (selectedMergeIds.has(id)) {
            selectedMergeIds.delete(id);
            checkbox.checked = false;
            card.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
            card.classList.add('border-0', 'bg-white');
        } else {
            selectedMergeIds.add(id);
            checkbox.checked = true;
            card.classList.remove('border-0', 'bg-white');
            card.classList.add('border-primary', 'bg-primary', 'bg-opacity-10');
        }
        
        document.getElementById('mergeSelectedCount').textContent = selectedMergeIds.size;
    }

    // 提交合并
    function submitMerge() {
        if (selectedMergeIds.size < 2) {
            Swal.fire('提示', '请至少选择两个组进行合并', 'warning');
            return;
        }

        Swal.fire({
            title: '确认合并?',
            text: `确认将选中的 ${selectedMergeIds.size} 个版本归为同一类?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '确定',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/api/merge-groups/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        group_ids: Array.from(selectedMergeIds)
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('成功', data.message, 'success').then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire('失败', data.message, 'error');
                    }
                });
            }
        });
    }
</script>
<script>
    const IS_LIKED_FILTER = {% if current_filter == 'liked' %}true{% else %}false{% endif %};

    function copyHomePrompt(event, text) {
        event.preventDefault(); event.stopPropagation();
        copyToClipboard(text, '提示词复制成功！');
    }
    
    function toggleGroupLike(event, pk, currentIsLiked) {
        event.preventDefault(); event.stopPropagation();
        toggleLikeCommon(pk, 'group', currentIsLiked, event.currentTarget, IS_LIKED_FILTER);
    }
    // 1. 检查显示状态：只有当“有内容”且“输入框被聚焦”时才显示
    function toggleSearchClearBtn() {
        const input = document.getElementById('navSearchInput');
        const btn = document.getElementById('navSearchClearBtn');
        if (input && btn) {
            // 如果输入框有值，且当前是聚焦状态，则显示
            if (input.value.length > 0 && document.activeElement === input) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        }
    }

    // 2. 隐藏按钮：当输入框失去焦点（收回）时强制隐藏，不管有没有内容
    function hideSearchClearBtn() {
        const btn = document.getElementById('navSearchClearBtn');
        if (btn) {
            btn.style.display = 'none';
        }
    }

    // 3. 执行清除：因为使用了 onmousedown + preventDefault，输入框不会失去焦点
    function clearNavSearch() {
        const input = document.getElementById('navSearchInput');
        const btn = document.getElementById('navSearchClearBtn');
        if (input) {
            input.value = '';
            input.focus(); // 确保焦点依然在输入框内
            btn.style.display = 'none'; //以此隐藏按钮
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('navSearchInput');
        if (input && input.value.length > 0) {
            toggleSearchClearBtn(input);
        }
        initMasonry('#masonry-grid', '.grid-item');

        // 修改处：初始化 Bootstrap Tooltip
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });
</script>
<style>
    /* 悬浮按钮悬停效果 */
    .btn-float-manage:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.2) !important;
        background-color: #0d6efd !important;
        color: white !important;
    }
    /* 列表项悬停 */
    .merge-item-card:hover {
        background-color: #f8f9fa;
    }
</style>
</body>
</html>