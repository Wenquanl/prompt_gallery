{% extends 'gallery/base.html' %}
{% load static %}

{% block body_class %}detail-page{% endblock %}

{% block content %}
<style>
    /* === 1. 悬浮喜欢按钮 (New) === */
    .fab-like-btn {
        position: fixed;
        bottom: 40px;
        right: 40px;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: white;
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1020; /* 略高于导航，低于 Modal */
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        outline: none;
        padding: 0;
    }
    
    /* 悬停效果 */
    .fab-like-btn:hover {
        transform: scale(1.1) translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.18);
    }
    
    /* 图标样式 */
    .fab-like-btn i {
        font-size: 1.8rem;
        transition: all 0.3s ease;
        line-height: 1;
        margin-top: 2px; /* 视觉微调居中 */
    }
    
    /* 未喜欢状态 */
    .fab-like-btn:not(.liked) {
        color: #6c757d;
    }
    .fab-like-btn:not(.liked):hover i {
        color: #dc3545; /* 悬停暗示红色 */
        transform: scale(1.1);
    }

    /* 已喜欢状态 */
    .fab-like-btn.liked {
        background: #fff0f0; /* 浅粉色背景 */
        color: #dc3545;      /* 红色图标 */
        border-color: rgba(220, 53, 69, 0.1);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.25);
    }
    .fab-like-btn.liked:hover {
        box-shadow: 0 10px 30px rgba(220, 53, 69, 0.35);
    }
    
    /* 点击动画 */
    .fab-like-btn:active {
        transform: scale(0.95);
    }
    
    /* 移动端适配 */
    @media (max-width: 768px) {
        .fab-like-btn {
            width: 50px;
            height: 50px;
            bottom: 20px;
            right: 20px;
        }
        .fab-like-btn i { font-size: 1.4rem; }
    }

    /* === 2. 侧边抽屉导航 (保持之前的优化样式 V4) === */
    .nav-drawer {
        position: fixed;
        top: 50%;
        width: 340px; 
        height: auto;
        min-height: 120px;
        background: white;
        box-shadow: 0 10px 40px rgba(0,0,0,0.25); 
        border-radius: 12px;
        z-index: 1000;
        transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        text-decoration: none !important;
        display: flex;
        flex-direction: column;
        overflow: hidden; 
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    .nav-drawer:hover {
        transform: translate(0, -50%) !important;
        z-index: 1010;
        box-shadow: 0 15px 50px rgba(0,0,0,0.3);
    }

    /* 上一篇 (左侧) */
    .nav-drawer.prev { left: 0; transform: translate(calc(-100% + 60px), -50%); }
    .nav-drawer.prev .drawer-edge-indicator {
        position: absolute; right: 0; top: 0; bottom: 0; width: 60px;
        background: linear-gradient(to right, transparent, rgba(0,0,0,0.02)); 
        display: flex; align-items: center; justify-content: center;
        z-index: 1002; color: rgba(255, 255, 255, 0.9); font-size: 1.8rem; cursor: pointer;
        text-shadow: 0 2px 5px rgba(0,0,0,0.6); 
    }

    /* 下一篇 (右侧) */
    .nav-drawer.next { right: 0; transform: translate(calc(100% - 60px), -50%); }
    .nav-drawer.next .drawer-edge-indicator {
        position: absolute; left: 0; top: 0; bottom: 0; width: 60px;
        background: linear-gradient(to left, transparent, rgba(0,0,0,0.02));
        display: flex; align-items: center; justify-content: center;
        z-index: 1002; color: rgba(255, 255, 255, 0.9); font-size: 1.8rem; cursor: pointer;
        text-shadow: 0 2px 5px rgba(0,0,0,0.6);
    }

    .nav-drawer:hover .drawer-edge-indicator { opacity: 0.3; transition: opacity 0.3s; }
    .nav-drawer:hover .drawer-edge-indicator:hover { opacity: 1; }

    .drawer-img-wrapper {
        width: 100%; height: auto; max-height: 500px; 
        background: #212529; position: relative;
        display: flex; align-items: center; justify-content: center;
        padding: 0; overflow: hidden;
    }
    .drawer-img-wrapper img {
        width: 100%; height: auto; max-height: 500px; 
        object-fit: cover; display: block; 
    }
    .drawer-video-badge {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        z-index: 10; color: rgba(255,255,255,0.9); font-size: 3rem;
        text-shadow: 0 4px 15px rgba(0,0,0,0.5); pointer-events: none;
    }
    .drawer-info {
        padding: 12px 16px; background: #fff;
        border-top: 1px solid rgba(0,0,0,0.05); min-height: 60px; 
    }
    .drawer-title {
        font-size: 1rem; font-weight: 700; color: #212529; margin-bottom: 6px;
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        overflow: hidden; line-height: 1.4;
    }
    .drawer-tags { display: flex; flex-wrap: wrap; gap: 4px; opacity: 0.8; }
    .drawer-tag {
        font-size: 0.7rem; background: #f1f3f5; color: #6c757d;
        padding: 2px 8px; border-radius: 4px; white-space: nowrap;
    }
    @media (max-width: 768px) {
        .nav-drawer { width: 50px; height: 50px; min-height: 0; border-radius: 50%; top: auto; bottom: 120px; transform: none !important; background: rgba(255,255,255,0.95); overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .nav-drawer:hover { transform: scale(1.1) !important; }
        .drawer-img-wrapper, .drawer-info { display: none; }
        .drawer-edge-indicator { width: 100% !important; position: static !important; background: transparent !important; color: #333 !important; text-shadow: none !important; font-size: 1.2rem !important; opacity: 1 !important; }
        .nav-drawer.prev { left: 15px; }
        .nav-drawer.next { right: 15px; }
    }

    /* === 3. 批量管理模式样式 (优化版：悬浮灵动岛) === */
    .batch-bar {
        position: fixed;
        bottom: 40px; /* 距离底部留出悬浮空隙 */
        left: 50%;
        /* 默认隐藏在屏幕下方，居中定位 */
        transform: translateX(-50%) translateY(200%); 
        
        width: auto;
        min-width: 600px; /* 保证最小宽度 */
        max-width: 90vw;  /* 移动端不超宽 */
        height: auto;
        padding: 10px 15px 10px 25px; /* 胶囊内边距 */
        
        /* 核心：玻璃拟态背景 (与导航栏一致) */
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.15), 0 5px 15px -5px rgba(0,0,0,0.05);
        border-radius: 100px; /* 胶囊圆角 */
        
        z-index: 1050;
        /* 弹性弹跳动画 */
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); 
        
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .batch-bar.active {
        /* 激活时弹起归位 */
        transform: translateX(-50%) translateY(0);
    }
    
    /* 选中计数器 */
    .batch-info-text {
        font-weight: 600;
        color: #334155; /* 深灰文字 */
        font-size: 0.95rem;
        display: flex; align-items: center;
    }
    .batch-count-badge {
        background: var(--accent-color); /* 主题蓝 */
        color: white;
        padding: 2px 10px;
        border-radius: 20px;
        margin: 0 6px;
        font-family: 'Poppins', sans-serif;
        font-size: 1.1rem;
        font-weight: 700;
        box-shadow: 0 2px 6px rgba(79, 172, 254, 0.4);
    }

    /* 按钮组样式优化 */
    .btn-batch-action {
        border-radius: 50px;
        font-weight: 600;
        padding: 8px 24px;
        font-size: 0.9rem;
        border: none;
        transition: all 0.2s ease;
        display: inline-flex; align-items: center;
    }
    
    /* 下载按钮：主题渐变色 */
    .btn-batch-download {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
    }
    .btn-batch-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(79, 172, 254, 0.5);
        color: white;
    }

    /* 删除按钮：柔和红 */
    .btn-batch-delete {
        background: #fff0f0;
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.1);
    }
    .btn-batch-delete:hover {
        background: #dc3545;
        color: white;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    /* 退出按钮：极简灰 */
    .btn-batch-exit {
        background: transparent;
        color: #94a3b8;
        padding: 8px 16px;
    }
    .btn-batch-exit:hover {
        color: #334155;
        background: rgba(0,0,0,0.05);
    }
    
    /* 全选文字按钮 */
    .btn-batch-select-all {
        color: #64748b;
        font-weight: 500;
        text-decoration: none;
        font-size: 0.9rem;
        transition: color 0.2s;
        background: none; border: none; padding: 0;
    }
    .btn-batch-select-all:hover { color: var(--accent-color); }

    /* ================= 批量模式卡片样式 (去雾化/清晰版) ================= */
    
    .item-card { position: relative; transition: transform 0.2s; user-select: none; }
    
    /* 遮罩层：默认全透明，不模糊 */
    .batch-select-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: transparent; /* 【关键修改】完全透明 */
        backdrop-filter: none;   /* 【关键修改】去除模糊 */
        opacity: 0;
        pointer-events: none;
        transition: all 0.2s ease;
        z-index: 10;
        border-radius: 12px;
        border: 2px solid transparent;
    }
    
    /* 进入批量模式：显示遮罩层（此时是透明的，仅用于接收点击） */
    body.batch-mode .batch-select-overlay {
        opacity: 1;
        pointer-events: auto;
        cursor: pointer;
    }
    
    /* 悬停效果：鼠标移上去时，显示淡淡的黑底，提示可点击 */
    body.batch-mode .item-card:hover .batch-select-overlay {
        background: rgba(0, 0, 0, 0.05);
        border-color: rgba(0, 0, 0, 0.1);
    }
    
    /* 选中状态：显示明显的蓝色高亮边框和浅蓝背景 */
    .item-card.selected .batch-select-overlay {
        background: rgba(13, 110, 253, 0.2) !important; /* 加深一点蓝色，更明显 */
        border-color: var(--accent-color);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.3); /* 内发光增加质感 */
    }
    
    /* 复选框：右上角的小圆圈 (基础样式) */
    .custom-checkbox {
        position: absolute; top: 12px; right: 12px;
        width: 24px; height: 24px;
        
        /* 默认：半透明白底+深色边框 */
        background: rgba(255, 255, 255, 0.85); 
        border: 1.5px solid #94a3b8; 
        
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        transform: scale(0.9);
    }
    
    /* 【修复重点 1】悬停 未选中 的卡片：复选框变白，提示“点击选中” */
    body.batch-mode .item-card:not(.selected):hover .custom-checkbox {
        transform: scale(1.1);
        border-color: var(--accent-color);
        background: white; /* 只有没被选中时，hover才变白 */
    }
    
    /* 【修复重点 2】悬停 已选中 的卡片：保持蓝色，提示“点击取消” */
    body.batch-mode .item-card.selected:hover .custom-checkbox {
        transform: scale(1.1);
        background: var(--accent-color); /* 强制保持蓝色 */
        border-color: var(--accent-color);
        filter: brightness(1.1); /* 微微变亮，增加交互感 */
    }
    
    /* 选中状态的复选框 (静止状态) */
    .item-card.selected .custom-checkbox {
        background: var(--accent-color);
        border-color: var(--accent-color);
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(79, 172, 254, 0.4);
    }
    
    .custom-checkbox i { display: none; font-size: 14px; color: white; font-weight: bold; }
    .item-card.selected .custom-checkbox i { display: block; }

    /* === 4. 框选区域样式 (New) === */
    .selection-area-box {
        position: fixed;
        background: rgba(13, 110, 253, 0.2);
        border: 1px solid #0d6efd;
        z-index: 9999;
        pointer-events: none; /* 不阻挡事件 */
        display: none;
    }
    /* ================= 美化版模态框 (Nice Modals) ================= */
    .custom-modal-content {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid white;
        border-radius: 28px; /* 大圆角 */
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        padding: 30px 20px;
        text-align: center;
        overflow: hidden;
    }
    
    /* 顶部大图标 */
    .modal-icon-wrapper {
        width: 80px; height: 80px;
        border-radius: 50%;
        margin: 0 auto 20px auto;
        display: flex; align-items: center; justify-content: center;
        font-size: 2.5rem;
        position: relative;
    }
    /* 动效：图标微动 */
    .modal.show .modal-icon-wrapper {
        animation: bounceIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @keyframes bounceIn {
        0% { transform: scale(0.5); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    /* 危险配色 (删除) */
    .icon-danger { background: #fee2e2; color: #dc2626; }
    .icon-danger::after {
        content: ''; position: absolute; inset: 0; border-radius: 50%;
        border: 4px solid #fecaca; opacity: 0.5; animation: pulseRed 2s infinite;
    }
    
    /* 提示配色 (下载) */
    .icon-info { background: #e0f2fe; color: #0284c7; }
    .icon-info::after {
        content: ''; position: absolute; inset: 0; border-radius: 50%;
        border: 4px solid #bae6fd; opacity: 0.5; animation: pulseBlue 2s infinite;
    }

    @keyframes pulseRed { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }
    @keyframes pulseBlue { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }

    .modal-title-custom {
        font-weight: 800; font-size: 1.5rem; color: #1e293b;
        margin-bottom: 12px; letter-spacing: -0.5px;
    }
    
    .modal-text-custom {
        color: #64748b; font-size: 1rem; line-height: 1.6;
        margin-bottom: 32px; max-width: 80%; margin-left: auto; margin-right: auto;
    }
    
    /* 按钮组 */
    .modal-actions { display: flex; gap: 12px; justify-content: center; }
    
    .btn-modal-cancel {
        border: 1px solid #e2e8f0; background: white; color: #64748b;
        padding: 10px 24px; border-radius: 50px; font-weight: 600;
        transition: all 0.2s;
    }
    .btn-modal-cancel:hover { background: #f8fafc; color: #334155; border-color: #cbd5e1; }
    
    .btn-modal-confirm {
        padding: 10px 32px; border-radius: 50px; font-weight: 600;
        color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.2s;
    }
    .btn-modal-confirm:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    
    .btn-confirm-delete { background: #ef4444; }
    .btn-confirm-delete:hover { background: #dc2626; box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3); }
    
    .btn-confirm-download { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .btn-confirm-download:hover { box-shadow: 0 8px 16px rgba(79, 172, 254, 0.4); }
    /* === 右键菜单样式 === */
    .context-menu {
        display: none;
        position: fixed;
        z-index: 2000;
        background: white;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        border: 1px solid rgba(0,0,0,0.05);
        padding: 5px 0;
        min-width: 140px;
        overflow: hidden;
    }
    .context-menu-item {
        padding: 8px 15px;
        font-size: 0.9rem;
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background 0.2s;
    }
    .context-menu-item:hover {
        background: #f8f9fa;
        color: var(--accent-color);
    }
    .context-menu-item i {
        margin-right: 8px;
        font-size: 1rem;
    }
    /* 浮动的主版本按钮样式 */
    .btn-main-float {
        position: absolute;
        top: 5px;
        right: 35px; /* 放在解除关联按钮的左边 */
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: flex; align-items: center; justify-content: center;
        color: #cbd5e1; /* 默认灰色 */
        font-size: 0.75rem;
        cursor: pointer;
        opacity: 0; /* 默认隐藏 */
        transition: all 0.2s;
        z-index: 5;
    }
    .sibling-group:hover .btn-main-float { opacity: 1; }
    .btn-main-float:hover {
        background: #ffc107;
        color: white;
        transform: scale(1.1);
    }
/* === 猜你喜欢：极简纯图 + 前3标签布局 === */
    .recommend-section {
        margin-top: 4rem;
        padding-top: 2rem;
        border-top: 1px solid #f1f3f5;
    }

    .recommend-scroll-wrapper {
        display: flex;
        flex-wrap: nowrap;
        gap: 12px;
        overflow-x: auto;
        padding: 5px 2px 20px 2px;
        -webkit-overflow-scrolling: touch;
    }

    /* 极简滚动条 */
    .recommend-scroll-wrapper::-webkit-scrollbar {
        height: 4px;
    }
    .recommend-scroll-wrapper::-webkit-scrollbar-track {
        background: transparent;
    }
    .recommend-scroll-wrapper::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
    }

    .rec-item-container {
        flex: 0 0 auto;
        display: flex;
    }

    /* 参考首页 .gallery-card 样式，去除多余内边距 */
    .rec-card-ultra {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        width: 220px; /* 紧凑宽度 */
    }

    .rec-card-ultra:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.12);
    }

    /* 图片容器：占比极大，强制 cover 去除留白 */
    .rec-img-full {
        width: 100%;
        height: 320px; /* 极高占比 */
        background: #f8fafc;
        position: relative;
        overflow: hidden;
    }

    .rec-img-full img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* 核心：铺满容器，绝不留白 */
        display: block;
        transition: transform 0.6s ease;
    }
    
    .rec-card-ultra:hover .rec-img-full img {
        transform: scale(1.08); /* 首页同款动感 */
    }

    /* 底部仅展示标签：精简至极 */
    .rec-footer-tags-only {
        padding: 10px 12px;
        background: #fff;
        border-top: 1px solid #f8f9fa;
    }

    /* 首页同款药丸标签样式 */
    .rec-tag-pill-home {
        display: inline-block;
        padding: 2px 8px;
        background: #f1f5f9;
        color: #475569;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 500;
        margin-right: 4px;
        border: 1px solid #e2e8f0;
        text-decoration: none !important;
        transition: all 0.2s;
    }
    .rec-tag-pill-home:hover {
        background: #e2e8f0;
        color: #1e293b;
    }

    /* === 图片/视频栏独立竖向滚动样式 === */
    .media-scroll-area {
        max-height: 65vh; /* 核心：限制最大高度为屏幕可视高度的 65% (可自行调整) */
        overflow-y: auto; /* 核心：超出高度时自动出现垂直滚动条 */
        overflow-x: hidden;
        padding-right: 8px; /* 给滚动条留出呼吸空间，防止内容贴紧边缘 */
        padding-bottom: 10px;
        margin-bottom: 1rem;
    }

    /* 美化独立滚动条，保持页面清爽 */
    .media-scroll-area::-webkit-scrollbar {
        width: 6px;
    }
    .media-scroll-area::-webkit-scrollbar-track {
        background: transparent;
    }
    .media-scroll-area::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 10px;
    }
    .media-scroll-area::-webkit-scrollbar-thumb:hover {
        background: #adb5bd; /* 鼠标悬停时稍微加深 */
    }
    /* === 详情页人物标签专属样式 === */
    .tag-interactive.tag-char {
        background-color: #fff0f6; 
        color: #d81b60; 
        border-color: #ffdeeb;
        font-weight: 600;
    }
    .tag-interactive.tag-char:hover {
        background-color: #ffe3ee; 
        color: #c2185b;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(216, 27, 96, 0.15);
    }
    .tag-interactive.tag-char a { color: inherit; }
</style>

<button class="fab-like-btn {% if group.is_liked %}liked{% endif %}" 
        onclick="toggleGroupLike(this, {{ group.pk }})"
        title="{% if group.is_liked %}取消喜欢{% else %}喜欢此作品{% endif %}"
        data-bs-toggle="tooltip" 
        data-bs-placement="left">
    <i class="bi {% if group.is_liked %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
</button>

{% if prev_group %}
<a href="{% url 'detail' prev_group.id %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}" class="nav-drawer prev">
    <div class="drawer-edge-indicator"><i class="bi bi-chevron-left"></i></div>
    <div class="drawer-img-wrapper">
        {% with cover=prev_group.cover_image|default:prev_group.images.first %}
            {% if cover %}
                {% if cover.is_video %}
                    <i class="bi bi-play-circle-fill drawer-video-badge"></i>
                    {% if cover.thumbnail %}
                         <img src="{{ cover.thumbnail.url }}" alt="Cover">
                    {% else %}
                         <div style="width:100%; height:200px; background:#111;"></div>
                    {% endif %}
                {% else %}
                    <img src="{{ cover.image.url }}" alt="Cover">
                {% endif %}
            {% else %}
                <div class="d-flex align-items-center justify-content-center" style="width:100%; height:150px; background:#f8f9fa; color:#adb5bd;">
                    <i class="bi bi-image fs-1 opacity-50"></i>
                </div>
            {% endif %}
        {% endwith %}
    </div>
    <div class="drawer-info">
        <div class="drawer-title">{{ prev_group.title }}</div>
        <div class="drawer-tags">
            {% for tag in prev_group.tags.all|slice:":3" %}
                <span class="drawer-tag">#{{ tag.name }}</span>
            {% endfor %}
        </div>
    </div>
</a>
{% endif %}

{% if next_group %}
<a href="{% url 'detail' next_group.id %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}" class="nav-drawer next">
    <div class="drawer-edge-indicator"><i class="bi bi-chevron-right"></i></div>
    <div class="drawer-img-wrapper">
        {% with cover=next_group.cover_image|default:next_group.images.first %}
            {% if cover %}
                {% if cover.is_video %}
                    <i class="bi bi-play-circle-fill drawer-video-badge"></i>
                    {% if cover.thumbnail %}
                         <img src="{{ cover.thumbnail.url }}" alt="Cover">
                    {% else %}
                        <div style="width:100%; height:200px; background:#111;"></div>
                    {% endif %}
                {% else %}
                    <img src="{{ cover.image.url }}" alt="Cover">
                {% endif %}
            {% else %}
                <div class="d-flex align-items-center justify-content-center" style="width:100%; height:150px; background:#f8f9fa; color:#adb5bd;">
                    <i class="bi bi-image fs-1 opacity-50"></i>
                </div>
            {% endif %}
        {% endwith %}
    </div>
    <div class="drawer-info">
        <div class="drawer-title">{{ next_group.title }}</div>
        <div class="drawer-tags">
            {% for tag in next_group.tags.all|slice:":3" %}
                <span class="drawer-tag">#{{ tag.name }}</span>
            {% endfor %}
        </div>
    </div>
</a>
{% endif %}


<div class="container mt-0 mb-4">
    <div class="mb-4">
        {% with from_view=request.GET.from|default:'home' page_num=request.GET.page|default:'1' q_val=request.GET.q|default:'' filter_val=request.GET.filter|default:'' source_id=request.GET.source_img_id back_to_id=request.GET.back_to_detail_id search_id=request.GET.search_id %}
            {% if back_to_id %}
                <a href="{% url 'detail' back_to_id %}?from={{ from_view }}&page={{ page_num }}{% if q_val %}&q={{ q_val|urlencode }}{% endif %}{% if filter_val %}&filter={{ filter_val }}{% endif %}{% if source_id %}&source_img_id={{ source_id }}{% endif %}" class="btn-float-back" title="返回"><i class="bi bi-arrow-left"></i><span>返回</span></a>
            
            {% elif search_id %}
                {% if from_view == 'home_search' or from_view == 'home' %}
                    <a href="{% url 'home' %}?search_id={{ search_id }}" class="btn-float-back" title="返回搜索结果"><i class="bi bi-arrow-left"></i><span>返回搜索结果</span></a>
                {% else %}
                    <a href="{% url 'liked_images_gallery' %}?search_id={{ search_id }}" class="btn-float-back" title="返回搜索结果"><i class="bi bi-arrow-left"></i><span>返回搜索结果</span></a>
                {% endif %}
            
            {% elif from_view == 'liked' %}
                <a href="{% url 'liked_images_gallery' %}?page={{ page_num }}{% if q_val %}&q={{ q_val|urlencode }}{% endif %}{% if source_id %}#card-img-{{ source_id }}{% endif %}" class="btn-float-back" title="返回"><i class="bi bi-arrow-left"></i><span>返回</span></a>
            
            {% else %}
                <a href="{% url 'home' %}?page={{ page_num }}{% if q_val %}&q={{ q_val|urlencode }}{% endif %}{% if filter_val %}&filter={{ filter_val }}{% endif %}#group-card-{{ group.pk }}" class="btn-float-back" title="返回"><i class="bi bi-arrow-left"></i><span>返回</span></a>
            {% endif %}
        {% endwith %}
    </div>

    <div class="row gx-lg-5 detail-split-view">
        <div class="col-lg-8 mb-5 mb-lg-0 detail-scroll-left">
            
            <div class="d-flex justify-content-between align-items-start mb-3">

                <div class="d-flex align-items-center flex-grow-1">
                    <button class="btn btn-sm me-2 rounded-circle p-0 d-flex align-items-center justify-content-center" 
                            style="width: 32px; height: 32px; transition: all 0.2s; {% if group.is_main_variant %}background:#ffc107; color:#fff;{% else %}background:#f1f3f5; color:#adb5bd;{% endif %}"
                            onclick="setMainVariant({{ group.pk }})"
                            title="{% if group.is_main_variant %}当前是首页展示的主版本{% else %}点击设为首页展示的主版本{% endif %}"
                            data-bs-toggle="tooltip">
                        <i class="bi bi-star-fill" style="font-size: 1rem;"></i>
                    </button>

                    <button class="btn btn-sm rounded-pill px-3 me-2 text-white shadow-sm d-flex align-items-center" 
                            onclick="openAiStudioModal()"
                            title="一键带入参数至 AI 工作室"
                            data-bs-toggle="tooltip"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        <i class="bi bi-magic me-1"></i>工作室
                    </button>

                    <h2 class="fw-bold text-dark mb-0 p-2 rounded" 
                        ondblclick="enableTitleEdit(this, {{ group.pk }})" 
                        title="双击修改标题" 
                        style="cursor: text; margin-left: -0.5rem; transition: background-color 0.2s;">
                        {{ group.title }}
                    </h2>
                </div>
                
                <button id="btn-enter-batch" class="btn btn-outline-secondary btn-sm ms-2 rounded-pill px-3" style="margin-top: 8px;">
                    <i class="bi bi-check2-square me-1"></i>批量管理
                </button>
            </div>
            
            <div class="upload-trigger-area mb-4" id="inline-trigger-gen" role="button">
                <div class="trigger-content">
                    <div class="icon-wrapper mb-2">
                        <i class="bi bi-cloud-arrow-up-fill"></i>
                    </div>
                    <div class="fw-bold text-dark">点击或拖拽上传图片/视频</div>
                    <div class="small text-muted mt-1">支持批量上传 / 自动去重</div>
                </div>
            </div>

            <div class="mb-4 d-flex flex-wrap align-items-center gap-2" id="tagsContainer" style="min-height: 40px;">
                
                <span id="characters-wrapper" class="d-flex flex-wrap gap-2">
                    {% for char in group.characters.all %}
                        <span class="tag-interactive tag-char" id="char-pill-{{ char.id }}">
                            <i class="bi bi-person-fill me-1"></i>
                            <a href="/?q={{ char.name }}">{{ char.name }}</a>
                            <span class="tag-remove-btn" onclick="removeTag({{ group.pk }}, {{ char.id }}, 'character')" title="移除人物">
                                <i class="bi bi-x-circle-fill"></i>
                            </span>
                        </span>
                    {% endfor %}
                </span>

                <span id="normal-tags-wrapper" class="d-flex flex-wrap gap-2">
                    {% for tag in sorted_tags %}
                        <span class="tag-interactive {% if tag.name == group.model_info %}model-tag{% endif %}" id="tag-pill-{{ tag.id }}">
                            {% if tag.name == group.model_info %}<i class="bi bi-robot me-1"></i>{% endif %}
                            <a href="/?q={{ tag.name }}">{{ tag.name }}</a>
                            <span class="tag-remove-btn" onclick="removeTag({{ group.pk }}, {{ tag.id }}, 'tag')" title="移除标签">
                                <i class="bi bi-x-circle-fill"></i>
                            </span>
                        </span>
                    {% endfor %}
                </span>

                <div class="d-flex align-items-center">
                    <button class="btn-add-tag-dashed" id="btnAddTag" onclick="showTagInput()" title="添加标签"><i class="bi bi-plus-lg"></i></button>
                    <div class="tag-input-container" id="tagInputContainer">
                        <input type="text" class="tag-input-line" id="newTagInput" placeholder="输入标签..." list="availableTags" onkeydown="handleTagKey(event, {{ group.pk }})">
                        <button class="btn-confirm-tag" type="button" onclick="addTag({{ group.pk }})" title="确认添加"><i class="bi bi-check-lg"></i></button>
                        <datalist id="availableTags">{% for t in all_tags %}<option value="{{ t.name }}"></option>{% endfor %}</datalist>
                    </div>
                </div>
            </div>

            <div class="section-divider mb-3 pb-2 border-bottom d-flex align-items-center">
                <h5 class="fw-bold text-secondary mb-0"><i class="bi bi-images me-2"></i>图片</h5>
                <span class="ms-2 badge bg-light text-secondary border" id="image-count-badge">{{ images_list|length }}</span>
            </div>
            <div class="media-scroll-area">
                <div id="detail-masonry-grid-images" class="row mb-5">
                    {% for img in images_list %}
                        {% include 'gallery/components/detail_image_card.html' with img=img index=forloop.counter0 %}
                    {% empty %}
                    <div class="col-12"><div class="alert alert-light border text-center py-4 text-muted rounded-3" style="background: rgba(255,255,255,0.5)"><i class="bi bi-image fs-1 d-block mb-3 opacity-50"></i>暂无图片</div></div>
                    {% endfor %}
                </div>
            </div>
            <div class="section-divider mb-3 pb-2 border-bottom d-flex align-items-center">
                <h5 class="fw-bold text-secondary mb-0"><i class="bi bi-camera-reels me-2"></i>视频</h5>
                <span class="ms-2 badge bg-light text-secondary border" id="video-count-badge">{{ videos_list|length }}</span>
            </div>
            <div class="media-scroll-area">
                <div id="detail-masonry-grid-videos" class="row">
                    {% for img in videos_list %}
                        {% include 'gallery/components/detail_image_card.html' with img=img %}
                    {% empty %}
                    <div class="col-12"><div class="alert alert-light border text-center py-4 text-muted rounded-3" style="background: rgba(255,255,255,0.5)"><i class="bi bi-film fs-1 d-block mb-3 opacity-50"></i>暂无视频</div></div>
                    {% endfor %}
                </div>
            </div>
            {% if related_groups %}
            <div class="recommend-section">
                <h5 class="fw-bold mb-4 text-dark d-flex align-items-center">
                    <i class="bi bi-grid-fill text-primary me-2"></i>猜你喜欢
                </h5>
                
                <div class="recommend-scroll-wrapper custom-scrollbar">
                    {% for related in related_groups %}
                    <div class="rec-item-container">
                        <div class="rec-card-ultra">
                            <a href="{% url 'detail' related.pk %}?back_to_detail_id={{ group.pk }}" class="text-decoration-none d-block">
                                <div class="rec-img-full">
                                    {% with cover=related.cover_image|default:related.images.first %}
                                        {% if cover %}
                                            {% if cover.is_video and not cover.thumbnail %}
                                                <div class="d-flex align-items-center justify-content-center h-100 w-100 bg-dark text-white">
                                                    <i class="bi bi-play-circle fs-1"></i>
                                                </div>
                                            {% else %}
                                                <img src="{{ cover.thumbnail.url|default:cover.image.url }}" 
                                                    alt="{{ related.title }}"
                                                    onerror="this.src='/static/gallery/img/gemini.png'">
                                            {% endif %}
                                        {% else %}
                                            <div class="d-flex align-items-center justify-content-center h-100 w-100 text-secondary opacity-20">
                                                <i class="bi bi-image fs-1"></i>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                
                                <div class="rec-footer-tags-only">
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for tag in related.tags.all|slice:":3" %}
                                        <object><a href="/?q={{ tag.name }}" class="rec-tag-pill-home">#{{ tag.name }}</a></object>
                                        {% endfor %}
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4 ps-lg-4 detail-scroll-right">
            <div class="sticky-sidebar">
                
                <div class="prompt-card p-4 mb-4">
                    <div class="section-header">
                        <span class="section-label text-primary">参数</span>
                        <div class="d-flex align-items-center gap-2">
                            <a href="{% url 'upload' %}?template_id={{ group.pk }}" class="btn btn-sm btn-outline-primary rounded-pill px-3" title="使用当前提示词和参考图，更换模型重新生成">
                                <i class="bi bi-git me-1"></i>新模型版本
                            </a>
                            <button onclick="enableEdit('modelInfo', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('modelInfo', {{ group.pk }}, 'model')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('modelInfo')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('modelInfo', this)" class="btn btn-sm btn-outline-primary rounded-pill px-3" {% if not group.model_info %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box mb-3" id="modelInfo">{% if group.model_info %}{{ group.model_info }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                    <div class="border-top pt-3">
                        <ul class="list-unstyled mb-0 text-secondary small">
                            <li class="d-flex align-items-center">
                                <i class="bi bi-calendar3 me-2 text-primary"></i>
                                <div><strong class="text-dark me-1">创建时间:</strong>{{ group.created_at|date:"Y-m-d H:i" }}</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header mb-3 d-flex justify-content-between align-items-center">
                        <span class="section-label text-info">参考图</span>
                    </div>

                    <div class="row row-cols-3 g-2" id="reference-grid">
                        <div class="col">
                            <div class="ratio ratio-1x1 upload-trigger-card" id="inline-trigger-ref" role="button">
                                <div class="d-flex flex-column align-items-center justify-content-center h-100 content-wrapper">
                                    <i class="bi bi-plus-lg fs-3 mb-1"></i>
                                    <span class="small">添加参考</span>
                                </div>
                            </div>
                        </div>
                        {% for ref in group.references.all %}
                            {% include 'gallery/components/detail_reference_item.html' with ref=ref %}
                        {% endfor %}
                    </div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-primary">Prompt (正向)</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('promptText', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('promptText', {{ group.pk }}, 'positive')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('promptText')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('promptText', this)" class="btn btn-sm btn-outline-primary rounded-pill px-3" {% if not group.prompt_text %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box" id="promptText">{% if group.prompt_text %}{{ group.prompt_text }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-success">辅助提示词1</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('promptTextZh', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('promptTextZh', {{ group.pk }}, 'positive_zh')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('promptTextZh')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('promptTextZh', this)" class="btn btn-sm btn-outline-success rounded-pill px-3" {% if not group.prompt_text_zh %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box" id="promptTextZh">{% if group.prompt_text_zh %}{{ group.prompt_text_zh }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-danger">辅助提示词2</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('negPrompt', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('negPrompt', {{ group.pk }}, 'negative')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('negPrompt')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('negPrompt', this)" class="btn btn-sm btn-outline-danger rounded-pill px-3" {% if not group.negative_prompt %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box" id="negPrompt">{% if group.negative_prompt %}{{ group.negative_prompt }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="card shadow-sm border-0 mb-4" style="background: rgba(230, 240, 255, 0.5);">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title text-primary fw-bold mb-0" style="font-size: 0.9rem;">
                                <i class="bi bi-layers-fill me-2"></i>其他版本 ({{ siblings|length }})
                            </h6>
                            <button class="btn btn-sm rounded-pill px-3 shadow-sm btn-link-interactive" style="font-size: 0.75rem;" onclick="openLinkModal()" title="关联现有图片到此系列">
                                <i class="bi bi-link-45deg me-1"></i>关联
                            </button>
                        </div>
                        
                        <div class="d-flex flex-column gap-2">
                            {% for sib in siblings %}
                            <div class="position-relative sibling-group">
                                <a href="{% url 'detail' sib.pk %}" class="d-flex align-items-center p-2 bg-white rounded-3 border text-decoration-none shadow-sm sibling-card">
                                    <div class="sibling-thumb-wrapper">
                                        {% if sib.images.first %}
                                            {% if sib.images.first.is_video %}
                                            <div class="sibling-empty-thumb bg-dark text-white"><i class="bi bi-play-fill"></i></div>
                                            {% else %}
                                            <img src="{{ sib.images.first.thumbnail.url }}" class="sibling-thumb">
                                            {% endif %}
                                        {% else %}
                                        <div class="sibling-empty-thumb"><i class="bi bi-image"></i></div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="ms-2 flex-grow-1 overflow-hidden">
                                        {% if sib.model_info %}
                                            {% if sib.model_info != group.model_info %}
                                                <div class="mb-1">
                                                    <span class="badge rounded-pill border" 
                                                        title="模型变更: 当前是 {{ group.model_info }}"
                                                        style="background-color: #fff3cd; color: #856404; border-color: #ffeeba !important; font-weight: normal; font-size: 0.7rem;">
                                                        <i class="bi bi-exclamation-triangle-fill me-1"></i>{{ sib.model_info }}
                                                    </span>
                                                </div>
                                            {% else %}
                                                <div class="mb-1">
                                                    <span class="badge bg-light text-secondary border rounded-pill" 
                                                        style="font-weight: normal; font-size: 0.7rem;">
                                                        <i class="bi bi-robot me-1"></i>{{ sib.model_info }}
                                                    </span>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                        <div class="sibling-diff-wrapper custom-scrollbar">
                                            {{ sib.diff_html|safe }}
                                        </div>
                                    </div>
                                </a>
                                <button class="btn-main-float" 
                                        title="设为首页主版本" 
                                        onclick="setMainVariantSibling(event, {{ sib.pk }})"
                                        {% if sib.is_main_variant %}style="color: #ffc107; opacity: 1;"{% endif %}>
                                    <i class="bi bi-star-fill"></i>
                                </button>
                                <button class="btn-unlink-float" title="解除关联 (变为独立作品)" onclick="unlinkSibling(event, {{ sib.pk }})">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="text-center text-muted small py-3 fst-italic bg-white bg-opacity-50 rounded border border-dashed">
                                暂无其他版本
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="linkVersionModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-4">
                            <div class="modal-header border-0 pb-0">
                                <h5 class="modal-title fw-bold">关联新版本</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted small mb-3">搜索并选择一个现有的作品，将其作为当前作品的“另一版本”关联起来。</p>
                                <div class="position-relative mb-3">
                                    <input type="text" id="linkSearchInput" class="form-control rounded-pill ps-4" placeholder="搜索标题或提示词..." oninput="debounceSearchLink()">
                                    <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3 text-muted"></i>
                                </div>
                                <div id="linkSearchResults" class="custom-scrollbar" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center text-muted py-3 small">请输入关键词搜索</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                    <div class="text-muted small">
                                        已选: <span id="linkSelectedCount" class="fw-bold text-primary">0</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="clearLinkSelection()">清除</button>
                                        <button type="button" class="btn btn-sm btn-primary rounded-pill px-3" onclick="submitLinkSelection()">确认关联</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="prompt-card p-4 border-danger border-opacity-25 mb-4" style="background: rgba(255, 230, 230, 0.4);">
                    <div class="section-header mb-2"><span class="section-label text-danger">管理操作</span></div>
                    <form action="{% url 'delete_group' group.pk %}" method="post" class="delete-form-confirm">
                        {% csrf_token %}
                        <button type="button" class="btn btn-danger w-100 rounded-pill btn-sm" onclick="confirmDelete(event)">
                            <i class="bi bi-trash3 me-2"></i>永久删除整个作品
                        </button>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="batch-action-bar" class="batch-bar">
    <div class="d-flex align-items-center gap-3">
        <div class="batch-info-text">
            已选 <span id="selected-count" class="batch-count-badge">0</span> 张
        </div>
        <div style="width: 1px; height: 20px; background: #e2e8f0;"></div>
        <button id="btn-select-all" class="btn-batch-select-all">
            <i class="bi bi-check-all me-1"></i>全选
        </button>
    </div>

    <div class="d-flex align-items-center gap-2">
        <button id="btn-batch-download" class="btn-batch-action btn-batch-download">
            <i class="bi bi-cloud-download-fill me-2"></i>下载
        </button>
        <button id="btn-batch-delete-trigger" class="btn-batch-action btn-batch-delete">
            <i class="bi bi-trash3-fill me-2"></i>删除
        </button>
        <button id="btn-exit-batch" class="btn-batch-action btn-batch-exit ms-1">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
</div>

<div class="modal fade" id="batchDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal-content border-0">
            <div class="modal-icon-wrapper icon-danger">
                <i class="bi bi-trash3"></i>
            </div>
            <h3 class="modal-title-custom">确认删除?</h3>
            <p class="modal-text-custom">
                即将永久删除 <span id="modal-delete-count" class="text-danger fw-bold fs-5">0</span> 个文件。<br>
                <span class="fs-6 opacity-75">此操作无法撤销，文件将从服务器物理删除。</span>
            </p>
            <div class="modal-actions">
                <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">再想想</button>
                <button type="button" id="btn-confirm-batch-delete" class="btn btn-modal-confirm btn-confirm-delete">确认删除</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="batchDownloadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal-content border-0">
            <div class="modal-icon-wrapper icon-info">
                <i class="bi bi-cloud-download"></i>
            </div>
            <h3 class="modal-title-custom">准备下载</h3>
            <p class="modal-text-custom">
                即将开始下载 <span id="modal-download-count" class="text-primary fw-bold fs-5">0</span> 个文件。<br>
                <span class="fs-6 opacity-75 d-block mt-2 text-warning-emphasis bg-warning-subtle px-2 py-1 rounded" style="font-size: 0.85rem;">
                    <i class="bi bi-exclamation-circle me-1"></i>注意：若浏览器拦截多个文件的下载，请留意地址栏右侧的拦截图标并“允许”。
                </span>
            </p>
            <div class="modal-actions">
                <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">取消</button>
                <button type="button" id="btn-confirm-batch-download" class="btn btn-modal-confirm btn-confirm-download">开始下载</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addImagesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4" style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-dark">添加生成图</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <form id="addImagesForm" action="{% url 'add_images' group.pk %}" method="post" enctype="multipart/form-data" onsubmit="handleImageUpload(event)">
                    {% csrf_token %}
                    <div id="zone-modal-gen" class="upload-zone-modal">
                        <i class="bi bi-cloud-arrow-up"></i><p>点击或将图片/视频拖拽至此</p>
                        <input type="file" name="new_images" id="input-modal-gen" multiple accept="image/*,video/*">
                    </div>
                    <div id="preview-modal-gen" class="preview-container-modal"></div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary rounded-pill fw-bold" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none;">
                            <i class="bi bi-cloud-upload me-2"></i>确认上传
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% include 'gallery/components/modal_add_reference.html' %} 

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 100vw; margin: 0;">
        <div class="modal-content border-0" style="background: transparent;">
            <div class="modal-body p-0 position-relative d-flex justify-content-center align-items-center" style="height: 100vh;">
                <a href="#" id="modalDownloadBtn" download class="modal-download-btn"><i class="bi bi-download"></i> 下载原图</a>
                <button type="button" id="modalLikeBtn" class="modal-like-btn" onclick="toggleModalLike()"><i class="bi bi-heart"></i> 喜欢</button>
                <form id="modalDeleteForm" method="post" class="delete-form-confirm">{% csrf_token %}<button type="button" class="modal-delete-btn" onclick="confirmDelete(event)"><i class="bi bi-trash3"></i> 删除此图</button></form>
                <button type="button" class="close-modal-btn" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i></button>
                
                <div class="nav-btn nav-prev" onclick="changeImage(-1)"><i class="bi bi-chevron-left"></i></div>
                
                <img src="" id="previewImage" alt="Preview" style="max-height: 90vh; max-width: 90vw; object-fit: contain;">
                <video src="" id="previewVideo" controls style="max-height: 90vh; max-width: 90vw; display:none;" class="shadow-lg rounded"></video>
                
                <div class="nav-btn nav-next" onclick="changeImage(1)"><i class="bi bi-chevron-right"></i></div>
                <div id="imageCounter" class="image-counter"></div>
            </div>
        </div>
    </div>
</div>

<div id="imgContextMenu" class="context-menu">
    <div class="context-menu-item" onclick="setAsCoverFromMenu()">
        <i class="bi bi-image"></i> 设为封面
    </div>
</div>

<div class="modal fade" id="aiStudioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-magic text-primary me-2"></i>导入 AI 工作室</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">将自动带入当前作品的<strong>参考图</strong>和<strong>标签</strong>。如果有多个提示词，请选择您想要带入的一项作为基础：</p>
                
                <form id="aiStudioForm" action="{% url 'create' %}" method="get" target="_blank" onsubmit="setTimeout(() => bootstrap.Modal.getInstance(document.getElementById('aiStudioModal')).hide(), 100)">
                    <input type="hidden" name="template_id" value="{{ group.pk }}">
                    
                    <div class="list-group mb-4">
                        {% if group.prompt_text or group.prompt_text_zh or group.negative_prompt %}
                            {% if group.prompt_text %}
                            <label class="list-group-item d-flex gap-3 align-items-center cursor-pointer">
                                <input class="form-check-input flex-shrink-0" type="radio" name="prompt_type" value="positive" checked>
                                <div class="flex-grow-1 overflow-hidden">
                                    <strong class="text-primary d-block mb-1">Prompt (正向)</strong>
                                    <small class="d-block text-muted text-truncate">{{ group.prompt_text }}</small>
                                </div>
                            </label>
                            {% endif %}
                            
                            {% if group.prompt_text_zh %}
                            <label class="list-group-item d-flex gap-3 align-items-center cursor-pointer">
                                <input class="form-check-input flex-shrink-0" type="radio" name="prompt_type" value="positive_zh" {% if not group.prompt_text %}checked{% endif %}>
                                <div class="flex-grow-1 overflow-hidden">
                                    <strong class="text-success d-block mb-1">辅助提示词 1</strong>
                                    <small class="d-block text-muted text-truncate">{{ group.prompt_text_zh }}</small>
                                </div>
                            </label>
                            {% endif %}
                            
                            {% if group.negative_prompt %}
                            <label class="list-group-item d-flex gap-3 align-items-center cursor-pointer">
                                <input class="form-check-input flex-shrink-0" type="radio" name="prompt_type" value="negative" {% if not group.prompt_text and not group.prompt_text_zh %}checked{% endif %}>
                                <div class="flex-grow-1 overflow-hidden">
                                    <strong class="text-danger d-block mb-1">辅助提示词 2</strong>
                                    <small class="d-block text-muted text-truncate">{{ group.negative_prompt }}</small>
                                </div>
                            </label>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-light border text-center text-muted mb-0">
                                该作品暂无提示词文本，将仅带入参考图和标签。
                                <input type="hidden" name="prompt_type" value="none">
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary rounded-pill fw-bold py-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            <i class="bi bi-rocket-takeoff me-2"></i>前往创作
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% include 'gallery/components/offcanvas_tags.html' %}
{% endblock %}

{% block extra_js %}
    <script type="application/json" id="gallery-data">
    [
        {% for img in group.images.all %}
    { 
        "url": "{{ img.image.url }}", 
        "id": {{ img.pk }}, 
        "isLiked": {% if img.is_liked %}true{% else %}false{% endif %}, 
        "isVideo": {% if img.is_video %}true{% else %}false{% endif %}  }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ]
    </script>
    <script src="{% static 'gallery/js/detail.js' %}"></script>
    <script>
            // 【新增】打开 AI 工作室提示词选择弹窗
            function openAiStudioModal() {
                const modalEl = document.getElementById('aiStudioModal');
                if (modalEl) {
                    new bootstrap.Modal(modalEl).show();
                }
            }
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })

            // === 批量管理逻辑 Start ===
            const body = document.body;
            const btnEnter = document.getElementById('btn-enter-batch');
            const btnExit = document.getElementById('btn-exit-batch');
            const batchBar = document.getElementById('batch-action-bar');
            const countSpan = document.getElementById('selected-count');
            const btnSelectAll = document.getElementById('btn-select-all');
            
            // 获取提示词文本 (Prompt Text)，如果为空则回退到标题
            const rawPromptContent = `{{ group.prompt_text|default:group.title|escapejs }}`;

            // 1. 进入/退出 批量模式
            function toggleBatchMode(active) {
                if (active) {
                    body.classList.add('batch-mode');
                    batchBar.classList.add('active');
                    btnEnter.classList.add('d-none'); // 隐藏入口按钮
                } else {
                    body.classList.remove('batch-mode');
                    batchBar.classList.remove('active');
                    btnEnter.classList.remove('d-none');
                    // 清除选中
                    document.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
                    updateCount();
                }
            }

            if(btnEnter) btnEnter.addEventListener('click', () => toggleBatchMode(true));
            if(btnExit) btnExit.addEventListener('click', () => toggleBatchMode(false));

            // 2. 点击选择/取消选择 (使用事件委托)
            const gridContainer = document.getElementById('detail-masonry-grid-images');
            const videoGridContainer = document.getElementById('detail-masonry-grid-videos');
            
            // 标记当前操作是否是框选拖拽，防止与 Click 事件冲突
            let isDragSelectionOccurred = false;

            function handleCardClick(e) {
                if (!body.classList.contains('batch-mode')) return;
                // 如果刚刚发生了拖拽框选，则忽略 click，避免反转状态
                if (isDragSelectionOccurred) return;
                
                const card = e.target.closest('.item-card');
                if (card) {
                    e.preventDefault();
                    e.stopPropagation();
                    card.classList.toggle('selected');
                    updateCount();
                }
            }

            if(gridContainer) gridContainer.addEventListener('click', handleCardClick);
            if(videoGridContainer) videoGridContainer.addEventListener('click', handleCardClick);

            // === 2.5 框选（橡皮筋）逻辑 ===
            const selectionBox = document.createElement('div');
            selectionBox.classList.add('selection-area-box');
            document.body.appendChild(selectionBox);

            let isDragging = false;
            let startX, startY;

            document.addEventListener('mousedown', function(e) {
                if (!body.classList.contains('batch-mode')) return;
                // 排除点击在功能区域的情况
                if (e.target.closest('.batch-bar') || 
                    e.target.closest('.sticky-sidebar') || 
                    e.target.closest('.modal') || 
                    e.target.closest('button')) return;

                isDragging = true;
                isDragSelectionOccurred = false; // 重置
                startX = e.clientX;
                startY = e.clientY;
                
                selectionBox.style.left = startX + 'px';
                selectionBox.style.top = startY + 'px';
                selectionBox.style.width = '0px';
                selectionBox.style.height = '0px';
                selectionBox.style.display = 'block';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;

                const curX = e.clientX;
                const curY = e.clientY;

                // 简单的防抖：移动距离太小不计算，防止误触
                if (Math.abs(curX - startX) > 5 || Math.abs(curY - startY) > 5) {
                    isDragSelectionOccurred = true;
                }

                const left = Math.min(startX, curX);
                const top = Math.min(startY, curY);
                const width = Math.abs(curX - startX);
                const height = Math.abs(curY - startY);

                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';

                // 碰撞检测
                const cards = document.querySelectorAll('.item-card');
                cards.forEach(card => {
                    const rect = card.getBoundingClientRect();
                    // 判断两个矩形是否相交
                    if (left < rect.right && left + width > rect.left && top < rect.bottom && top + height > rect.top) {
                         if (!card.classList.contains('selected')) {
                             card.classList.add('selected');
                         }
                    }
                });
                
                // 只有在发生真实框选时才实时更新计数，避免频繁DOM操作
                if (isDragSelectionOccurred) {
                    requestAnimationFrame(updateCount);
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isDragging) {
                    isDragging = false;
                    selectionBox.style.display = 'none';
                    selectionBox.style.width = '0';
                    selectionBox.style.height = '0';
                    
                    // 延迟重置拖拽标记，确保 click 事件能读取到
                    setTimeout(() => {
                        isDragSelectionOccurred = false;
                    }, 100);
                }
            });

            // 3. 全选逻辑
            if(btnSelectAll) {
                btnSelectAll.addEventListener('click', () => {
                    const cards = document.querySelectorAll('.item-card');
                    const allSelected = document.querySelectorAll('.item-card.selected').length === cards.length;
                    cards.forEach(c => {
                        if (allSelected) c.classList.remove('selected');
                        else c.classList.add('selected');
                    });
                    updateCount();
                });
            }

            function updateCount() {
                const count = document.querySelectorAll('.item-card.selected').length;
                countSpan.textContent = count;
            }

            function getSelectedItems() {
                const selected = [];
                document.querySelectorAll('.item-card.selected').forEach(card => {
                    selected.push({
                        id: card.dataset.imgId,
                        url: card.dataset.imgUrl
                    });
                });
                return selected;
            }

            // 4. 批量删除逻辑
            const modalDelete = new bootstrap.Modal(document.getElementById('batchDeleteModal'));
            const btnTriggerDelete = document.getElementById('btn-batch-delete-trigger');
            const btnConfirmDelete = document.getElementById('btn-confirm-batch-delete');

            if(btnTriggerDelete) {
                btnTriggerDelete.addEventListener('click', () => {
                    const items = getSelectedItems();
                    if (items.length === 0) return alert('请先选择要删除的项目');
                    
                    document.getElementById('modal-delete-count').textContent = items.length;
                    modalDelete.show();
                });
            }

            if(btnConfirmDelete) {
                btnConfirmDelete.addEventListener('click', () => {
                    const items = getSelectedItems();
                    const ids = items.map(i => i.id);
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    fetch("{% url 'batch_delete_images' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ image_ids: ids })
                    })
                    .then(response => response.json())
                    .then(data => {
                        modalDelete.hide();
                        if (data.status === 'success') {
                            document.querySelectorAll('.item-card.selected').forEach(card => {
                                const col = card.closest('.col-6') || card.closest('.col-12') || card; 
                                col.remove();
                            });
                            toggleBatchMode(false); 
                            const imgCountBadge = document.getElementById('image-count-badge');
                            if(imgCountBadge) imgCountBadge.innerText = document.querySelectorAll('#detail-masonry-grid-images .item-card').length;
                        } else {
                            alert('删除失败: ' + data.message);
                        }
                    });
                });
            }

            // 5. 批量下载逻辑 (适配新版美化弹窗)
            const btnBatchDownload = document.getElementById('btn-batch-download');
            const modalDownloadEl = document.getElementById('batchDownloadModal');
            const modalDownload = new bootstrap.Modal(modalDownloadEl);
            const btnConfirmDownload = document.getElementById('btn-confirm-batch-download');
            
            // 文件名净化函数
            function sanitizeFilename(text) {
                if (!text) return 'image';
                return text.replace(/[\r\n]+/g, ' ')
                           .replace(/[<>:"/\\|?*]/g, '')
                           .trim()
                           .substring(0, 60);
            }

            // 点击“批量下载” -> 弹出模态框
            if(btnBatchDownload) {
                btnBatchDownload.addEventListener('click', () => {
                    const items = getSelectedItems();
                    if (items.length === 0) return alert('请先选择要下载的项目');
                    
                    // 更新模态框里的数量
                    document.getElementById('modal-download-count').textContent = items.length;
                    modalDownload.show();
                });
            }

            // 点击模态框里的“开始下载” -> 执行下载循环
            if(btnConfirmDownload) {
                btnConfirmDownload.addEventListener('click', () => {
                    // 关闭模态框
                    modalDownload.hide();
                    
                    const items = getSelectedItems();
                    const basePromptName = sanitizeFilename(rawPromptContent) || 'image';

                    const downloadNext = (index) => {
                        if (index >= items.length) return;
                        
                        const item = items[index];
                        const ext = item.url.split('.').pop().split('?')[0]; 
                        const filename = `${basePromptName}_${item.id}.${ext}`; 
                        
                        fetch(item.url)
                            .then(resp => resp.blob())
                            .then(blob => {
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.style.display = 'none';
                                a.href = url;
                                a.download = filename; 
                                document.body.appendChild(a);
                                a.click();
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);
                                
                                setTimeout(() => downloadNext(index + 1), 400); 
                            })
                            .catch(err => {
                                console.error('下载失败', err);
                                setTimeout(() => downloadNext(index + 1), 400);
                            });
                    };
                    
                    // 开始
                    downloadNext(0);
                });
            }
            // === 批量管理逻辑 End ===
        });

        // 悬浮按钮点击逻辑 (原有逻辑)
        function toggleGroupLike(btn, groupId) {
            const icon = btn.querySelector('i');
            const isLiked = btn.classList.contains('liked');
            btn.classList.toggle('liked');
            if (!isLiked) {
                icon.classList.remove('bi-heart');
                icon.classList.add('bi-heart-fill');
                btn.setAttribute('data-bs-original-title', '取消喜欢');
                icon.style.transform = 'scale(1.4)';
                setTimeout(() => icon.style.transform = 'scale(1)', 200);
            } else {
                icon.classList.remove('bi-heart-fill');
                icon.classList.add('bi-heart');
                btn.setAttribute('data-bs-original-title', '喜欢此作品');
            }
            const tooltip = bootstrap.Tooltip.getInstance(btn);
            if (tooltip) tooltip.hide();

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(`/toggle-like-group/${groupId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }).catch(err => console.error(err));
        }
        // === 右键菜单逻辑 ===
        const contextMenu = document.getElementById('imgContextMenu');
        let rightClickedImgId = null;

        // 监听全局右键事件
        document.addEventListener('contextmenu', function(e) {
            // 查找是否点击了详情页的图片卡片 (.item-card)
            const card = e.target.closest('.item-card');
            
            // 排除视频（可选：如果您也想让视频设为封面，去掉 !card.classList.contains('video-wide-item')）
            if (card) {
                e.preventDefault(); // 阻止浏览器默认菜单
                
                // 获取图片ID
                rightClickedImgId = card.dataset.imgId;
                
                // 定位菜单
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.style.top = `${e.clientY}px`;
            } else {
                // 如果不是点在卡片上，隐藏菜单
                contextMenu.style.display = 'none';
            }
        });

        // 点击其他地方隐藏菜单
        document.addEventListener('click', function() {
            contextMenu.style.display = 'none';
        });
        
        // 页面滚动时隐藏菜单
        window.addEventListener('scroll', () => { contextMenu.style.display = 'none'; }, true);

        // 设为封面功能函数
        function setAsCoverFromMenu() {
            if (!rightClickedImgId) return;
            
            const groupId = {{ group.pk }}; // 获取当前组ID
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // 显示加载状态
            Swal.fire({
                title: '正在设置...',
                didOpen: () => Swal.showLoading(),
                background: 'transparent',
                backdrop: 'rgba(0,0,0,0.1)',
                showConfirmButton: false
            });

            fetch(`/api/set-cover/${groupId}/${rightClickedImgId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: '封面已更新',
                        toast: true,
                        position: 'top',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    Swal.fire('设置失败', data.message, 'error');
                }
            })
            .catch(err => {
                console.error(err);
                Swal.fire('错误', '网络请求失败', 'error');
            });
        }
    </script>
{% endblock %}