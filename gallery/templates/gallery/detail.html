{% extends 'gallery/base.html' %}
{% load static %}

{% block body_class %}detail-page{% endblock %}

{% block content %}
<div class="container mt-0 mb-4">
    <div class="mb-4">
        {% with from_view=request.GET.from|default:'home' page_num=request.GET.page|default:'1' q_val=request.GET.q|default:'' filter_val=request.GET.filter|default:'' source_id=request.GET.source_img_id back_to_id=request.GET.back_to_detail_id search_id=request.GET.search_id %}
            {% if back_to_id %}
                <a href="{% url 'detail' back_to_id %}?from={{ from_view }}&page={{ page_num }}{% if q_val %}&q={{ q_val }}{% endif %}{% if filter_val %}&filter={{ filter_val }}{% endif %}{% if source_id %}&source_img_id={{ source_id }}{% endif %}" class="btn-float-back" title="返回"><i class="bi bi-arrow-left"></i><span>返回</span></a>
            {% elif search_id %}
                {% if from_view == 'home_search' %}
                    <a href="{% url 'home' %}?search_id={{ search_id }}" class="btn-float-back" title="返回搜索结果"><i class="bi bi-arrow-left"></i><span>返回搜索结果</span></a>
                {% else %}
                    <a href="{% url 'liked_images_gallery' %}?search_id={{ search_id }}" class="btn-float-back" title="返回搜索结果"><i class="bi bi-arrow-left"></i><span>返回搜索结果</span></a>
                {% endif %}
            {% elif from_view == 'liked' %}
                <a href="{% url 'liked_images_gallery' %}?page={{ page_num }}{% if q_val %}&q={{ q_val }}{% endif %}{% if source_id %}#card-img-{{ source_id }}{% endif %}" class="btn-float-back" title="返回"><i class="bi bi-arrow-left"></i><span>返回</span></a>
            {% else %}
                <a href="{% url 'home' %}?page={{ page_num }}{% if q_val %}&q={{ q_val }}{% endif %}{% if filter_val %}&filter={{ filter_val }}{% endif %}#group-card-{{ group.pk }}" class="btn-float-back" title="返回"><i class="bi bi-arrow-left"></i><span>返回</span></a>
            {% endif %}
        {% endwith %}
    </div>

    <div class="row gx-lg-5 detail-split-view">
        <div class="col-lg-8 mb-5 mb-lg-0 detail-scroll-left">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h2 class="fw-bold text-dark mb-0 flex-grow-1 p-2 rounded" 
                    ondblclick="enableTitleEdit(this, {{ group.pk }})" 
                    title="双击修改标题" 
                    style="cursor: text; margin-left: -0.5rem; transition: background-color 0.2s;">
                    {{ group.title }}
                </h2>
            </div>
            
            <div class="upload-trigger-area mb-4" id="inline-trigger-gen" role="button">
                <div class="trigger-content">
                    <div class="icon-wrapper mb-2">
                        <i class="bi bi-cloud-arrow-up-fill"></i>
                    </div>
                    <div class="fw-bold text-dark">点击或拖拽上传图片/视频</div>
                    <div class="small text-muted mt-1">支持批量上传 / 自动去重</div>
                </div>
            </div>

            <div class="mb-4 d-flex flex-wrap align-items-center gap-2" id="tagsContainer" style="min-height: 40px;">
                {% for tag in sorted_tags %}
                    <span class="tag-interactive {% if tag.name == group.model_info %}model-tag{% endif %}" id="tag-pill-{{ tag.id }}">
                        {% if tag.name == group.model_info %}<i class="bi bi-robot me-1"></i>{% endif %}
                        <a href="/?q={{ tag.name }}">{{ tag.name }}</a>
                        <span class="tag-remove-btn" onclick="removeTag({{ group.pk }}, {{ tag.id }}, '{{ tag.name|escapejs }}')" title="移除">
                            <i class="bi bi-x-circle-fill"></i>
                        </span>
                    </span>
                {% endfor %}
                <div class="d-flex align-items-center">
                    <button class="btn-add-tag-dashed" id="btnAddTag" onclick="showTagInput()" title="添加标签"><i class="bi bi-plus-lg"></i></button>
                    <div class="tag-input-container" id="tagInputContainer">
                        <input type="text" class="tag-input-line" id="newTagInput" placeholder="输入标签..." list="availableTags" onkeydown="handleTagKey(event, {{ group.pk }})">
                        <button class="btn-confirm-tag" type="button" onclick="addTag({{ group.pk }})" title="确认添加"><i class="bi bi-check-lg"></i></button>
                        <datalist id="availableTags">{% for t in all_tags %}<option value="{{ t.name }}">{% endfor %}</datalist>
                    </div>
                </div>
            </div>

            <div class="section-divider mb-3 pb-2 border-bottom d-flex align-items-center">
                <h5 class="fw-bold text-secondary mb-0"><i class="bi bi-images me-2"></i>图片</h5>
                <span class="ms-2 badge bg-light text-secondary border" id="image-count-badge">{{ images_list|length }}</span>
            </div>
            
            <div id="detail-masonry-grid-images" class="row mb-5">
                {% for img in images_list %}
                    {% include 'gallery/components/detail_image_card.html' with img=img index=forloop.counter0 %}
                {% empty %}
                <div class="col-12"><div class="alert alert-light border text-center py-4 text-muted rounded-3" style="background: rgba(255,255,255,0.5)"><i class="bi bi-image fs-1 d-block mb-3 opacity-50"></i>暂无图片</div></div>
                {% endfor %}
            </div>

            <div class="section-divider mb-3 pb-2 border-bottom d-flex align-items-center">
                <h5 class="fw-bold text-secondary mb-0"><i class="bi bi-camera-reels me-2"></i>视频</h5>
                <span class="ms-2 badge bg-light text-secondary border" id="video-count-badge">{{ videos_list|length }}</span>
            </div>

            <div id="detail-masonry-grid-videos" class="row">
                {% for img in videos_list %}
                    {% include 'gallery/components/detail_image_card.html' with img=img %}
                {% empty %}
                <div class="col-12"><div class="alert alert-light border text-center py-4 text-muted rounded-3" style="background: rgba(255,255,255,0.5)"><i class="bi bi-film fs-1 d-block mb-3 opacity-50"></i>暂无视频</div></div>
                {% endfor %}
            </div>

            {% if related_groups %}
            <div class="mt-5 pt-4 border-top border-light">
                <h4 class="mb-4 fw-bold text-secondary"><i class="bi bi-stars text-primary me-2"></i>猜你喜欢</h4>
                <div class="horizontal-scroll-wrapper" id="horizontal-scroll">
                    {% for related in related_groups %}
                    <div class="horizontal-card-item">
                        <div class="gallery-card h-100 d-block position-relative group-card-container">
                            <a href="{% url 'detail' related.pk %}?back_to_detail_id={{ group.pk }}&from={{ request.GET.from|default:'home' }}&page={{ request.GET.page|default:'1' }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="text-decoration-none text-dark">
                                <div class="horizontal-img-wrapper">
                                    {% with cover=related.images.first %}
                                        {% if cover %}
                                            {% if cover.is_video %}
                                                <div class="d-flex align-items-center justify-content-center h-100 w-100 bg-dark text-white"><i class="bi bi-play-circle fs-1"></i></div>
                                            {% else %}
                                                <img src="{{ cover.thumbnail.url }}" alt="{{ related.title }}" loading="lazy">
                                            {% endif %}
                                        {% else %}
                                            <div class="d-flex align-items-center justify-content-center h-100 w-100 text-secondary bg-light bg-opacity-50">
                                                <i class="bi bi-image fs-1 opacity-50"></i>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="card-body p-2">
                                    <h6 class="card-title text-truncate mb-1 small">{{ related.title }}</h6>
                                    <p class="text-muted small mb-0 text-truncate">{{ related.prompt_text }}</p>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4 ps-lg-4 detail-scroll-right">
            <div class="sticky-sidebar">
                
                <div class="prompt-card p-4 border-danger border-opacity-25 mb-4" style="background: rgba(255, 230, 230, 0.4);">
                    <div class="section-header mb-2"><span class="section-label text-danger">管理操作</span></div>
                    <form action="{% url 'delete_group' group.pk %}" method="post" class="delete-form-confirm">
                        {% csrf_token %}
                        <button type="button" class="btn btn-danger w-100 rounded-pill btn-sm" onclick="confirmDelete(event)">
                            <i class="bi bi-trash3 me-2"></i>永久删除整个作品
                        </button>
                    </form>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header mb-3 d-flex justify-content-between align-items-center">
                        <span class="section-label text-info">参考图 (References)</span>
                    </div>

                    <div class="row row-cols-3 g-2" id="reference-grid">
                        <div class="col">
                            <div class="ratio ratio-1x1 upload-trigger-card" id="inline-trigger-ref" role="button">
                                <div class="d-flex flex-column align-items-center justify-content-center h-100 content-wrapper">
                                    <i class="bi bi-plus-lg fs-3 mb-1"></i>
                                    <span class="small">添加参考</span>
                                </div>
                            </div>
                        </div>
                        {% for ref in group.references.all %}
                            {% include 'gallery/components/detail_reference_item.html' with ref=ref %}
                        {% endfor %}
                    </div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-primary">Prompt (正向)</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('promptText', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('promptText', {{ group.pk }}, 'positive')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('promptText')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('promptText', this)" class="btn btn-sm btn-outline-primary rounded-pill px-3" {% if not group.prompt_text %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box" id="promptText">{% if group.prompt_text %}{{ group.prompt_text }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-success">中文/辅助提示词</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('promptTextZh', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('promptTextZh', {{ group.pk }}, 'positive_zh')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('promptTextZh')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('promptTextZh', this)" class="btn btn-sm btn-outline-success rounded-pill px-3" {% if not group.prompt_text_zh %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box" id="promptTextZh">{% if group.prompt_text_zh %}{{ group.prompt_text_zh }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-danger">Negative Prompt</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('negPrompt', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('negPrompt', {{ group.pk }}, 'negative')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('negPrompt')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('negPrompt', this)" class="btn btn-sm btn-outline-danger rounded-pill px-3" {% if not group.negative_prompt %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box" id="negPrompt">{% if group.negative_prompt %}{{ group.negative_prompt }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="card shadow-sm border-0 mb-4" style="background: rgba(230, 240, 255, 0.5);">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title text-primary fw-bold mb-0" style="font-size: 0.9rem;">
                                <i class="bi bi-layers-fill me-2"></i>其他版本 ({{ siblings|length }})
                            </h6>
                            <button class="btn btn-sm rounded-pill px-3 shadow-sm btn-link-interactive" style="font-size: 0.75rem;" onclick="openLinkModal()" title="关联现有图片到此系列">
                                <i class="bi bi-link-45deg me-1"></i>关联
                            </button>
                        </div>
                        
                        <div class="d-flex flex-column gap-2">
                            {% for sib in siblings %}
                            <div class="position-relative sibling-group">
                                <a href="{% url 'detail' sib.pk %}" class="d-flex align-items-center p-2 bg-white rounded-3 border text-decoration-none shadow-sm sibling-card">
                                    <div class="sibling-thumb-wrapper">
                                        {% if sib.images.first %}
                                            {% if sib.images.first.is_video %}
                                            <div class="sibling-empty-thumb bg-dark text-white"><i class="bi bi-play-fill"></i></div>
                                            {% else %}
                                            <img src="{{ sib.images.first.thumbnail.url }}" class="sibling-thumb">
                                            {% endif %}
                                        {% else %}
                                        <div class="sibling-empty-thumb"><i class="bi bi-image"></i></div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="ms-2 flex-grow-1 overflow-hidden">
                                        {% if sib.model_info %}
                                            {% if sib.model_info != group.model_info %}
                                                <div class="mb-1">
                                                    <span class="badge rounded-pill border" 
                                                        title="模型变更: 当前是 {{ group.model_info }}"
                                                        style="background-color: #fff3cd; color: #856404; border-color: #ffeeba !important; font-weight: normal; font-size: 0.7rem;">
                                                        <i class="bi bi-exclamation-triangle-fill me-1"></i>{{ sib.model_info }}
                                                    </span>
                                                </div>
                                            {% else %}
                                                <div class="mb-1">
                                                    <span class="badge bg-light text-secondary border rounded-pill" 
                                                        style="font-weight: normal; font-size: 0.7rem;">
                                                        <i class="bi bi-robot me-1"></i>{{ sib.model_info }}
                                                    </span>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                        <div class="sibling-diff-wrapper custom-scrollbar">
                                            {{ sib.diff_html|safe }}
                                        </div>
                                    </div>
                                </a>
                                
                                <button class="btn-unlink-float" title="解除关联 (变为独立作品)" onclick="unlinkSibling(event, {{ sib.pk }})">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="text-center text-muted small py-3 fst-italic bg-white bg-opacity-50 rounded border border-dashed">
                                暂无其他版本
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="linkVersionModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-4">
                            <div class="modal-header border-0 pb-0">
                                <h5 class="modal-title fw-bold">关联新版本</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted small mb-3">搜索并选择一个现有的作品，将其作为当前作品的“另一版本”关联起来。</p>
                                <div class="position-relative mb-3">
                                    <input type="text" id="linkSearchInput" class="form-control rounded-pill ps-4" placeholder="搜索标题或提示词..." oninput="debounceSearchLink()">
                                    <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3 text-muted"></i>
                                </div>
                                <div id="linkSearchResults" class="custom-scrollbar" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center text-muted py-3 small">请输入关键词搜索</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                    <div class="text-muted small">
                                        已选: <span id="linkSelectedCount" class="fw-bold text-primary">0</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="clearLinkSelection()">清除</button>
                                        <button type="button" class="btn btn-sm btn-primary rounded-pill px-3" onclick="submitLinkSelection()">确认关联</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-primary">Model Info / 参数</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('modelInfo', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('modelInfo', {{ group.pk }}, 'model')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('modelInfo')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('modelInfo', this)" class="btn btn-sm btn-outline-primary rounded-pill px-3" {% if not group.model_info %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box mb-3" id="modelInfo">{% if group.model_info %}{{ group.model_info }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                    <div class="border-top pt-3">
                        <ul class="list-unstyled mb-0 text-secondary small">
                            <li class="d-flex align-items-center">
                                <i class="bi bi-calendar3 me-2 text-primary"></i>
                                <div><strong class="text-dark me-1">创建时间:</strong>{{ group.created_at|date:"Y-m-d H:i" }}</div>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addImagesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4" style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-dark">添加生成图</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <form id="addImagesForm" action="{% url 'add_images' group.pk %}" method="post" enctype="multipart/form-data" onsubmit="handleImageUpload(event)">
                    {% csrf_token %}
                    <div id="zone-modal-gen" class="upload-zone-modal">
                        <i class="bi bi-cloud-arrow-up"></i><p>点击或将图片/视频拖拽至此</p>
                        <input type="file" name="new_images" id="input-modal-gen" multiple accept="image/*,video/*">
                    </div>
                    <div id="preview-modal-gen" class="preview-container-modal"></div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary rounded-pill fw-bold" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none;">
                            <i class="bi bi-cloud-upload me-2"></i>确认上传
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% include 'gallery/components/modal_add_reference.html' %} 

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 100vw; margin: 0;">
        <div class="modal-content border-0" style="background: transparent;">
            <div class="modal-body p-0 position-relative d-flex justify-content-center align-items-center" style="height: 100vh;">
                <a href="#" id="modalDownloadBtn" download class="modal-download-btn"><i class="bi bi-download"></i> 下载原图</a>
                <button type="button" id="modalLikeBtn" class="modal-like-btn" onclick="toggleModalLike()"><i class="bi bi-heart"></i> 喜欢</button>
                <form id="modalDeleteForm" method="post" class="delete-form-confirm">{% csrf_token %}<button type="button" class="modal-delete-btn" onclick="confirmDelete(event)"><i class="bi bi-trash3"></i> 删除此图</button></form>
                <button type="button" class="close-modal-btn" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i></button>
                
                <div class="nav-btn nav-prev" onclick="changeImage(-1)"><i class="bi bi-chevron-left"></i></div>
                
                <img src="" id="previewImage" alt="Preview" style="max-height: 90vh; max-width: 90vw; object-fit: contain;">
                <video src="" id="previewVideo" controls style="max-height: 90vh; max-width: 90vw; display:none;" class="shadow-lg rounded"></video>
                
                <div class="nav-btn nav-next" onclick="changeImage(1)"><i class="bi bi-chevron-right"></i></div>
                <div id="imageCounter" class="image-counter"></div>
            </div>
        </div>
    </div>
</div>

{% include 'gallery/components/offcanvas_tags.html' %}
{% endblock %}

{% block extra_js %}
    <script type="application/json" id="gallery-data">
    [
        {% for img in group.images.all %}
    { 
        "url": "{{ img.image.url }}", 
        "id": {{ img.pk }}, 
        "isLiked": {% if img.is_liked %}true{% else %}false{% endif %}, 
        "isVideo": {% if img.is_video %}true{% else %}false{% endif %}  }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ]
    </script>
    <script src="{% static 'gallery/js/detail.js' %}"></script>
{% endblock %}