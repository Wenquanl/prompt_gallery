{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ group.title }} - 详情</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="{% static 'gallery/favicon.svg' %}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{% static 'gallery/style.css' %}">
    
    <style>
        .tag-interactive {
            display: inline-flex; align-items: center; padding: 6px 16px;
            background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.9); border-radius: 50px;
            color: #555; font-size: 0.85rem; font-weight: 500;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: default; user-select: none; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            position: relative; overflow: hidden; height: 32px;
        }
        .tag-interactive:hover {
            background: white; transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 15px rgba(0,0,0,0.08); color: #2c3e50;
            border-color: white; padding-right: 12px;
        }
        .tag-interactive a { color: inherit; text-decoration: none; display: flex; align-items: center; }
        .tag-interactive.model-tag {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(243, 232, 255, 0.9) 100%);
            border: 1px solid rgba(161, 140, 209, 0.3); color: #6a4c93; font-weight: 600;
        }
        .tag-interactive.model-tag:hover {
            background: linear-gradient(135deg, #fff 0%, #f3e8ff 100%);
            box-shadow: 0 5px 15px rgba(161, 140, 209, 0.25); border-color: rgba(161, 140, 209, 0.5);
        }
        .tag-remove-btn {
            width: 0; opacity: 0; transform: translateX(10px); margin-left: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #ff6b6b; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem;
        }
        .tag-interactive:hover .tag-remove-btn { width: 20px; opacity: 1; transform: translateX(0); margin-left: 8px; }
        .tag-remove-btn:hover { color: #ff4757; transform: scale(1.2); }
        .btn-add-tag-dashed {
            width: 32px; height: 32px; border: 1.5px dashed #cbd5e1; border-radius: 50%;
            background: rgba(255,255,255,0.5); color: #94a3b8;
            display: inline-flex; align-items: center; justify-content: center;
            transition: all 0.3s ease; cursor: pointer; backdrop-filter: blur(4px); flex-shrink: 0; 
        }
        .btn-add-tag-dashed:hover {
            border-color: var(--accent-color); color: var(--accent-color);
            transform: rotate(90deg); background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .tag-input-container {
            display: flex; align-items: center; overflow: hidden; width: 0; opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); white-space: nowrap;
        }
        .tag-input-container.show { width: 220px; opacity: 1; margin-left: 8px; }
        .tag-input-line {
            border: none; border-bottom: 2px solid var(--accent-color); background: transparent;
            border-radius: 0; padding: 2px 5px; font-size: 0.85rem; color: var(--text-main);
            width: 100%; outline: none;
        }
        .tag-input-line::placeholder { color: #cbd5e1; font-size: 0.8rem; }
        .btn-confirm-tag {
            width: 28px; height: 28px; border: none; border-radius: 50%; background: #20c997; 
            color: white; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
            margin-left: 8px; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(32, 201, 151, 0.3); opacity: 0; transform: scale(0.5); 
        }
        .btn-confirm-tag:hover { background: #198754; transform: scale(1.1) !important; }
        .tag-input-container.show .btn-confirm-tag { opacity: 1; transform: scale(1); transition-delay: 0.1s; }
        .btn-back-interactive {
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.8); color: #64748b;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); font-weight: 500;
            padding-left: 20px !important; padding-right: 24px !important; display: inline-flex; align-items: center;
        }
        .btn-back-interactive:hover {
            background: #fff; color: #2c3e50; transform: translateX(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08) !important; border-color: #fff;
        }
        .btn-back-interactive i { transition: transform 0.3s ease; }
        .btn-back-interactive:hover i { transform: translateX(-3px); }
        .btn-back-interactive:active { transform: translateX(-4px) scale(0.96); }
    </style>
</head>
<body class="detail-page">

{% include 'gallery/components/navbar.html' %}
<div class="container mt-0 mb-4">
    <div class="mb-4">
        {% with from_view=request.GET.from|default:'home' page_num=request.GET.page|default:'1' q_val=request.GET.q|default:'' filter_val=request.GET.filter|default:'' source_id=request.GET.source_img_id back_to_id=request.GET.back_to_detail_id search_id=request.GET.search_id %}
        {% if back_to_id %}
            <a href="{% url 'detail' back_to_id %}?from={{ from_view }}&page={{ page_num }}{% if q_val %}&q={{ q_val }}{% endif %}{% if filter_val %}&filter={{ filter_val }}{% endif %}{% if source_id %}&source_img_id={{ source_id }}{% endif %}" 
            class="btn-float-back" title="返回">
                <i class="bi bi-arrow-left"></i><span>返回</span>
            </a>
        {% elif search_id %}
            {% if from_view == 'home_search' %}
                <a href="{% url 'home' %}?search_id={{ search_id }}" class="btn-float-back" title="返回搜索结果">
                    <i class="bi bi-arrow-left"></i><span>返回搜索结果</span>
                </a>
            {% else %}
                <a href="{% url 'liked_images_gallery' %}?search_id={{ search_id }}" class="btn-float-back" title="返回搜索结果">
                    <i class="bi bi-arrow-left"></i><span>返回搜索结果</span>
                </a>
            {% endif %}
        {% elif from_view == 'liked' %}
            <a href="{% url 'liked_images_gallery' %}?page={{ page_num }}{% if q_val %}&q={{ q_val }}{% endif %}{% if source_id %}#card-img-{{ source_id }}{% endif %}" 
            class="btn-float-back" title="返回">
                <i class="bi bi-arrow-left"></i><span>返回</span>
            </a>
        {% else %}
            <a href="{% url 'home' %}?page={{ page_num }}{% if q_val %}&q={{ q_val }}{% endif %}{% if filter_val %}&filter={{ filter_val }}{% endif %}#group-card-{{ group.pk }}" 
            class="btn-float-back" title="返回">
                <i class="bi bi-arrow-left"></i><span>返回</span>
            </a>
        {% endif %}
    {% endwith %}
    </div>

    <div class="row gx-lg-5 detail-split-view">
        <div class="col-lg-8 mb-5 mb-lg-0 detail-scroll-left">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h2 class="fw-bold text-dark mb-0">{{ group.title }}</h2>
                <button type="button" class="btn btn-primary rounded-pill px-3 btn-sm d-flex align-items-center btn-action-shine" 
                        data-bs-toggle="modal" data-bs-target="#addImagesModal">
                    <i class="bi bi-plus-lg me-1"></i>添加生成图
                </button>
            </div>
            
            <div class="mb-4 d-flex flex-wrap align-items-center gap-2" id="tagsContainer" style="min-height: 40px;">
                {% for tag in sorted_tags %}
                    <span class="tag-interactive {% if tag.name == group.model_info %}model-tag{% endif %}" id="tag-pill-{{ tag.id }}">
                        {% if tag.name == group.model_info %}<i class="bi bi-robot me-1"></i>{% endif %}
                        <a href="/?q={{ tag.name }}">{{ tag.name }}</a>
                        
                        <span class="tag-remove-btn" onclick="removeTag({{ group.pk }}, {{ tag.id }}, '{{ tag.name|escapejs }}')" title="移除">
                            <i class="bi bi-x-circle-fill"></i>
                        </span>
                    </span>
                {% endfor %}
                
                <div class="d-flex align-items-center">
                    <button class="btn-add-tag-dashed" id="btnAddTag" onclick="showTagInput()" title="添加标签">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    
                    <div class="tag-input-container" id="tagInputContainer">
                        <input type="text" class="tag-input-line" id="newTagInput" 
                               placeholder="输入标签..." list="availableTags" 
                               onkeydown="handleTagKey(event, {{ group.pk }})">
                        
                        <button class="btn-confirm-tag" type="button" onclick="addTag({{ group.pk }})" title="确认添加">
                            <i class="bi bi-check-lg"></i>
                        </button>

                        <datalist id="availableTags">
                            {% for t in all_tags %}
                                <option value="{{ t.name }}">
                            {% endfor %}
                        </datalist>
                    </div>
                </div>
            </div>

            <div id="detail-masonry-grid" class="row">
                {% for img in group.images.all %}
                <div class="grid-item mb-3" id="img-anchor-{{ img.pk }}">
                    <div class="detail-img-card shadow-sm position-relative" id="img-card-{{ img.pk }}">
                        <span class="file-size-badge">{{ img.image.size|filesizeformat }}</span>
                        <div class="position-relative" role="button" onclick="showModal({{ forloop.counter0 }})">
                            <img src="{{ img.thumbnail.url }}" class="thumb-img" alt="AI Artwork" loading="lazy">
                            <div class="hover-overlay"><i class="bi bi-zoom-in text-white fs-2"></i></div>
                        </div>
                        <div class="img-action-bar">
                            <button type="button" class="action-btn like {% if img.is_liked %}active{% endif %}" 
                                    id="like-btn-{{ img.pk }}"
                                    title="喜欢" onclick="toggleImageLike(event, {{ img.pk }})">
                                <i class="bi {% if img.is_liked %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                            </button>
                            <a href="{{ img.image.url }}" download class="action-btn download" title="下载原图"><i class="bi bi-download"></i></a>
                            <form action="{% url 'delete_image' img.pk %}" method="post" class="delete-form-confirm" style="display:inline;">
                                {% csrf_token %}
                                <button type="button" class="action-btn delete" title="删除图片" onclick="confirmDelete(event)"><i class="bi bi-trash3-fill"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12"><div class="alert alert-light border text-center py-5 text-muted rounded-3" style="background: rgba(255,255,255,0.5)"><i class="bi bi-image fs-1 d-block mb-3 opacity-50"></i>暂无图片</div></div>
                {% endfor %}
            </div>

            {% if related_groups %}
            <div class="mt-5 pt-4 border-top border-light">
                <h4 class="mb-4 fw-bold text-secondary"><i class="bi bi-stars text-primary me-2"></i>猜你喜欢</h4>
                <div class="horizontal-scroll-wrapper" id="horizontal-scroll">
                    {% for related in related_groups %}
                    <div class="horizontal-card-item">
                        <div class="gallery-card h-100 d-block position-relative group-card-container">
                            <a href="{% url 'detail' related.pk %}?back_to_detail_id={{ group.pk }}&from={{ request.GET.from|default:'home' }}&page={{ request.GET.page|default:'1' }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" 
                               class="text-decoration-none text-dark">
                                <div class="horizontal-img-wrapper">
                                    {% with cover=related.images.first %}
                                        {% if cover %}
                                            <img src="{{ cover.thumbnail.url }}" alt="{{ related.title }}" loading="lazy">
                                        {% else %}
                                            <div class="d-flex align-items-center justify-content-center h-100 w-100 text-secondary bg-light bg-opacity-50">
                                                <i class="bi bi-image fs-1 opacity-50"></i>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="card-body p-2">
                                    <h6 class="card-title text-truncate mb-1 small">{{ related.title }}</h6>
                                    <p class="text-muted small mb-0 text-truncate">{{ related.prompt_text }}</p>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4 ps-lg-4 detail-scroll-right">
            <div class="sticky-sidebar">
                <div class="prompt-card p-4 border-danger border-opacity-25 mb-4" style="background: rgba(255, 230, 230, 0.4);">
                    <div class="section-header mb-2"><span class="section-label text-danger">管理操作</span></div>
                    <form action="{% url 'delete_group' group.pk %}" method="post" class="delete-form-confirm">
                        {% csrf_token %}
                        <button type="button" class="btn btn-danger w-100 rounded-pill btn-sm" onclick="confirmDelete(event)">
                            <i class="bi bi-trash3 me-2"></i>永久删除整个作品
                        </button>
                    </form>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header mb-3 d-flex justify-content-between align-items-center">
                        <span class="section-label text-info">参考图 (References)</span>
                        <button class="btn btn-sm btn-outline-info rounded-circle" style="width:24px; height:24px; padding:0;" 
                                data-bs-toggle="modal" data-bs-target="#addReferenceModal" title="添加参考图">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    <div class="row row-cols-3 g-2">
                        {% for ref in group.references.all %}
                        <div class="col position-relative">
                            <div class="ratio ratio-1x1 rounded overflow-hidden border bg-light">
                                <a href="{{ ref.image.url }}" target="_blank">
                                    <img src="{{ ref.thumbnail.url }}" alt="Ref" style="object-fit: contain; width: 100%; height: 100%;" loading="lazy">
                                </a>
                            </div>
                            <form action="{% url 'delete_reference' ref.pk %}" method="post" class="position-absolute top-0 end-0 m-1">
                                {% csrf_token %}
                                <button type="button" class="btn btn-danger btn-sm p-0 d-flex align-items-center justify-content-center rounded-circle shadow-sm" 
                                        style="width: 20px; height: 20px; opacity: 0.9;" onclick="confirmDelete(event)" title="删除参考图">
                                    <i class="bi bi-x" style="font-size: 14px;"></i>
                                </button>
                            </form>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center text-muted small py-3 fst-italic">无参考图</div>
                        {% endfor %}
                    </div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-primary">Prompt (正向)</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('promptText', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('promptText', {{ group.pk }}, 'positive')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('promptText')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('promptText', this)" class="btn btn-sm btn-outline-primary rounded-pill px-3" {% if not group.prompt_text %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box" id="promptText">{% if group.prompt_text %}{{ group.prompt_text }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-success">中文/辅助提示词</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('promptTextZh', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('promptTextZh', {{ group.pk }}, 'positive_zh')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('promptTextZh')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('promptTextZh', this)" class="btn btn-sm btn-outline-success rounded-pill px-3" {% if not group.prompt_text_zh %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box" id="promptTextZh">{% if group.prompt_text_zh %}{{ group.prompt_text_zh }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-danger">Negative Prompt</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('negPrompt', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('negPrompt', {{ group.pk }}, 'negative')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('negPrompt')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('negPrompt', this)" class="btn btn-sm btn-outline-danger rounded-pill px-3" {% if not group.negative_prompt %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box" id="negPrompt">{% if group.negative_prompt %}{{ group.negative_prompt }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                {% if siblings %}
                <div class="card shadow-sm border-0 mb-4" style="background: rgba(230, 240, 255, 0.5);">
                    <div class="card-body">
                        <h6 class="card-title text-primary fw-bold mb-3">
                            <i class="bi bi-collection-fill me-2"></i>其他版本 ({{ siblings|length }})
                        </h6>
                        
                        <div class="d-flex flex-column gap-2">
                            {% for sib in siblings %}
                            <a href="{% url 'detail' sib.pk %}" class="d-flex align-items-center p-2 bg-white rounded border text-decoration-none shadow-sm position-relative hover-lift">
                                <div style="width: 48px; height: 48px; flex-shrink: 0; border-radius: 6px; overflow: hidden; background: #eee;">
                                    {% if sib.images.first %}
                                    <img src="{{ sib.images.first.thumbnail.url }}" class="w-100 h-100 object-fit-cover">
                                    {% else %}
                                    <div class="w-100 h-100 d-flex align-items-center justify-content-center text-muted"><i class="bi bi-image"></i></div>
                                    {% endif %}
                                </div>
                                
                                <div class="ms-3 overflow-hidden flex-grow-1">
                                    <div class="text-dark fw-bold text-truncate" style="font-size: 0.85rem;">
                                        {{ sib.model_info|default:"未知模型" }}
                                    </div>
                                    <div class="text-muted small text-truncate" style="font-size: 0.75rem;">
                                        {{ sib.created_at|date:"m-d H:i" }} · {{ sib.title }}
                                    </div>
                                </div>
                                
                                <i class="bi bi-chevron-right ms-2 text-muted small"></i>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-primary">Model Info / 参数</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('modelInfo', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt"><i class="bi bi-pencil me-1"></i>编辑</button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('modelInfo', {{ group.pk }}, 'model')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存"><i class="bi bi-check-lg"></i></button>
                                <button onclick="cancelEdit('modelInfo')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <button onclick="copyTextHandler('modelInfo', this)" class="btn btn-sm btn-outline-primary rounded-pill px-3" {% if not group.model_info %}disabled{% endif %}><i class="bi bi-clipboard me-1"></i>复制</button>
                        </div>
                    </div>
                    <div class="prompt-box mb-3" id="modelInfo">{% if group.model_info %}{{ group.model_info }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                    <div class="border-top pt-3">
                        <ul class="list-unstyled mb-0 text-secondary small">
                            <li class="d-flex align-items-center">
                                <i class="bi bi-calendar3 me-2 text-primary"></i>
                                <div><strong class="text-dark me-1">创建时间:</strong>{{ group.created_at|date:"Y-m-d H:i" }}</div>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addImagesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4" style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-dark">添加生成图</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-4">
                <form id="addImagesForm" action="{% url 'add_images' group.pk %}" method="post" enctype="multipart/form-data" onsubmit="handleImageUpload(event)">
                    {% csrf_token %}
                    
                    <div id="zone-modal-gen" class="upload-zone-modal">
                        <i class="bi bi-cloud-arrow-up"></i>
                        <p>点击或将图片拖拽至此 (生成图)</p>
                        <input type="file" name="new_images" id="input-modal-gen" multiple accept="image/*">
                    </div>

                    <div id="preview-modal-gen" class="preview-container-modal"></div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary rounded-pill fw-bold" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none;">
                            <i class="bi bi-cloud-upload me-2"></i>确认上传
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addReferenceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4" style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-dark">添加参考图</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-4">
                <form id="addReferenceForm" action="{% url 'add_references' group.pk %}" method="post" enctype="multipart/form-data" onsubmit="handleImageUpload(event)">
                    {% csrf_token %}
                    
                    <div id="zone-modal-ref" class="upload-zone-modal">
                        <i class="bi bi-images"></i>
                        <p>点击或将图片拖拽至此 (参考图)</p>
                        <input type="file" name="new_references" id="input-modal-ref" multiple accept="image/*">
                    </div>

                    <div id="preview-modal-ref" class="preview-container-modal"></div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-info text-white rounded-pill fw-bold border-0">
                            <i class="bi bi-cloud-upload me-2"></i>上传参考图
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 100vw; margin: 0;">
        <div class="modal-content border-0" style="background: transparent;">
            <div class="modal-body p-0 position-relative">
                <a href="#" id="modalDownloadBtn" download class="modal-download-btn"><i class="bi bi-download"></i> 下载原图</a>
                
                <button type="button" id="modalLikeBtn" class="modal-like-btn" onclick="toggleModalLike()">
                    <i class="bi bi-heart"></i> 喜欢
                </button>

                <form id="modalDeleteForm" method="post" class="delete-form-confirm">{% csrf_token %}<button type="button" class="modal-delete-btn" onclick="confirmDelete(event)"><i class="bi bi-trash3"></i> 删除此图</button></form>
                <button type="button" class="close-modal-btn" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i></button>
                <div class="nav-btn nav-prev" onclick="changeImage(-1)"><i class="bi bi-chevron-left"></i></div>
                <img src="" id="previewImage" alt="Preview">
                <div class="nav-btn nav-next" onclick="changeImage(1)"><i class="bi bi-chevron-right"></i></div>
                <div id="imageCounter" class="image-counter"></div>
            </div>
        </div>
    </div>
</div>

<button class="btn-float-tags d-none d-lg-flex" type="button" data-bs-toggle="offcanvas" data-bs-target="#tagsOffcanvas" aria-controls="tagsOffcanvas" title="更多标签分类">
    <i class="bi bi-grid-fill fs-5"></i>
</button>

<div class="offcanvas offcanvas-start rounded-end-4 border-0 shadow-lg" tabindex="-1" id="tagsOffcanvas" aria-labelledby="tagsOffcanvasLabel" style="width: 320px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);">
    <div class="offcanvas-header pt-4 ps-4">
        <h5 class="offcanvas-title fw-bold text-dark" id="tagsOffcanvasLabel">
            <i class="bi bi-collection-fill text-primary me-2"></i>全部分类
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body ps-4 pe-3">
        <p class="text-muted small mb-3">按标签筛选图片：</p>
        <div class="d-flex flex-wrap gap-2">
            {% for tag in tags_bar %}
                {% if tag.is_model != 1 %} 
                <a href="/?q={{ tag.name }}" 
                   class="drawer-tag {% if search_query == tag.name %}active{% endif %}">
                    {{ tag.name }}
                    <span class="count-badge">{{ tag.use_count }}</span>
                </a>
                {% endif %}
            {% endfor %}
        </div>
        
        {% if not tags_bar %}
        <div class="text-center text-muted py-5 small">
            暂无其他标签
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js"></script>

<script>
    const galleryImages = [
        {% for img in group.images.all %}
        { url: "{{ img.image.url }}", id: {{ img.pk }}, isLiked: {% if img.is_liked %}true{% else %}false{% endif %} },
        {% endfor %}
    ];
    /* 定位：gallery/templates/gallery/detail.html 底部 script */

    // 搜索框清除按钮逻辑
    function toggleSearchClearBtn() {
        const input = document.getElementById('navSearchInput');
        const btn = document.getElementById('navSearchClearBtn');
        if (input && btn) {
            if (input.value.length > 0 && document.activeElement === input) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        }
    }

    function hideSearchClearBtn() {
        const btn = document.getElementById('navSearchClearBtn');
        if (btn) btn.style.display = 'none';
    }

    function clearNavSearch() {
        const input = document.getElementById('navSearchInput');
        const btn = document.getElementById('navSearchClearBtn');
        if (input) {
            input.value = '';
            input.focus();
            btn.style.display = 'none';
        }
    }
</script>

<script src="{% static 'gallery/js/common.js' %}"></script>
<script src="{% static 'gallery/js/detail.js' %}"></script>

</body>
</html>