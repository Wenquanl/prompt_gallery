{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ group.title }} - 详情</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="{% static 'gallery/favicon.svg' %}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{% static 'gallery/style.css' %}">
    
    <style>
        /* ================== 详情页标签专属优化样式 ================== */
        
        /* 1. 灵动标签基础样式 */
        .tag-interactive {
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 50px;
            color: #555;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: default;
            user-select: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            position: relative;
            overflow: hidden;
            height: 32px;
        }

        .tag-interactive:hover {
            background: white;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 15px rgba(0,0,0,0.08);
            color: #2c3e50;
            border-color: white;
            padding-right: 12px;
        }

        .tag-interactive a {
            color: inherit;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .tag-interactive.model-tag {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(243, 232, 255, 0.9) 100%);
            border: 1px solid rgba(161, 140, 209, 0.3);
            color: #6a4c93;
            font-weight: 600;
        }
        .tag-interactive.model-tag:hover {
            background: linear-gradient(135deg, #fff 0%, #f3e8ff 100%);
            box-shadow: 0 5px 15px rgba(161, 140, 209, 0.25);
            border-color: rgba(161, 140, 209, 0.5);
        }

        /* 2. 删除按钮滑出动画 */
        .tag-remove-btn {
            width: 0;
            opacity: 0;
            transform: translateX(10px);
            margin-left: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #ff6b6b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .tag-interactive:hover .tag-remove-btn {
            width: 20px;
            opacity: 1;
            transform: translateX(0);
            margin-left: 8px;
        }
        
        .tag-remove-btn:hover {
            color: #ff4757;
            transform: scale(1.2);
        }

        /* 3. 添加按钮样式 (虚线圆环) */
        .btn-add-tag-dashed {
            width: 32px; height: 32px;
            border: 1.5px dashed #cbd5e1;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            color: #94a3b8;
            display: inline-flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(4px);
            flex-shrink: 0; 
        }
        .btn-add-tag-dashed:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: rotate(90deg);
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* 4. 输入框容器动画 */
        .tag-input-container {
            display: flex;
            align-items: center;
            overflow: hidden;
            width: 0;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            white-space: nowrap;
        }
        .tag-input-container.show {
            width: 220px;
            opacity: 1;
            margin-left: 8px;
        }

        .tag-input-line {
            border: none;
            border-bottom: 2px solid var(--accent-color);
            background: transparent;
            border-radius: 0;
            padding: 2px 5px;
            font-size: 0.85rem;
            color: var(--text-main);
            width: 100%;
            outline: none;
        }
        .tag-input-line::placeholder { color: #cbd5e1; font-size: 0.8rem; }

        /* 5. 确认添加按钮 */
        .btn-confirm-tag {
            width: 28px; height: 28px;
            border: none;
            border-radius: 50%;
            background: #20c997; 
            color: white;
            font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(32, 201, 151, 0.3);
            opacity: 0; transform: scale(0.5); 
        }
        .btn-confirm-tag:hover {
            background: #198754;
            transform: scale(1.1) !important;
        }
        .tag-input-container.show .btn-confirm-tag {
            opacity: 1; transform: scale(1); 
            transition-delay: 0.1s;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light navbar-glass">
    <div class="container position-relative">
        <a class="navbar-brand fw-bold text-dark" href="/">
            <i class="bi bi-stars text-primary me-2"></i>灵感图库
        </a>

        <div class="navbar-center d-none d-md-flex">
            <div class="nav-tabs-custom">
                <a href="{% url 'home' %}" class="nav-link-custom">全部</a>
                <a href="{% url 'home' %}?filter=liked" class="nav-link-custom">
                    <i class="bi bi-heart-fill me-1 text-danger"></i>喜欢
                </a>
                <a href="{% url 'liked_images_gallery' %}" class="nav-link-custom">
                    <i class="bi bi-images me-1 text-primary"></i>图墙
                </a>
            </div>
        </div>
        
        <div class="d-flex align-items-center gap-2 ms-auto">
            <div class="dropdown d-none d-lg-block">
                <button class="btn btn-sm rounded-pill nav-toolbox-btn d-flex align-items-center dropdown-toggle" 
                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-cpu-fill me-2"></i>AI 工具箱
                </button>
                <ul class="dropdown-menu toolbox-dropdown-menu">
                    <li><h6 class="toolbox-header">图像生成</h6></li>
                    <li><a class="dropdown-item toolbox-item" href="https://jimeng.jianying.com/" target="_blank"><i class="bi bi-palette2 text-danger"></i>即梦 AI</a></li>
                    <li><a class="dropdown-item toolbox-item" href="https://dreamina.capcut.com/ai-tool/home/" target="_blank"><i class="bi bi-magic text-warning"></i>Dreamina</a></li>
                    <li><hr class="toolbox-divider"></li>
                    <li><h6 class="toolbox-header">大语言模型</h6></li>
                    <li><a class="dropdown-item toolbox-item" href="https://gemini.google.com/" target="_blank"><i class="bi bi-google text-primary"></i>Google Gemini</a></li>
                    <li><a class="dropdown-item toolbox-item" href="https://aistudio.google.com/" target="_blank"><i class="bi bi-code-square text-info"></i>AI Studio</a></li>
                </ul>
            </div>
            
            <a href="{% url 'upload' %}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm rounded-pill px-4 py-2 btn-upload-nav shadow-sm d-flex align-items-center ms-1">
                <i class="bi bi-plus-lg me-1"></i>发布
            </a>
        </div>
    </div>
</nav>

<div class="container my-5">
    <div class="mb-4">
        {% with from_view=request.GET.from|default:'home' page_num=request.GET.page|default:'1' q_val=request.GET.q|default:'' filter_val=request.GET.filter|default:'' source_id=request.GET.source_img_id back_to_id=request.GET.back_to_detail_id %}
            
            {% if back_to_id %}
                <a href="{% url 'detail' back_to_id %}?from={{ from_view }}&page={{ page_num }}{% if q_val %}&q={{ q_val }}{% endif %}{% if filter_val %}&filter={{ filter_val }}{% endif %}{% if source_id %}&source_img_id={{ source_id }}{% endif %}" 
                   class="btn btn-light rounded-pill px-3 shadow-sm text-secondary" 
                   style="background: rgba(255,255,255,0.6); backdrop-filter: blur(5px); border: var(--glass-border);">
                    <i class="bi bi-arrow-left me-2"></i>返回
                </a>

            {% elif from_view == 'liked' %}
                <a href="{% url 'liked_images_gallery' %}?page={{ page_num }}{% if q_val %}&q={{ q_val }}{% endif %}{% if source_id %}#card-img-{{ source_id }}{% endif %}" 
                   class="btn btn-light rounded-pill px-3 shadow-sm text-secondary" 
                   style="background: rgba(255,255,255,0.6); backdrop-filter: blur(5px); border: var(--glass-border);">
                    <i class="bi bi-arrow-left me-2"></i>返回
                </a>

            {% else %}
                <a href="{% url 'home' %}?page={{ page_num }}{% if q_val %}&q={{ q_val }}{% endif %}{% if filter_val %}&filter={{ filter_val }}{% endif %}#group-card-{{ group.pk }}" 
                   class="btn btn-light rounded-pill px-3 shadow-sm text-secondary" 
                   style="background: rgba(255,255,255,0.6); backdrop-filter: blur(5px); border: var(--glass-border);">
                    <i class="bi bi-arrow-left me-2"></i>返回
                </a>
            {% endif %}

        {% endwith %}
    </div>

    <div class="row gx-lg-5">
        <div class="col-lg-8 mb-5 mb-lg-0">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h2 class="fw-bold text-dark mb-0">{{ group.title }}</h2>
                <button type="button" class="btn btn-primary rounded-pill px-3 shadow-sm btn-sm d-flex align-items-center" 
                        data-bs-toggle="modal" data-bs-target="#addImagesModal"
                        style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none;">
                    <i class="bi bi-plus-lg me-1"></i>添加生成图
                </button>
            </div>
            
            <div class="mb-4 d-flex flex-wrap align-items-center gap-2" id="tagsContainer" style="min-height: 40px;">
                {% for tag in sorted_tags %}
                    <span class="tag-interactive {% if tag.name == group.model_info %}model-tag{% endif %}" id="tag-pill-{{ tag.id }}">
                        {% if tag.name == group.model_info %}<i class="bi bi-robot me-1"></i>{% endif %}
                        <a href="/?q={{ tag.name }}">{{ tag.name }}</a>
                        
                        <span class="tag-remove-btn" onclick="removeTag({{ group.pk }}, {{ tag.id }}, '{{ tag.name|escapejs }}')" title="移除">
                            <i class="bi bi-x-circle-fill"></i>
                        </span>
                    </span>
                {% endfor %}
                
                <div class="d-flex align-items-center">
                    <button class="btn-add-tag-dashed" id="btnAddTag" onclick="showTagInput()" title="添加标签">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    
                    <div class="tag-input-container" id="tagInputContainer">
                        <input type="text" class="tag-input-line" id="newTagInput" 
                               placeholder="输入标签..." list="availableTags" 
                               onkeydown="handleTagKey(event, {{ group.pk }})">
                        
                        <button class="btn-confirm-tag" type="button" onclick="addTag({{ group.pk }})" title="确认添加">
                            <i class="bi bi-check-lg"></i>
                        </button>

                        <datalist id="availableTags">
                            {% for t in all_tags %}
                                <option value="{{ t.name }}">
                            {% endfor %}
                        </datalist>
                    </div>
                </div>
            </div>

            <div id="detail-masonry-grid" class="row">
                {% for img in group.images.all %}
                <div class="grid-item mb-3" id="img-anchor-{{ img.pk }}">
                    <div class="detail-img-card shadow-sm position-relative" id="img-card-{{ img.pk }}">
                        <div class="position-relative" role="button" onclick="showModal({{ forloop.counter0 }})">
                            <img src="{{ img.thumbnail.url }}" class="thumb-img" alt="AI Artwork" loading="lazy">
                            <div class="hover-overlay"><i class="bi bi-zoom-in text-white fs-2"></i></div>
                        </div>
                        <div class="img-action-bar">
                            <button type="button" class="action-btn like {% if img.is_liked %}active{% endif %}" 
                                    id="like-btn-{{ img.pk }}"
                                    title="喜欢" onclick="toggleImageLike(event, {{ img.pk }})">
                                <i class="bi {% if img.is_liked %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                            </button>
                            <a href="{{ img.image.url }}" download class="action-btn download" title="下载原图"><i class="bi bi-download"></i></a>
                            <form action="{% url 'delete_image' img.pk %}" method="post" class="delete-form-confirm" style="display:inline;">
                                {% csrf_token %}
                                <button type="button" class="action-btn delete" title="删除图片" onclick="confirmDelete(event)"><i class="bi bi-trash3-fill"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12"><div class="alert alert-light border text-center py-5 text-muted rounded-3" style="background: rgba(255,255,255,0.5)"><i class="bi bi-image fs-1 d-block mb-3 opacity-50"></i>暂无图片</div></div>
                {% endfor %}
            </div>

            {% if related_groups %}
            <div class="mt-5 pt-4 border-top border-light">
                <h4 class="mb-4 fw-bold text-secondary"><i class="bi bi-stars text-primary me-2"></i>猜你喜欢</h4>
                <div class="horizontal-scroll-wrapper" id="horizontal-scroll">
                    {% for related in related_groups %}
                    <div class="horizontal-card-item">
                        <div class="gallery-card h-100 d-block position-relative group-card-container">
                            <a href="{% url 'detail' related.pk %}?back_to_detail_id={{ group.pk }}&from={{ request.GET.from|default:'home' }}&page={{ request.GET.page|default:'1' }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.filter %}&filter={{ request.GET.filter }}{% endif %}{% if request.GET.source_img_id %}&source_img_id={{ request.GET.source_img_id }}{% endif %}" 
                               class="text-decoration-none text-dark">
                                <div class="horizontal-img-wrapper">
                                    {% with cover=related.images.first %}
                                        {% if cover %}
                                            <img src="{{ cover.thumbnail.url }}" alt="{{ related.title }}" loading="lazy">
                                        {% else %}
                                            <div class="d-flex align-items-center justify-content-center h-100 w-100 text-secondary bg-light bg-opacity-50">
                                                <i class="bi bi-image fs-1 opacity-50"></i>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="card-body p-2">
                                    <h6 class="card-title text-truncate mb-1 small">{{ related.title }}</h6>
                                    <p class="text-muted small mb-0 text-truncate">{{ related.prompt_text }}</p>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4 ps-lg-4">
            <div class="sticky-sidebar">
                <div class="prompt-card p-4 border-danger border-opacity-25 mb-4" style="background: rgba(255, 230, 230, 0.4);">
                    <div class="section-header mb-2"><span class="section-label text-danger">管理操作</span></div>
                    <form action="{% url 'delete_group' group.pk %}" method="post" class="delete-form-confirm">
                        {% csrf_token %}
                        <button type="button" class="btn btn-danger w-100 rounded-pill btn-sm" onclick="confirmDelete(event)">
                            <i class="bi bi-trash3 me-2"></i>永久删除整个作品
                        </button>
                    </form>
                </div>

                <div class="prompt-card p-4">
                   <div class="section-header mb-3"><span class="section-label">快速跳转创作</span></div>
                   <div class="platform-links d-grid gap-2">
                       <a href="https://jimeng.jianying.com/" target="_blank" class="btn btn-platform rounded-pill"><i class="bi bi-palette me-2 text-danger"></i>前往 即梦AI</a>
                       <a href="https://dreamina.capcut.com/ai-tool/home/" target="_blank" class="btn btn-platform rounded-pill"><i class="bi bi-magic me-2 text-warning"></i>前往 Dreamina</a>
                       <a href="https://gemini.google.com/" target="_blank" class="btn btn-platform rounded-pill"><i class="bi bi-google me-2 text-primary"></i>前往 Gemini</a>
                       <a href="https://aistudio.google.com/" target="_blank" class="btn btn-platform rounded-pill"><i class="bi bi-code-square me-2 text-info"></i>前往 AI Studio</a>
                   </div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header mb-3 d-flex justify-content-between align-items-center">
                        <span class="section-label text-info">参考图 (References)</span>
                        <button class="btn btn-sm btn-outline-info rounded-circle" style="width:24px; height:24px; padding:0;" 
                                data-bs-toggle="modal" data-bs-target="#addReferenceModal" title="添加参考图">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    
                    <div class="row row-cols-3 g-2">
                        {% for ref in group.references.all %}
                        <div class="col position-relative">
                            <div class="ratio ratio-1x1 rounded overflow-hidden border bg-light">
                                <a href="{{ ref.image.url }}" target="_blank">
                                    <img src="{{ ref.thumbnail.url }}" alt="Ref" style="object-fit: contain; width: 100%; height: 100%;" loading="lazy">
                                </a>
                            </div>
                            <form action="{% url 'delete_reference' ref.pk %}" method="post" class="position-absolute top-0 end-0 m-1">
                                {% csrf_token %}
                                <button type="button" class="btn btn-danger btn-sm p-0 d-flex align-items-center justify-content-center rounded-circle shadow-sm" 
                                        style="width: 20px; height: 20px; opacity: 0.9;" onclick="confirmDelete(event)" title="删除参考图">
                                    <i class="bi bi-x" style="font-size: 14px;"></i>
                                </button>
                            </form>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center text-muted small py-3 fst-italic">
                            无参考图
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-primary">Prompt (正向)</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('promptText', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt">
                                <i class="bi bi-pencil me-1"></i>编辑
                            </button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('promptText', {{ group.pk }}, 'positive')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button onclick="cancelEdit('promptText')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <button onclick="copyText('promptText', this)" class="btn btn-sm btn-outline-primary rounded-pill px-3" {% if not group.prompt_text %}disabled{% endif %}>
                                <i class="bi bi-clipboard me-1"></i>复制
                            </button>
                        </div>
                    </div>
                    <div class="prompt-box" id="promptText">{% if group.prompt_text %}{{ group.prompt_text }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-success">中文/辅助提示词</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('promptTextZh', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt">
                                <i class="bi bi-pencil me-1"></i>编辑
                            </button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('promptTextZh', {{ group.pk }}, 'positive_zh')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button onclick="cancelEdit('promptTextZh')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <button onclick="copyText('promptTextZh', this)" class="btn btn-sm btn-outline-success rounded-pill px-3" {% if not group.prompt_text_zh %}disabled{% endif %}>
                                <i class="bi bi-clipboard me-1"></i>复制
                            </button>
                        </div>
                    </div>
                    <div class="prompt-box" id="promptTextZh">{% if group.prompt_text_zh %}{{ group.prompt_text_zh }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header">
                        <span class="section-label text-danger">Negative Prompt</span>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="enableEdit('negPrompt', this)" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-edit-prompt">
                                <i class="bi bi-pencil me-1"></i>编辑
                            </button>
                            <div class="edit-actions" style="display:none;">
                                <button onclick="savePrompt('negPrompt', {{ group.pk }}, 'negative')" class="btn btn-sm btn-success rounded-pill px-3 me-1" title="保存">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button onclick="cancelEdit('negPrompt')" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="取消">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <button onclick="copyText('negPrompt', this)" class="btn btn-sm btn-outline-danger rounded-pill px-3" {% if not group.negative_prompt %}disabled{% endif %}>
                                <i class="bi bi-clipboard me-1"></i>复制
                            </button>
                        </div>
                    </div>
                    <div class="prompt-box" id="negPrompt">{% if group.negative_prompt %}{{ group.negative_prompt }}{% else %}<span class="empty-text">未填写</span>{% endif %}</div>
                </div>

                <div class="prompt-card p-4">
                    <div class="section-header mb-3"><span class="section-label">Model Info</span></div>
                    <ul class="list-unstyled mb-0 text-secondary small">
                        <li class="mb-3 d-flex align-items-start"><i class="bi bi-cpu me-2 mt-1 text-primary"></i><div><strong class="d-block text-dark">模型/参数</strong><span class="text-muted">{{ group.model_info|default:"<span class='empty-text'>未填写</span>" }}</span></div></li>
                        <li class="d-flex align-items-center"><i class="bi bi-calendar3 me-2 text-primary"></i><div><strong class="text-dark me-1">创建时间:</strong>{{ group.created_at|date:"Y-m-d H:i" }}</div></li>
                    </ul>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addImagesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4" style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
            <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold text-dark">添加生成图</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body pt-4">
                <form id="addImagesForm" action="{% url 'add_images' group.pk %}" method="post" enctype="multipart/form-data" onsubmit="handleImageUpload(event)">
                    {% csrf_token %}
                    <div class="mb-4"><label class="form-label small text-muted text-uppercase fw-bold ls-1">选择图片 (支持多选)</label><input type="file" name="new_images" class="form-control" multiple required accept="image/*"></div>
                    <div class="d-grid"><button type="submit" class="btn btn-primary rounded-pill fw-bold" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none;"><i class="bi bi-cloud-upload me-2"></i>开始上传</button></div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addReferenceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4" style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
            <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold text-dark">添加参考图</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body pt-4"><form action="{% url 'add_references' group.pk %}" method="post" enctype="multipart/form-data">{% csrf_token %}<div class="mb-4"><label class="form-label small text-muted text-uppercase fw-bold ls-1">选择参考图 (支持多选)</label><input type="file" name="new_references" class="form-control" multiple required accept="image/*"></div><div class="d-grid"><button type="submit" class="btn btn-info text-white rounded-pill fw-bold border-0"><i class="bi bi-cloud-upload me-2"></i>上传参考图</button></div></form></div>
        </div>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 100vw; margin: 0;">
        <div class="modal-content border-0" style="background: transparent;">
            <div class="modal-body p-0 position-relative">
                <a href="#" id="modalDownloadBtn" download class="modal-download-btn"><i class="bi bi-download"></i> 下载原图</a>
                
                <button type="button" id="modalLikeBtn" class="modal-like-btn" onclick="toggleModalLike()">
                    <i class="bi bi-heart"></i> 喜欢
                </button>

                <form id="modalDeleteForm" method="post" class="delete-form-confirm">{% csrf_token %}<button type="button" class="modal-delete-btn" onclick="confirmDelete(event)"><i class="bi bi-trash3"></i> 删除此图</button></form>
                <button type="button" class="close-modal-btn" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i></button>
                <div class="nav-btn nav-prev" onclick="changeImage(-1)"><i class="bi bi-chevron-left"></i></div>
                <img src="" id="previewImage" alt="Preview">
                <div class="nav-btn nav-next" onclick="changeImage(1)"><i class="bi bi-chevron-right"></i></div>
                <div id="imageCounter" class="image-counter"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js"></script>

<script>
    const galleryImages = [
        {% for img in group.images.all %}
        { url: "{{ img.image.url }}", id: {{ img.pk }}, isLiked: {% if img.is_liked %}true{% else %}false{% endif %} },
        {% endfor %}
    ];
</script>
<script>
let currentIndex = 0;
let imageModal = null; 

document.addEventListener('DOMContentLoaded', function() {
    const modalEl = document.getElementById('imageModal');
    if (modalEl) {
        imageModal = new bootstrap.Modal(modalEl);
    }
    
    var grid = document.querySelector('#detail-masonry-grid');
    if (grid) {
        var msnry = new Masonry(grid, { itemSelector: '.grid-item', percentPosition: true });
        
        imagesLoaded(grid).on('progress', function(instance, image) { 
            msnry.layout(); 
        }).on('done', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const highlightId = urlParams.get('highlight');
            if (highlightId) {
                const targetAnchor = document.getElementById(`img-anchor-${highlightId}`);
                const targetCard = document.getElementById(`img-card-${highlightId}`);
                if (targetAnchor && targetCard) {
                    setTimeout(() => {
                        targetAnchor.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetCard.classList.add('highlight-pulse');
                    }, 300);
                }
            }
        });
    }

    var hScroll = document.querySelector('#horizontal-scroll');
    if(hScroll) {
        imagesLoaded(hScroll).on('progress', function(instance, image) {});
    }

    document.addEventListener('keydown', function(event) {
        if (modalEl && modalEl.classList.contains('show')) {
            if (event.key === 'ArrowLeft') changeImage(-1);
            if (event.key === 'ArrowRight') changeImage(1);
            if (event.key === 'Escape') imageModal.hide();
        }
    });
    
    // 全局点击监听，处理标签输入框自动收起（如果点击了外部）
    document.addEventListener('click', function(event) {
        const container = document.getElementById('tagInputContainer');
        const addBtn = document.getElementById('btnAddTag');
        if (container.classList.contains('show')) {
            // 如果点击的不是输入框内部、也不是添加按钮
            if (!container.contains(event.target) && !addBtn.contains(event.target)) {
                // 只有当输入框为空时才收起，防止用户输入一半误点外面
                if (!document.getElementById('newTagInput').value.trim()) {
                    resetTagInput();
                }
            }
        }
    });
});

function handleImageUpload(event) {
    event.preventDefault(); 
    
    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    const originalBtnContent = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>上传并校验中...';
    submitBtn.disabled = true;

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.innerHTML = originalBtnContent;
        submitBtn.disabled = false;

        if (data.status === 'success') {
            window.location.reload();
        } else if (data.status === 'warning') {
            const uploadModalEl = document.getElementById('addImagesModal');
            const uploadModal = bootstrap.Modal.getInstance(uploadModalEl);
            uploadModal.hide();

            let listItems = '';
            data.duplicates.forEach(dup => {
                listItems += `
                    <div class="duplicate-item">
                        <img src="${dup.existing_url}" class="duplicate-alert-img">
                        <div class="duplicate-text-content">
                            <div class="duplicate-filename" title="${dup.name}">${dup.name}</div>
                            <div class="duplicate-source">
                                已存在于：<strong>《${dup.existing_group_title}》</strong>
                            </div>
                            <div class="duplicate-badge"><i class="bi bi-shield-fill-x me-1"></i>已拦截重复上传</div>
                        </div>
                    </div>
                `;
            });

            const duplicateHtml = `
                <div class="text-start mb-2 text-muted small">以下图片因重复而被系统自动拦截：</div>
                <div class="duplicate-scroll-container">
                    ${listItems}
                </div>
                <div class="text-end text-muted small mt-2">
                    成功上传: <span class="text-success fw-bold">${data.uploaded_count}</span> 张 
                    / 拦截: <span class="text-danger fw-bold">${data.duplicates.length}</span> 张
                </div>
            `;

            Swal.fire({
                title: `<span class="text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>重复拦截报告</span>`,
                html: duplicateHtml,
                icon: null,
                confirmButtonText: '知道了',
                confirmButtonColor: '#2c3e50',
                width: '600px',
                background: '#fff',
                customClass: { popup: 'rounded-4 shadow-lg border-0' }
            }).then(() => {
                if (data.uploaded_count > 0) {
                    window.location.reload();
                }
            });
        } else {
            Swal.fire({ icon: 'error', title: '上传失败', text: '请重试' });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        submitBtn.innerHTML = originalBtnContent;
        submitBtn.disabled = false;
        Swal.fire({ icon: 'error', title: '网络错误', text: '无法连接到服务器' });
    });
}

function showModal(index) {
    currentIndex = index;
    updateModalImage();
    imageModal.show();
}

function changeImage(direction) {
    currentIndex += direction;
    if (currentIndex >= galleryImages.length) { currentIndex = 0; } 
    else if (currentIndex < 0) { currentIndex = galleryImages.length - 1; }
    updateModalImage();
}

function updateModalImage() {
    const imgElement = document.getElementById('previewImage');
    const downloadBtn = document.getElementById('modalDownloadBtn');
    const deleteForm = document.getElementById('modalDeleteForm');
    const counterElement = document.getElementById('imageCounter');
    const likeBtn = document.getElementById('modalLikeBtn');

    const currentImgData = galleryImages[currentIndex];

    imgElement.style.opacity = '0.5';
    imgElement.src = currentImgData.url;
    imgElement.onload = function() { imgElement.style.opacity = '1'; };

    if (downloadBtn) { downloadBtn.href = currentImgData.url; }
    if (deleteForm) { deleteForm.action = `/delete-image/${currentImgData.id}/`; }
    if (counterElement) { counterElement.innerText = `${currentIndex + 1} / ${galleryImages.length}`; }
    
    if (likeBtn) {
        if (currentImgData.isLiked) {
            likeBtn.classList.add('active');
            likeBtn.innerHTML = '<i class="bi bi-heart-fill"></i> 已喜欢';
        } else {
            likeBtn.classList.remove('active');
            likeBtn.innerHTML = '<i class="bi bi-heart"></i> 喜欢';
        }
    }
}

function toggleModalLike() {
    const currentImgData = galleryImages[currentIndex];
    fetch(`/toggle-like-image/${currentImgData.id}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            currentImgData.isLiked = data.is_liked;
            updateModalImage(); 
            const listBtn = document.getElementById(`like-btn-${currentImgData.id}`);
            if (listBtn) {
                const icon = listBtn.querySelector('i');
                if (data.is_liked) {
                    listBtn.classList.add('active');
                    icon.classList.remove('bi-heart'); icon.classList.add('bi-heart-fill');
                } else {
                    listBtn.classList.remove('active');
                    icon.classList.remove('bi-heart-fill'); icon.classList.add('bi-heart');
                }
            }
        }
    });
}

function toggleImageLike(event, pk) {
    event.stopPropagation(); 
    const btn = event.currentTarget;
    const icon = btn.querySelector('i');
    
    fetch(`/toggle-like-image/${pk}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (data.is_liked) {
                btn.classList.add('active');
                icon.classList.remove('bi-heart'); icon.classList.add('bi-heart-fill');
            } else {
                btn.classList.remove('active');
                icon.classList.remove('bi-heart-fill'); icon.classList.add('bi-heart');
            }
            const imgData = galleryImages.find(img => img.id === pk);
            if (imgData) { imgData.isLiked = data.is_liked; }
        }
    });
}

function confirmDelete(event) {
    event.preventDefault(); 
    const form = event.target.closest('form');
    Swal.fire({
        title: '确定要删除吗？',
        text: "此操作无法撤销！文件将被永久删除。",
        icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', cancelButtonColor: '#6c757d', confirmButtonText: '是的，彻底删除', cancelButtonText: '取消',
        background: 'rgba(255, 255, 255, 0.95)', backdrop: `rgba(0,0,0,0.4)`, customClass: { popup: 'rounded-4 shadow-lg border-0' }
    }).then((result) => { if (result.isConfirmed) form.submit(); })
}

function enableEdit(elementId, editBtn) {
    const box = document.getElementById(elementId);
    if (box.querySelector('.empty-text')) {
        box.dataset.wasEmpty = 'true';
        box.innerText = ''; 
    } else {
        box.dataset.originalText = box.innerText; 
    }
    box.contentEditable = "true";
    box.focus();
    editBtn.style.display = 'none';
    const actionsDiv = editBtn.nextElementSibling;
    if (actionsDiv && actionsDiv.classList.contains('edit-actions')) {
        actionsDiv.style.display = 'block';
    }
}

function cancelEdit(elementId) {
    const box = document.getElementById(elementId);
    if (box.dataset.wasEmpty === 'true') {
        box.innerHTML = '<span class="empty-text">未填写</span>';
    } else if (box.dataset.originalText !== undefined) {
        box.innerText = box.dataset.originalText;
    }
    box.contentEditable = "false";
    delete box.dataset.originalText;
    delete box.dataset.wasEmpty;
    toggleEditButtons(box, false);
}

function savePrompt(elementId, pk, type) {
    const box = document.getElementById(elementId);
    const newText = box.innerText;
    const data = {};
    if (type === 'positive') { data.prompt_text = newText; }
    else if (type === 'positive_zh') { data.prompt_text_zh = newText; } // 新增逻辑
    else { data.negative_prompt = newText; }

    fetch(`/update-prompts/${pk}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(res => {
        if (res.status === 'success') {
            box.contentEditable = "false";
            // 更新复制按钮状态
            const copyBtn = box.parentElement.querySelector('.btn-outline-primary, .btn-outline-danger, .btn-outline-success');
            if (copyBtn) copyBtn.disabled = !newText.trim();
            if (!newText.trim()) { box.innerHTML = '<span class="empty-text">未填写</span>'; }
            toggleEditButtons(box, false);
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 1500,
                background: 'rgba(255, 255, 255, 0.95)'
            });
            Toast.fire({ icon: 'success', title: '保存成功' });
        } else {
            alert('保存失败: ' + res.message);
        }
    })
    .catch(err => { console.error(err); alert('网络错误，请重试'); });
}

function toggleEditButtons(boxElement, isEditing) {
    const header = boxElement.parentElement.querySelector('.section-header');
    const editBtn = header.querySelector('.btn-edit-prompt');
    const actionsDiv = header.querySelector('.edit-actions');
    if (isEditing) {
        editBtn.style.display = 'none';
        actionsDiv.style.display = 'block';
    } else {
        editBtn.style.display = 'inline-block';
        actionsDiv.style.display = 'none';
    }
}

function copyText(elementId, btnElement) {
    const textElement = document.getElementById(elementId);
    if (textElement.querySelector('.empty-text')) return;
    navigator.clipboard.writeText(textElement.innerText).then(() => {
        const originalHTML = btnElement.innerHTML;
        const isPrimary = btnElement.classList.contains('btn-outline-primary');
        const isDanger = btnElement.classList.contains('btn-outline-danger');
        
        // 处理不同颜色的按钮
        let originalClass;
        if (isPrimary) originalClass = 'btn-outline-primary';
        else if (isDanger) originalClass = 'btn-outline-danger';
        else originalClass = 'btn-outline-success';

        btnElement.innerHTML = '<i class="bi bi-check-lg me-1"></i>已复制';
        btnElement.classList.remove(originalClass); btnElement.classList.add('btn-success', 'text-white');
        setTimeout(() => {
            btnElement.innerHTML = originalHTML;
            btnElement.classList.remove('btn-success', 'text-white'); btnElement.classList.add(originalClass);
        }, 2000);
    });
}

// ----------------- 标签交互逻辑 (已优化) -----------------

function showTagInput() {
    document.getElementById('btnAddTag').style.display = 'none';
    const container = document.getElementById('tagInputContainer');
    container.classList.add('show');
    const input = document.getElementById('newTagInput');
    setTimeout(() => input.focus(), 100);
}

function handleTagKey(event, groupPk) {
    if (event.key === 'Enter') {
        event.preventDefault();
        addTag(groupPk);
    } else if (event.key === 'Escape') {
        resetTagInput();
    }
}

function resetTagInput() {
    const container = document.getElementById('tagInputContainer');
    container.classList.remove('show');
    document.getElementById('newTagInput').value = '';
    setTimeout(() => {
        document.getElementById('btnAddTag').style.display = 'inline-flex';
    }, 300);
}

function addTag(groupPk) {
    const input = document.getElementById('newTagInput');
    const tagName = input.value.trim();
    if (!tagName) { 
        input.focus(); 
        return; 
    }

    fetch(`/add-tag/${groupPk}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ tag_name: tagName })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            const newTagHtml = `
                <span class="tag-interactive" id="tag-pill-${data.tag_id}">
                    <a href="/?q=${data.tag_name}">${data.tag_name}</a>
                    <span class="tag-remove-btn" onclick="removeTag(${groupPk}, ${data.tag_id}, '${data.tag_name}')" title="移除">
                        <i class="bi bi-x-circle-fill"></i>
                    </span>
                </span>
            `;
            // 插入到添加按钮之前
            document.getElementById('btnAddTag').parentNode.insertAdjacentHTML('beforebegin', newTagHtml);
            input.value = '';
            input.focus();
        } else {
            Swal.fire({ icon: 'error', title: '添加失败', text: data.message });
        }
    })
    .catch(err => Swal.fire({ icon: 'error', title: '错误', text: '网络请求失败' }));
}

function removeTag(groupPk, tagId, tagName) {
    Swal.fire({
        title: '移除标签?',
        text: `确定要移除 "${tagName}" 吗？`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ff4757',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '是的, 移除',
        cancelButtonText: '取消',
        background: 'rgba(255, 255, 255, 0.95)',
        customClass: { popup: 'rounded-4 shadow-lg border-0' }
    }).then((result) => {
        if (result.isConfirmed) {
            performRemoveTag(groupPk, tagId);
        }
    });
}

function performRemoveTag(groupPk, tagId) {
    fetch(`/remove-tag/${groupPk}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ tag_id: tagId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            const el = document.getElementById(`tag-pill-${tagId}`);
            if (el) {
                el.style.transform = 'scale(0.8)';
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 300);
            }
        } else {
            Swal.fire({ icon: 'error', title: '移除失败', text: data.message });
        }
    });
}
</script>
</body>
</html>