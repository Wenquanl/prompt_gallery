{% extends 'gallery/base.html' %}
{% load static %}

{% block title %}AI 创作室 - Prompt Gallery{% endblock %}

{% block extra_css %}
<style>
    body { background-color: #f8f9fa; }
    
    /* 左侧控制台样式 */
    .control-panel {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        padding: 24px;
        height: calc(100vh - 100px); /* 减去导航栏高度 */
        overflow-y: auto;
    }

    /* 拖拽上传区样式 */
    .drag-drop-zone {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 30px 20px;
        text-align: center;
        background: #fdfdfd;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    .drag-drop-zone:hover, .drag-drop-zone.dragover {
        border-color: #8a2be2;
        background: #f6f0ff;
    }
    .drag-drop-zone i { font-size: 2rem; color: #adb5bd; transition: color 0.3s ease; }
    .drag-drop-zone:hover i { color: #8a2be2; }
    
    /* 隐藏原生文件输入框 */
    #file-input-hidden { display: none; }

    /* 缩略图预览区 */
    #preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .preview-item {
        width: 60px; height: 60px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid #ddd;
    }

    /* 右侧画板区样式 */
    .canvas-panel {
        background: #e9ecef;
        border-radius: 16px;
        height: calc(100vh - 100px);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }
    
    .canvas-placeholder {
        text-align: center;
        color: #adb5bd;
    }
    .canvas-placeholder i { font-size: 4rem; opacity: 0.5; }

    /* 生成结果图 */
    #result-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    /* 生成中的扫描动画光效 */
    .scanning-effect {
        display: none;
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(to bottom, rgba(138,43,226,0) 0%, rgba(138,43,226,0.1) 50%, rgba(138,43,226,0) 100%);
        background-size: 100% 200%;
        animation: scan 2s linear infinite;
        z-index: 10;
    }
    @keyframes scan {
        0% { background-position: 0 -100%; }
        100% { background-position: 0 100%; }
    }

    /* === 优化后的模型选择卡片样式 === */
    .model-category-tabs .nav-link {
        border-radius: 30px;
        color: #6c757d;
        font-weight: 600;
        padding: 8px 16px;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    .model-category-tabs .nav-link.active {
        background-color: #8a2be2;
        color: white;
        box-shadow: 0 4px 10px rgba(138, 43, 226, 0.3);
    }
    .model-category-tabs .nav-link:hover:not(.active) {
        border-color: #dee2e6;
        background-color: #f8f9fa;
    }
    
    .model-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        background: #fff;
    }
    .model-card:hover {
        border-color: #bfa3ed;
        background: #faf8ff;
        transform: translateY(-2px);
    }
    .model-card.active {
        border-color: #8a2be2;
        background: #f4ecff;
        box-shadow: 0 4px 12px rgba(138, 43, 226, 0.15);
    }
    .model-card-title {
        font-weight: 700;
        font-size: 0.95rem;
        color: #343a40;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .model-card-desc {
        font-size: 0.75rem;
        color: #6c757d;
        margin: 0;
        line-height: 1.3;
    }
    .model-card.active .model-card-title { color: #8a2be2; }
    .model-card.active .check-icon { display: block !important; color: #8a2be2; }
    /* === 高级自定义滑动条 (Range) 样式 === */
    .custom-range-slider {
        -webkit-appearance: none; /* 隐藏原生样式 */
        appearance: none;
        width: 100%;
        height: 6px;
        background: #dee2e6; /* 未填充部分的灰色底色 */
        background-image: linear-gradient(#8a2be2, #8a2be2); /* 已填充部分的紫色 */
        background-repeat: no-repeat;
        border-radius: 5px;
        outline: none;
        margin-top: 5px;
        margin-bottom: 10px;
    }
    
    /* 滑块本体 (Webkit 内核如 Chrome, Edge, Safari) */
    .custom-range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #8a2be2;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(138, 43, 226, 0.4);
        border: 3px solid #fff; /* 加一个白边让它看起来更精致 */
        transition: transform 0.15s ease-in-out;
    }
    
    /* 滑块本体 (Firefox) */
    .custom-range-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #8a2be2;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(138, 43, 226, 0.4);
        border: 3px solid #fff;
        transition: transform 0.15s ease-in-out;
    }

    /* 悬浮时的微微放大效果 */
    .custom-range-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }
    .custom-range-slider::-moz-range-thumb:hover {
        transform: scale(1.2);
    }
    /* 缩略图包装器 (为了相对定位删除按钮) */
    .preview-wrapper {
        position: relative;
        display: inline-block;
    }

    /* 删除按钮样式 */
    .btn-remove-preview {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #dc3545; /* Bootstrap 的危险红色 */
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: transform 0.2s ease, background 0.2s;
        z-index: 10;
    }
    
    .btn-remove-preview:hover {
        transform: scale(1.15);
        background: #bb2d3b;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-4">
    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="control-panel custom-scrollbar">
                <h4 class="fw-bold mb-4"><i class="bi bi-sliders me-2" style="color:#8a2be2;"></i>创作控制台</h4>
                
                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary small">1. 核心模型引擎</label>
                    <input type="hidden" id="ai-model-select" value="">
                    <input type="hidden" id="ai-category-select" value="">
                    
                    <ul class="nav nav-pills nav-fill mb-3 model-category-tabs" id="dynamic-category-tabs" role="tablist"></ul>
                    <div class="tab-content" id="dynamic-model-cards"></div>
                </div>

                <div class="mb-4" id="ai-image-upload-block" style="display: none;">
                    <label class="form-label fw-bold text-secondary small d-flex justify-content-between">
                        <span>2. 上传参考图</span>
                        <span id="ai-img-help" class="text-primary" style="font-size: 0.8rem;"></span>
                    </label>
                    <div class="drag-drop-zone" id="drop-zone" onclick="document.getElementById('file-input-hidden').click()">
                        <i class="bi bi-cloud-arrow-up mb-2 d-block"></i>
                        <span class="text-muted fw-bold">点击选择，或将图片拖拽至此</span>
                    </div>
                    <input type="file" id="file-input-hidden" accept="image/*" onchange="handleFiles(this.files)">
                    <div id="preview-container"></div>
                </div>

                <div class="mb-4" id="dynamic-params-container"></div>

                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary small">3. 画面描述 (Prompt)</label>
                    <textarea id="ai-prompt" class="form-control" rows="6" placeholder="详细描述你想要的画面，建议使用英文。"></textarea>
                </div>

                <button id="btn-generate" class="btn btn-primary w-100 rounded-pill py-3 fw-bold fs-5 shadow-sm" style="background: linear-gradient(135deg, #8a2be2 0%, #4a00e0 100%); border:none;" onclick="startGeneration()">
                    <i class="bi bi-stars me-2"></i>开始生成
                </button>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="canvas-panel">
                <div class="canvas-placeholder" id="canvas-idle">
                    <i class="bi bi-palette"></i>
                    <h3 class="mt-3 fw-bold">你的创意画布</h3>
                    <p>在左侧调整参数并点击生成，在此见证奇迹。</p>
                </div>

                <div class="scanning-effect" id="canvas-scanning"></div>
                
                <div id="canvas-loading" style="display: none; position: absolute; z-index: 11; text-align: center;">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                    <h5 class="mt-3 fw-bold text-dark" style="text-shadow: 0 0 10px white;">正在向云端请求算力，请耐心等待...</h5>
                </div>

                <img id="result-image" src="" alt="Generated Result">
                
                <div id="result-actions" style="display:none; position:absolute; bottom:30px; background:rgba(255,255,255,0.9); backdrop-filter:blur(5px); padding:10px 20px; border-radius:30px; box-shadow:0 5px 15px rgba(0,0,0,0.1);">
                    <span class="text-success fw-bold"><i class="bi bi-check-circle-fill me-1"></i> 已成功保存至本地目录!</span>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. 获取后端传来的超级配置对象
    const AI_CONFIG = JSON.parse('{{ ai_config_json|safe }}');
    let currentFiles = []; 
    let maxImagesAllowed = 0;

    document.addEventListener('DOMContentLoaded', () => {
        initDynamicUI();
        setupDragAndDrop();
    });

    // === 核心渲染引擎：根据后端配置生成 UI ===
    function initDynamicUI() {
        const tabsContainer = document.getElementById('dynamic-category-tabs');
        const cardsContainer = document.getElementById('dynamic-model-cards');
        
        // 遍历生成 Tabs 和 对应的面板
        AI_CONFIG.categories.forEach((cat, index) => {
            const isActive = index === 0 ? 'active' : '';
            
            // 渲染 Tab
            tabsContainer.innerHTML += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive}" data-bs-toggle="tab" data-bs-target="#tab-${cat.id}" 
                            type="button" onclick="switchCategory('${cat.id}')">${cat.title}</button>
                </li>
            `;
            
            // 渲染面板容器
            const showClass = index === 0 ? 'show active' : '';
            let cardsHtml = `<div class="tab-pane fade ${showClass}" id="tab-${cat.id}" role="tabpanel"><div class="row g-2">`;
            
            // 遍历模型，把属于该分类的模型渲染成卡片
            for (const [modelId, model] of Object.entries(AI_CONFIG.models)) {
                if (model.category === cat.id) {
                    cardsHtml += `
                        <div class="col-6">
                            <div class="model-card" id="card-${modelId}" onclick="selectModel('${modelId}', '${cat.id}', this)">
                                <div class="model-card-title">${model.title} <i class="bi bi-check-circle-fill check-icon" style="display:none;"></i></div>
                                <p class="model-card-desc">${model.desc}</p>
                            </div>
                        </div>
                    `;
                }
            }
            cardsHtml += `</div></div>`;
            cardsContainer.innerHTML += cardsHtml;
        });

        // 默认激活第一个分类
        switchCategory(AI_CONFIG.categories[0].id);
    }

    function switchCategory(categoryId) {
        document.getElementById('ai-category-select').value = categoryId;
        
        // 从配置中找到当前分类的元数据
        const catConfig = AI_CONFIG.categories.find(c => c.id === categoryId);
        maxImagesAllowed = catConfig.img_max;

        const imgBlock = document.getElementById('ai-image-upload-block');
        const fileInput = document.getElementById('file-input-hidden');
        const imgHelp = document.getElementById('ai-img-help');

        if (maxImagesAllowed === 0) {
            imgBlock.style.display = 'none';
        } else {
            imgBlock.style.display = 'block';
            imgHelp.innerHTML = catConfig.img_help;
            if (maxImagesAllowed === 1) fileInput.removeAttribute('multiple');
            else fileInput.setAttribute('multiple', 'multiple');
        }
        
        currentFiles = [];
        renderPreviews();

        // 自动选中该分类下的第一个卡片
        const activeTabPane = document.getElementById(`tab-${categoryId}`);
        const firstCard = activeTabPane.querySelector('.model-card');
        if (firstCard) firstCard.click();
    }

    function selectModel(modelId, categoryId, element) {
        document.querySelectorAll('.model-card').forEach(card => card.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('ai-model-select').value = modelId;
        
        // 根据后端配置渲染当前模型的动态参数
        renderDynamicParams(modelId);
    }

    // === 动态渲染参数控件 ===
    function renderDynamicParams(modelId) {
        const container = document.getElementById('dynamic-params-container');
        container.innerHTML = ''; 
        
        const params = AI_CONFIG.models[modelId].params;
        if (!params || params.length === 0) return; 

        let html = `<div class="p-3 bg-light rounded-3 border"><label class="form-label fw-bold text-secondary small mb-3"><i class="bi bi-gear-fill me-1"></i>模型专属参数</label><div class="row g-3">`;

        params.forEach(param => {
            html += `<div class="col-12">`;
            if (param.type === 'select') {
                html += `<label class="form-label small text-muted mb-1">${param.label}</label>
                         <select class="form-select form-select-sm dynamic-param-input shadow-sm" data-param-id="${param.id}">`;
                param.options.forEach(opt => {
                    html += `<option value="${opt.value}" ${opt.value === param.default ? 'selected' : ''}>${opt.text}</option>`;
                });
                html += `</select>`;
            } else if (param.type === 'range') {
                // 【核心算法】计算初始的百分比，用于渲染默认的紫色进度条长度
                const percent = ((param.default - param.min) / (param.max - param.min)) * 100;
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label class="form-label small text-muted mb-0">${param.label}</label>
                        <span class="badge bg-white text-primary border border-primary" id="val-${param.id}">${param.default}</span>
                    </div>
                    
                    <input type="range" class="custom-range-slider dynamic-param-input" 
                           data-param-id="${param.id}" data-param-type="range"
                           min="${param.min}" max="${param.max}" step="${param.step}" value="${param.default}"
                           style="background-size: ${percent}% 100%;"
                           oninput="
                               document.getElementById('val-${param.id}').innerText = this.value;
                               this.style.backgroundSize = ((this.value - this.min) / (this.max - this.min)) * 100 + '% 100%';
                           ">
                `;
            }else if (param.type === 'checkbox') {
                const isChecked = param.default ? 'checked' : '';
                html += `
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input dynamic-param-input" type="checkbox" role="switch" 
                               id="param-${param.id}" data-param-id="${param.id}" data-param-type="checkbox" ${isChecked}>
                        <label class="form-check-label small text-muted fw-bold" for="param-${param.id}">${param.label}</label>
                    </div>`;
            }
            html += `</div>`;
        });
        html += `</div></div>`;
        container.innerHTML = html;
    }

    // 拖拽与预览逻辑 
    function setupDragAndDrop() {
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    }

    function handleFiles(files) {
        if (!files || files.length === 0 || maxImagesAllowed === 0) return;
        
        if (maxImagesAllowed === 1) {
            currentFiles = [files[0]]; 
        } else {
            currentFiles = [...currentFiles, ...Array.from(files)].slice(0, maxImagesAllowed); 
        }
        renderPreviews();
    }

    // === 增强版渲染缩略图 (带删除按钮) ===
    function renderPreviews() {
        const container = document.getElementById('preview-container');
        container.innerHTML = ''; // 清空旧视图
        
        currentFiles.forEach((file, index) => {
            // 1. 创建包裹 <img> 和 <button> 的外层容器
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-wrapper m-1';
            
            // 2. 创建图片元素
            const img = document.createElement('img');
            img.className = 'preview-item shadow-sm';
            
            // 异步加载图片预览
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; }
            reader.readAsDataURL(file);
            
            // 3. 创建红色的 X 删除按钮
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn-remove-preview';
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            
            // 点击删除时的逻辑
            removeBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation(); // 极其重要：阻止点击事件冒泡，防止误触底下的上传框触发文件选择
                removeFile(index);
            };
            
            // 组装并塞进页面
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
        });
    }
    // === 【新增】删除指定文件的函数 ===
    function removeFile(index) {
        // 从数组中剔除该文件
        currentFiles.splice(index, 1);
        // 重新渲染预览区
        renderPreviews();
    }

    // === 开始生成通信 ===
    function startGeneration() {
        const modelChoice = document.getElementById('ai-model-select').value;
        const promptText = document.getElementById('ai-prompt').value;

        if (maxImagesAllowed > 0 && currentFiles.length === 0) {
            Swal.fire('提示', '当前模型必须上传参考图片！', 'warning');
            return;
        }
        if (!promptText.trim()) {
            Swal.fire('提示', '请输入画面描述！', 'warning');
            return;
        }

        const btn = document.getElementById('btn-generate');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>生成中...';
        
        document.getElementById('canvas-idle').style.display = 'none';
        document.getElementById('result-image').style.display = 'none';
        document.getElementById('result-actions').style.display = 'none';
        document.getElementById('canvas-scanning').style.display = 'block';
        document.getElementById('canvas-loading').style.display = 'block';

        const formData = new FormData();
        formData.append('model_choice', modelChoice);
        formData.append('prompt', promptText);
        
        if (maxImagesAllowed > 0) {
            currentFiles.forEach(file => formData.append('base_images', file));
        }

        // 收集所有动态参数
        document.querySelectorAll('.dynamic-param-input').forEach(input => {
            const paramId = input.getAttribute('data-param-id');
            const paramType = input.getAttribute('data-param-type');
            
            if (paramType === 'checkbox') {
                // 复选框取 checked 属性，转成字符串 "true" 或 "false" 发给后端
                formData.append(paramId, input.checked); 
            } else {
                formData.append(paramId, input.value);
            }
        });

        fetch('/api/generate-direct/', {
            method: 'POST',
            body: formData 
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const resultImg = document.getElementById('result-image');
                resultImg.src = data.image_url;
                resultImg.style.display = 'block';
                document.getElementById('result-actions').style.display = 'block';
                Swal.fire({ title: '生成成功！', text: data.message, icon: 'success', toast: true, position: 'top-end', showConfirmButton: false, timer: 5000 });
            } else {
                document.getElementById('canvas-idle').style.display = 'block';
                Swal.fire('生成失败', data.message, 'error');
            }
        })
        .catch(error => {
            document.getElementById('canvas-idle').style.display = 'block';
            Swal.fire('请求异常', '网络或服务端报错，请查看控制台', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stars me-2"></i>开始生成';
            document.getElementById('canvas-scanning').style.display = 'none';
            document.getElementById('canvas-loading').style.display = 'none';
        });
    }
</script>
{% endblock %}