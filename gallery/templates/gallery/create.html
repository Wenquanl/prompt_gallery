{% extends 'gallery/base.html' %}
{% load static %}

{% block title %}AI åˆ›ä½œå®¤ - Prompt Gallery{% endblock %}

{% block extra_css %}
<style>
    body { background-color: #f8f9fa; }
    
    /* å·¦ä¾§æ§åˆ¶å°æ ·å¼ */
    .control-panel {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        padding: 24px;
        height: calc(100vh - 100px); /* å‡å»å¯¼èˆªæ é«˜åº¦ */
        overflow-y: auto;
    }

    /* æ‹–æ‹½ä¸Šä¼ åŒºæ ·å¼ */
    .drag-drop-zone {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 30px 20px;
        text-align: center;
        background: #fdfdfd;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    .drag-drop-zone:hover, .drag-drop-zone.dragover {
        border-color: #8a2be2;
        background: #f6f0ff;
    }
    .drag-drop-zone i { font-size: 2rem; color: #adb5bd; transition: color 0.3s ease; }
    .drag-drop-zone:hover i { color: #8a2be2; }
    
    /* éšè—åŸç”Ÿæ–‡ä»¶è¾“å…¥æ¡† */
    #file-input-hidden { display: none; }

    /* ç¼©ç•¥å›¾é¢„è§ˆåŒº */
    #preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .preview-item {
        width: 60px; height: 60px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid #ddd;
    }

    /* å³ä¾§ç”»æ¿åŒºæ ·å¼ */
    .canvas-panel {
        background: #e9ecef;
        border-radius: 16px;
        height: calc(100vh - 100px);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }
    
    .canvas-placeholder {
        text-align: center;
        color: #adb5bd;
    }
    .canvas-placeholder i { font-size: 4rem; opacity: 0.5; }

    /* ç”Ÿæˆç»“æœå›¾ */
    #result-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    /* ç”Ÿæˆä¸­çš„æ‰«æåŠ¨ç”»å…‰æ•ˆ */
    .scanning-effect {
        display: none;
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(to bottom, rgba(138,43,226,0) 0%, rgba(138,43,226,0.1) 50%, rgba(138,43,226,0) 100%);
        background-size: 100% 200%;
        animation: scan 2s linear infinite;
        z-index: 10;
    }
    @keyframes scan {
        0% { background-position: 0 -100%; }
        100% { background-position: 0 100%; }
    }

    /* === ä¼˜åŒ–åçš„æ¨¡å‹é€‰æ‹©å¡ç‰‡æ ·å¼ === */
    .model-category-tabs .nav-link {
        border-radius: 30px;
        color: #6c757d;
        font-weight: 600;
        padding: 8px 16px;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    .model-category-tabs .nav-link.active {
        background-color: #8a2be2;
        color: white;
        box-shadow: 0 4px 10px rgba(138, 43, 226, 0.3);
    }
    .model-category-tabs .nav-link:hover:not(.active) {
        border-color: #dee2e6;
        background-color: #f8f9fa;
    }
    
    .model-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        background: #fff;
    }
    .model-card:hover {
        border-color: #bfa3ed;
        background: #faf8ff;
        transform: translateY(-2px);
    }
    .model-card.active {
        border-color: #8a2be2;
        background: #f4ecff;
        box-shadow: 0 4px 12px rgba(138, 43, 226, 0.15);
    }
    .model-card-title {
        font-weight: 700;
        font-size: 0.95rem;
        color: #343a40;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .model-card-desc {
        font-size: 0.75rem;
        color: #6c757d;
        margin: 0;
        line-height: 1.3;
    }
    .model-card.active .model-card-title { color: #8a2be2; }
    .model-card.active .check-icon { display: block !important; color: #8a2be2; }
    /* === é«˜çº§è‡ªå®šä¹‰æ»‘åŠ¨æ¡ (Range) æ ·å¼ === */
    .custom-range-slider {
        -webkit-appearance: none; /* éšè—åŸç”Ÿæ ·å¼ */
        appearance: none;
        width: 100%;
        height: 6px;
        background: #dee2e6; /* æœªå¡«å……éƒ¨åˆ†çš„ç°è‰²åº•è‰² */
        background-image: linear-gradient(#8a2be2, #8a2be2); /* å·²å¡«å……éƒ¨åˆ†çš„ç´«è‰² */
        background-repeat: no-repeat;
        border-radius: 5px;
        outline: none;
        margin-top: 5px;
        margin-bottom: 10px;
    }
    
    /* æ»‘å—æœ¬ä½“ (Webkit å†…æ ¸å¦‚ Chrome, Edge, Safari) */
    .custom-range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #8a2be2;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(138, 43, 226, 0.4);
        border: 3px solid #fff; /* åŠ ä¸€ä¸ªç™½è¾¹è®©å®ƒçœ‹èµ·æ¥æ›´ç²¾è‡´ */
        transition: transform 0.15s ease-in-out;
    }
    
    /* æ»‘å—æœ¬ä½“ (Firefox) */
    .custom-range-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #8a2be2;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(138, 43, 226, 0.4);
        border: 3px solid #fff;
        transition: transform 0.15s ease-in-out;
    }

    /* æ‚¬æµ®æ—¶çš„å¾®å¾®æ”¾å¤§æ•ˆæœ */
    .custom-range-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }
    .custom-range-slider::-moz-range-thumb:hover {
        transform: scale(1.2);
    }
    /* ç¼©ç•¥å›¾åŒ…è£…å™¨ (ä¸ºäº†ç›¸å¯¹å®šä½åˆ é™¤æŒ‰é’®) */
    .preview-wrapper {
        position: relative;
        display: inline-block;
    }

    /* åˆ é™¤æŒ‰é’®æ ·å¼ */
    .btn-remove-preview {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #dc3545; /* Bootstrap çš„å±é™©çº¢è‰² */
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: transform 0.2s ease, background 0.2s;
        z-index: 10;
    }
    
    .btn-remove-preview:hover {
        transform: scale(1.15);
        background: #bb2d3b;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-4">
    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="control-panel custom-scrollbar">
                <h4 class="fw-bold mb-4"><i class="bi bi-sliders me-2" style="color:#8a2be2;"></i>åˆ›ä½œæ§åˆ¶å°</h4>
                
                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary small">1. æ ¸å¿ƒæ¨¡å‹å¼•æ“</label>
                    <input type="hidden" id="ai-model-select" value="">
                    <input type="hidden" id="ai-category-select" value="">
                    
                    <ul class="nav nav-pills nav-fill mb-3 model-category-tabs" id="dynamic-category-tabs" role="tablist"></ul>
                    <div class="tab-content" id="dynamic-model-cards"></div>
                </div>

                <div class="mb-4" id="ai-image-upload-block" style="display: none;">
                    <label class="form-label fw-bold text-secondary small d-flex justify-content-between">
                        <span>2. ä¸Šä¼ å‚è€ƒå›¾</span>
                        <span id="ai-img-help" class="text-primary" style="font-size: 0.8rem;"></span>
                    </label>
                    <div class="drag-drop-zone" id="drop-zone" onclick="document.getElementById('file-input-hidden').click()">
                        <i class="bi bi-cloud-arrow-up mb-2 d-block"></i>
                        <span class="text-muted fw-bold">ç‚¹å‡»é€‰æ‹©ï¼Œæˆ–å°†å›¾ç‰‡æ‹–æ‹½è‡³æ­¤</span>
                    </div>
                    <input type="file" id="file-input-hidden" accept="image/*" onchange="handleFiles(this.files)">
                    <div id="preview-container"></div>
                </div>

                <div class="mb-4" id="dynamic-params-container"></div>

                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary small">3. ç”»é¢æè¿° (Prompt)</label>
                    <textarea id="ai-prompt" class="form-control" rows="6" placeholder="è¯¦ç»†æè¿°ä½ æƒ³è¦çš„ç”»é¢ï¼Œå»ºè®®ä½¿ç”¨è‹±æ–‡ã€‚"></textarea>
                </div>

                <button id="btn-generate" class="btn btn-primary w-100 rounded-pill py-3 fw-bold fs-5 shadow-sm" style="background: linear-gradient(135deg, #8a2be2 0%, #4a00e0 100%); border:none;" onclick="startGeneration()">
                    <i class="bi bi-stars me-2"></i>å¼€å§‹ç”Ÿæˆ
                </button>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="canvas-panel">
                <div class="canvas-placeholder" id="canvas-idle">
                    <i class="bi bi-palette"></i>
                    <h3 class="mt-3 fw-bold">ä½ çš„åˆ›æ„ç”»å¸ƒ</h3>
                    <p>åœ¨å·¦ä¾§è°ƒæ•´å‚æ•°å¹¶ç‚¹å‡»ç”Ÿæˆï¼Œåœ¨æ­¤è§è¯å¥‡è¿¹ã€‚</p>
                </div>

                <div class="scanning-effect" id="canvas-scanning"></div>
                
                <div id="canvas-loading" style="display: none; position: absolute; z-index: 11; text-align: center;">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                    <h5 class="mt-3 fw-bold text-dark" style="text-shadow: 0 0 10px white;">æ­£åœ¨å‘äº‘ç«¯è¯·æ±‚ç®—åŠ›ï¼Œè¯·è€å¿ƒç­‰å¾…...</h5>
                </div>

                <div id="result-gallery" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; gap: 16px; z-index: 5;">
                    </div>

            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. è·å–åç«¯ä¼ æ¥çš„è¶…çº§é…ç½®å¯¹è±¡
    const AI_CONFIG = JSON.parse('{{ ai_config_json|safe }}');
    let currentFiles = []; 
    let maxImagesAllowed = 0;

    document.addEventListener('DOMContentLoaded', () => {
        initDynamicUI();
        setupDragAndDrop();
    });

    // === æ ¸å¿ƒæ¸²æŸ“å¼•æ“ï¼šæ ¹æ®åç«¯é…ç½®ç”Ÿæˆ UI ===
    function initDynamicUI() {
        const tabsContainer = document.getElementById('dynamic-category-tabs');
        const cardsContainer = document.getElementById('dynamic-model-cards');
        
        // éå†ç”Ÿæˆ Tabs å’Œ å¯¹åº”çš„é¢æ¿
        AI_CONFIG.categories.forEach((cat, index) => {
            const isActive = index === 0 ? 'active' : '';
            
            // æ¸²æŸ“ Tab
            tabsContainer.innerHTML += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive}" data-bs-toggle="tab" data-bs-target="#tab-${cat.id}" 
                            type="button" onclick="switchCategory('${cat.id}')">${cat.title}</button>
                </li>
            `;
            
            // æ¸²æŸ“é¢æ¿å®¹å™¨
            const showClass = index === 0 ? 'show active' : '';
            let cardsHtml = `<div class="tab-pane fade ${showClass}" id="tab-${cat.id}" role="tabpanel"><div class="row g-2">`;
            
            // éå†æ¨¡å‹ï¼ŒæŠŠå±äºè¯¥åˆ†ç±»çš„æ¨¡å‹æ¸²æŸ“æˆå¡ç‰‡
            for (const [modelId, model] of Object.entries(AI_CONFIG.models)) {
                if (model.category === cat.id) {
                    cardsHtml += `
                        <div class="col-6">
                            <div class="model-card" id="card-${modelId}" onclick="selectModel('${modelId}', '${cat.id}', this)">
                                <div class="model-card-title">${model.title} <i class="bi bi-check-circle-fill check-icon" style="display:none;"></i></div>
                                <p class="model-card-desc">${model.desc}</p>
                            </div>
                        </div>
                    `;
                }
            }
            cardsHtml += `</div></div>`;
            cardsContainer.innerHTML += cardsHtml;
        });

        // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªåˆ†ç±»
        switchCategory(AI_CONFIG.categories[0].id);
    }

    function switchCategory(categoryId) {
        document.getElementById('ai-category-select').value = categoryId;
        
        // ä»é…ç½®ä¸­æ‰¾åˆ°å½“å‰åˆ†ç±»çš„å…ƒæ•°æ®
        const catConfig = AI_CONFIG.categories.find(c => c.id === categoryId);
        maxImagesAllowed = catConfig.img_max;

        const imgBlock = document.getElementById('ai-image-upload-block');
        const fileInput = document.getElementById('file-input-hidden');
        const imgHelp = document.getElementById('ai-img-help');

        if (maxImagesAllowed === 0) {
            imgBlock.style.display = 'none';
        } else {
            imgBlock.style.display = 'block';
            imgHelp.innerHTML = catConfig.img_help;
            if (maxImagesAllowed === 1) fileInput.removeAttribute('multiple');
            else fileInput.setAttribute('multiple', 'multiple');
        }
        
        currentFiles = [];
        renderPreviews();

        // è‡ªåŠ¨é€‰ä¸­è¯¥åˆ†ç±»ä¸‹çš„ç¬¬ä¸€ä¸ªå¡ç‰‡
        const activeTabPane = document.getElementById(`tab-${categoryId}`);
        const firstCard = activeTabPane.querySelector('.model-card');
        if (firstCard) firstCard.click();
    }

    function selectModel(modelId, categoryId, element) {
        document.querySelectorAll('.model-card').forEach(card => card.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('ai-model-select').value = modelId;
        
        // æ ¹æ®åç«¯é…ç½®æ¸²æŸ“å½“å‰æ¨¡å‹çš„åŠ¨æ€å‚æ•°
        renderDynamicParams(modelId);
    }

    // === åŠ¨æ€æ¸²æŸ“å‚æ•°æ§ä»¶ ===
    function renderDynamicParams(modelId) {
        const container = document.getElementById('dynamic-params-container');
        container.innerHTML = ''; 
        
        const params = AI_CONFIG.models[modelId].params;
        if (!params || params.length === 0) return; 

        let html = `<div class="p-3 bg-light rounded-3 border"><label class="form-label fw-bold text-secondary small mb-3"><i class="bi bi-gear-fill me-1"></i>æ¨¡å‹ä¸“å±å‚æ•°</label><div class="row g-3">`;

        params.forEach(param => {
            html += `<div class="col-12">`;
            if (param.type === 'select') {
                html += `<label class="form-label small text-muted mb-1">${param.label}</label>
                         <select class="form-select form-select-sm dynamic-param-input shadow-sm" data-param-id="${param.id}">`;
                param.options.forEach(opt => {
                    html += `<option value="${opt.value}" ${opt.value === param.default ? 'selected' : ''}>${opt.text}</option>`;
                });
                html += `</select>`;
            } else if (param.type === 'range') {
                // ã€æ ¸å¿ƒç®—æ³•ã€‘è®¡ç®—åˆå§‹çš„ç™¾åˆ†æ¯”ï¼Œç”¨äºæ¸²æŸ“é»˜è®¤çš„ç´«è‰²è¿›åº¦æ¡é•¿åº¦
                const percent = ((param.default - param.min) / (param.max - param.min)) * 100;
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label class="form-label small text-muted mb-0">${param.label}</label>
                        <span class="badge bg-white text-primary border border-primary" id="val-${param.id}">${param.default}</span>
                    </div>
                    
                    <input type="range" class="custom-range-slider dynamic-param-input" 
                           data-param-id="${param.id}" data-param-type="range"
                           min="${param.min}" max="${param.max}" step="${param.step}" value="${param.default}"
                           style="background-size: ${percent}% 100%;"
                           oninput="
                               document.getElementById('val-${param.id}').innerText = this.value;
                               this.style.backgroundSize = ((this.value - this.min) / (this.max - this.min)) * 100 + '% 100%';
                           ">
                `;
            }else if (param.type === 'checkbox') {
                const isChecked = param.default ? 'checked' : '';
                html += `
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input dynamic-param-input" type="checkbox" role="switch" 
                               id="param-${param.id}" data-param-id="${param.id}" data-param-type="checkbox" ${isChecked}>
                        <label class="form-check-label small text-muted fw-bold" for="param-${param.id}">${param.label}</label>
                    </div>`;
            }
            html += `</div>`;
        });
        html += `</div></div>`;
        container.innerHTML = html;
    }

    // æ‹–æ‹½ä¸é¢„è§ˆé€»è¾‘ 
    function setupDragAndDrop() {
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    }

    function handleFiles(files) {
        if (!files || files.length === 0 || maxImagesAllowed === 0) return;
        
        if (maxImagesAllowed === 1) {
            currentFiles = [files[0]]; 
        } else {
            currentFiles = [...currentFiles, ...Array.from(files)].slice(0, maxImagesAllowed); 
        }
        renderPreviews();
    }

    // === å¢å¼ºç‰ˆæ¸²æŸ“ç¼©ç•¥å›¾ (å¸¦åˆ é™¤æŒ‰é’®) ===
    function renderPreviews() {
        const container = document.getElementById('preview-container');
        container.innerHTML = ''; // æ¸…ç©ºæ—§è§†å›¾
        
        currentFiles.forEach((file, index) => {
            // 1. åˆ›å»ºåŒ…è£¹ <img> å’Œ <button> çš„å¤–å±‚å®¹å™¨
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-wrapper m-1';
            
            // 2. åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = document.createElement('img');
            img.className = 'preview-item shadow-sm';
            
            // å¼‚æ­¥åŠ è½½å›¾ç‰‡é¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; }
            reader.readAsDataURL(file);
            
            // 3. åˆ›å»ºçº¢è‰²çš„ X åˆ é™¤æŒ‰é’®
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn-remove-preview';
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            
            // ç‚¹å‡»åˆ é™¤æ—¶çš„é€»è¾‘
            removeBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation(); // æå…¶é‡è¦ï¼šé˜»æ­¢ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è¯¯è§¦åº•ä¸‹çš„ä¸Šä¼ æ¡†è§¦å‘æ–‡ä»¶é€‰æ‹©
                removeFile(index);
            };
            
            // ç»„è£…å¹¶å¡è¿›é¡µé¢
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
        });
    }
    // === ã€æ–°å¢ã€‘åˆ é™¤æŒ‡å®šæ–‡ä»¶çš„å‡½æ•° ===
    function removeFile(index) {
        // ä»æ•°ç»„ä¸­å‰”é™¤è¯¥æ–‡ä»¶
        currentFiles.splice(index, 1);
        // é‡æ–°æ¸²æŸ“é¢„è§ˆåŒº
        renderPreviews();
    }

    // === å¼€å§‹ç”Ÿæˆé€šä¿¡ ===
    function startGeneration() {
        const modelChoice = document.getElementById('ai-model-select').value;
        const promptText = document.getElementById('ai-prompt').value;

        if (maxImagesAllowed > 0 && currentFiles.length === 0) {
            Swal.fire('æç¤º', 'å½“å‰æ¨¡å‹å¿…é¡»ä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼', 'warning');
            return;
        }
        if (!promptText.trim()) {
            Swal.fire('æç¤º', 'è¯·è¾“å…¥ç”»é¢æè¿°ï¼', 'warning');
            return;
        }

        const btn = document.getElementById('btn-generate');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ç”Ÿæˆä¸­...';
        
        document.getElementById('canvas-idle').style.display = 'none';
        const gallery = document.getElementById('result-gallery');
        if(gallery) {
            gallery.style.display = 'none';
            gallery.innerHTML = ''; 
        }
        document.getElementById('canvas-scanning').style.display = 'block';
        document.getElementById('canvas-loading').style.display = 'block';

        const formData = new FormData();
        formData.append('model_choice', modelChoice);
        formData.append('prompt', promptText);
        
        if (maxImagesAllowed > 0) {
            currentFiles.forEach(file => formData.append('base_images', file));
        }

        // æ”¶é›†æ‰€æœ‰åŠ¨æ€å‚æ•°
        document.querySelectorAll('.dynamic-param-input').forEach(input => {
            const paramId = input.getAttribute('data-param-id');
            const paramType = input.getAttribute('data-param-type');
            
            if (paramType === 'checkbox') {
                // å¤é€‰æ¡†å– checked å±æ€§ï¼Œè½¬æˆå­—ç¬¦ä¸² "true" æˆ– "false" å‘ç»™åç«¯
                formData.append(paramId, input.checked); 
            } else {
                formData.append(paramId, input.value);
            }
        });

        fetch('/api/generate-direct/', {
            method: 'POST',
            body: formData 
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const gallery = document.getElementById('result-gallery');
                gallery.innerHTML = ''; 
                
                const imgCount = data.image_urls.length;

                // ==========================================
                // ã€ç»ˆææ’ç‰ˆä¿®å¤ã€‘ä½¿ç”¨ CSS Grid ç»å¯¹æ§åˆ¶ç½‘æ ¼
                // æµè§ˆå™¨ä¼šä¸¥æ ¼æ ¹æ® 1fr çš„æ¯”ä¾‹åˆ‡å‰²ç©ºé—´ï¼Œç»å¯¹ä¸ä¼šæº¢å‡º
                // ==========================================
                gallery.style.display = 'grid';
                
                if (imgCount === 1) {
                    // 1å¼ å›¾ï¼š1è¡Œ1åˆ—ï¼Œå¡«æ»¡
                    gallery.style.gridTemplateColumns = '1fr';
                    gallery.style.gridTemplateRows = '1fr';
                } else if (imgCount === 2) {
                    // 2å¼ å›¾ï¼š1è¡Œ2åˆ—ï¼Œå·¦å³å¹³åˆ†
                    gallery.style.gridTemplateColumns = '1fr 1fr';
                    gallery.style.gridTemplateRows = '1fr';
                } else {
                    // 3æˆ–4å¼ å›¾ï¼š2è¡Œ2åˆ— (æ ‡å‡†çš„å››å®«æ ¼)
                    gallery.style.gridTemplateColumns = '1fr 1fr';
                    gallery.style.gridTemplateRows = '1fr 1fr';
                }

                // éå† URL æ‹¼è£… HTML
                data.image_urls.forEach(url => {
                    gallery.innerHTML += `
                        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 16px; padding: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); overflow: hidden;">
                            <img src="${url}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
                        </div>
                    `;
                });
                
                Swal.fire({ 
                    title: 'ğŸ‰ ç”ŸæˆæˆåŠŸï¼', 
                    text: data.message, 
                    icon: 'success', 
                    toast: true, 
                    position: 'top-end', 
                    showConfirmButton: false, 
                    timer: 5000 
                });
            } else {
                document.getElementById('canvas-idle').style.display = 'block';
                Swal.fire('ç”Ÿæˆå¤±è´¥', data.message, 'error');
            }
        })
        .catch(error => {
            document.getElementById('canvas-idle').style.display = 'block';
            Swal.fire('è¯·æ±‚å¼‚å¸¸', 'ç½‘ç»œæˆ–æœåŠ¡ç«¯æŠ¥é”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stars me-2"></i>å¼€å§‹ç”Ÿæˆ';
            document.getElementById('canvas-scanning').style.display = 'none';
            document.getElementById('canvas-loading').style.display = 'none';
        });
    }
</script>
{% endblock %}