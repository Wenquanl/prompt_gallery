{% extends 'gallery/base.html' %}
{% load static %}

{% block title %}AI åˆ›ä½œå®¤ - Prompt Gallery{% endblock %}

{% block extra_css %}
<style>
    body { background-color: #f8f9fa; }
    
    /* å·¦ä¾§æ§åˆ¶å°æ ·å¼ */
    .control-panel {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        padding: 24px;
        height: calc(100vh - 100px); /* å‡å»å¯¼èˆªæ é«˜åº¦ */
        overflow-y: auto;
    }

    /* æ‹–æ‹½ä¸Šä¼ åŒºæ ·å¼ */
    .drag-drop-zone {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 30px 20px;
        text-align: center;
        background: #fdfdfd;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    .drag-drop-zone:hover, .drag-drop-zone.dragover {
        border-color: #8a2be2;
        background: #f6f0ff;
    }
    .drag-drop-zone i { font-size: 2rem; color: #adb5bd; transition: color 0.3s ease; }
    .drag-drop-zone:hover i { color: #8a2be2; }
    
    /* éšè—åŸç”Ÿæ–‡ä»¶è¾“å…¥æ¡† */
    #file-input-hidden { display: none; }

    /* ç¼©ç•¥å›¾é¢„è§ˆåŒº */
    #preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .preview-item {
        width: 60px; height: 60px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid #ddd;
    }

    /* å³ä¾§ç”»æ¿åŒºæ ·å¼ */
    .canvas-panel {
        background: #e9ecef;
        border-radius: 16px;
        height: calc(100vh - 100px);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }
    
    .canvas-placeholder {
        text-align: center;
        color: #adb5bd;
    }
    .canvas-placeholder i { font-size: 4rem; opacity: 0.5; }

    /* ç”Ÿæˆç»“æœå›¾ */
    #result-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    /* ç”Ÿæˆä¸­çš„æ‰«æåŠ¨ç”»å…‰æ•ˆ */
    .scanning-effect {
        display: none;
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(to bottom, rgba(138,43,226,0) 0%, rgba(138,43,226,0.1) 50%, rgba(138,43,226,0) 100%);
        background-size: 100% 200%;
        animation: scan 2s linear infinite;
        z-index: 10;
    }
    @keyframes scan {
        0% { background-position: 0 -100%; }
        100% { background-position: 0 100%; }
    }

    /* === ä¼˜åŒ–åçš„æ¨¡å‹é€‰æ‹©å¡ç‰‡æ ·å¼ === */
    .model-category-tabs .nav-link {
        border-radius: 30px;
        color: #6c757d;
        font-weight: 600;
        padding: 8px 16px;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    .model-category-tabs .nav-link.active {
        background-color: #8a2be2;
        color: white;
        box-shadow: 0 4px 10px rgba(138, 43, 226, 0.3);
    }
    .model-category-tabs .nav-link:hover:not(.active) {
        border-color: #dee2e6;
        background-color: #f8f9fa;
    }
    
    .model-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        background: #fff;
    }
    .model-card:hover {
        border-color: #bfa3ed;
        background: #faf8ff;
        transform: translateY(-2px);
    }
    .model-card.active {
        border-color: #8a2be2;
        background: #f4ecff;
        box-shadow: 0 4px 12px rgba(138, 43, 226, 0.15);
    }
    .model-card-title {
        font-weight: 700;
        font-size: 0.95rem;
        color: #343a40;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .model-card-desc {
        font-size: 0.75rem;
        color: #6c757d;
        margin: 0;
        line-height: 1.3;
    }
    .model-card.active .model-card-title { color: #8a2be2; }
    .model-card.active .check-icon { display: block !important; color: #8a2be2; }
    /* === é«˜çº§è‡ªå®šä¹‰æ»‘åŠ¨æ¡ (Range) æ ·å¼ === */
    .custom-range-slider {
        -webkit-appearance: none; /* éšè—åŸç”Ÿæ ·å¼ */
        appearance: none;
        width: 100%;
        height: 6px;
        background: #dee2e6; /* æœªå¡«å……éƒ¨åˆ†çš„ç°è‰²åº•è‰² */
        background-image: linear-gradient(#8a2be2, #8a2be2); /* å·²å¡«å……éƒ¨åˆ†çš„ç´«è‰² */
        background-repeat: no-repeat;
        border-radius: 5px;
        outline: none;
        margin-top: 5px;
        margin-bottom: 10px;
    }
    
    /* æ»‘å—æœ¬ä½“ (Webkit å†…æ ¸å¦‚ Chrome, Edge, Safari) */
    .custom-range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #8a2be2;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(138, 43, 226, 0.4);
        border: 3px solid #fff; /* åŠ ä¸€ä¸ªç™½è¾¹è®©å®ƒçœ‹èµ·æ¥æ›´ç²¾è‡´ */
        transition: transform 0.15s ease-in-out;
    }
    
    /* æ»‘å—æœ¬ä½“ (Firefox) */
    .custom-range-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #8a2be2;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(138, 43, 226, 0.4);
        border: 3px solid #fff;
        transition: transform 0.15s ease-in-out;
    }

    /* æ‚¬æµ®æ—¶çš„å¾®å¾®æ”¾å¤§æ•ˆæœ */
    .custom-range-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }
    .custom-range-slider::-moz-range-thumb:hover {
        transform: scale(1.2);
    }
    /* ç¼©ç•¥å›¾åŒ…è£…å™¨ (ä¸ºäº†ç›¸å¯¹å®šä½åˆ é™¤æŒ‰é’®) */
    .preview-wrapper {
        position: relative;
        display: inline-block;
    }

    /* åˆ é™¤æŒ‰é’®æ ·å¼ */
    .btn-remove-preview {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #dc3545; /* Bootstrap çš„å±é™©çº¢è‰² */
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: transform 0.2s ease, background 0.2s;
        z-index: 10;
    }
    
    .btn-remove-preview:hover {
        transform: scale(1.15);
        background: #bb2d3b;
    }
    /* === æ ‡ç­¾å¤šé€‰æ ·å¼ === */
    .pub-tag-badge {
        cursor: pointer;
        padding: 6px 14px;
        border-radius: 20px;
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.85rem;
        user-select: none;
        display: inline-flex;
        align-items: center;
    }
    .pub-tag-badge:hover {
        background-color: #e9ecef;
        transform: translateY(-1px);
    }
    .pub-tag-badge.active {
        background-color: #8a2be2;
        color: white;
        border-color: #8a2be2;
        box-shadow: 0 4px 10px rgba(138, 43, 226, 0.25);
    }
    /* === å‘å¸ƒä½œå“å¡ç‰‡æŒ‰é’®åŠ¨æ•ˆ === */
    .btn-publish-glow {
        /* é»˜è®¤æ’­æ”¾å‘¼å¸å‘å…‰åŠ¨ç”» */
        animation: pulseGlow 2s infinite cubic-bezier(0.4, 0, 0.2, 1);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
    }
    
    /* é¼ æ ‡æ‚¬æµ®æ—¶ï¼šåœæ­¢å‘¼å¸ï¼Œå‘ä¸Šæµ®åŠ¨å¹¶æ”¾å¤§ï¼Œå¢åŠ é˜´å½± */
    .btn-publish-glow:hover {
        transform: translateY(-5px) scale(1.05) !important;
        box-shadow: 0 15px 30px rgba(32, 201, 151, 0.4) !important;
        animation: none; /* æ‚¬åœæ—¶å–æ¶ˆå‘å…‰åŠ¨ç”»ï¼Œé¿å…è§†è§‰å†²çª */
    }

    /* é¼ æ ‡ç‚¹å‡»æ—¶ï¼šå¾®å¾®ç¼©å°ï¼Œäº§ç”ŸçœŸå®çš„æŒ‰å‹æ„Ÿ */
    .btn-publish-glow:active {
        transform: translateY(-2px) scale(0.98) !important;
        box-shadow: 0 8px 15px rgba(32, 201, 151, 0.3) !important;
    }

    /* å‘¼å¸å‘å…‰å…³é”®å¸§ */
    @keyframes pulseGlow {
        0% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-4">
    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="control-panel custom-scrollbar">
                <h4 class="fw-bold mb-4"><i class="bi bi-sliders me-2" style="color:#8a2be2;"></i>åˆ›ä½œæ§åˆ¶å°</h4>
                
                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary small">1. æ ¸å¿ƒæ¨¡å‹å¼•æ“</label>
                    <input type="hidden" id="ai-model-select" value="">
                    <input type="hidden" id="ai-category-select" value="">
                    
                    <ul class="nav nav-pills nav-fill mb-3 model-category-tabs" id="dynamic-category-tabs" role="tablist"></ul>
                    <div class="tab-content" id="dynamic-model-cards"></div>
                </div>

                <div class="mb-4" id="ai-image-upload-block" style="display: none;">
                    <label class="form-label fw-bold text-secondary small d-flex justify-content-between">
                        <span>2. ä¸Šä¼ å‚è€ƒå›¾</span>
                        <span id="ai-img-help" class="text-primary" style="font-size: 0.8rem;"></span>
                    </label>
                    <div class="drag-drop-zone" id="drop-zone" onclick="document.getElementById('file-input-hidden').click()">
                        <i class="bi bi-cloud-arrow-up mb-2 d-block"></i>
                        <span class="text-muted fw-bold">ç‚¹å‡»é€‰æ‹©ï¼Œæˆ–å°†å›¾ç‰‡æ‹–æ‹½è‡³æ­¤</span>
                    </div>
                    <input type="file" id="file-input-hidden" accept="image/*" onchange="handleFiles(this.files)">
                    <div id="preview-container"></div>
                </div>

                <div class="mb-4" id="dynamic-params-container"></div>

                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary small">3. ç”»é¢æè¿° (Prompt)</label>
                    <textarea id="ai-prompt" class="form-control" rows="6" placeholder="è¯¦ç»†æè¿°ä½ æƒ³è¦çš„ç”»é¢ï¼Œå»ºè®®ä½¿ç”¨è‹±æ–‡ã€‚"></textarea>
                </div>

                <button id="btn-generate" class="btn btn-primary w-100 rounded-pill py-3 fw-bold fs-5 shadow-sm" style="background: linear-gradient(135deg, #8a2be2 0%, #4a00e0 100%); border:none;" onclick="startGeneration()">
                    <i class="bi bi-stars me-2"></i>å¼€å§‹ç”Ÿæˆ
                </button>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="canvas-panel">
                <div class="canvas-placeholder" id="canvas-idle">
                    <i class="bi bi-palette"></i>
                    <h3 class="mt-3 fw-bold">ä½ çš„åˆ›æ„ç”»å¸ƒ</h3>
                    <p>åœ¨å·¦ä¾§è°ƒæ•´å‚æ•°å¹¶ç‚¹å‡»ç”Ÿæˆï¼Œåœ¨æ­¤è§è¯å¥‡è¿¹ã€‚</p>
                </div>

                <div class="scanning-effect" id="canvas-scanning"></div>
                
                <div id="canvas-loading" style="display: none; position: absolute; z-index: 11; text-align: center;">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                    <h5 class="mt-3 fw-bold text-dark" style="text-shadow: 0 0 10px white;">æ­£åœ¨å‘äº‘ç«¯è¯·æ±‚ç®—åŠ›ï¼Œè¯·è€å¿ƒç­‰å¾…...</h5>
                </div>

                <div id="result-gallery" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; gap: 16px; z-index: 5;">
                </div>

                <div id="publish-bar" style="display: none; position: absolute; bottom: 30px; right: 30px; z-index: 20;">
                    <button class="btn btn-success rounded-pill px-4 py-2 shadow-lg fw-bold d-flex align-items-center btn-publish-glow" onclick="publishCreation()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border:none;">
                        <i class="bi bi-box-arrow-up fs-5 me-2"></i>ä¿å­˜ä¸ºä½œå“å¡ç‰‡
                    </button>
                </div>
                <div class="modal fade" id="publishModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-4">
                            <div class="modal-header border-0 pb-0">
                                <h5 class="modal-title fw-bold"><i class="bi bi-send-check text-success me-2"></i>å‘å¸ƒä½œå“å¡ç‰‡</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body pt-4">
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary small">å¡ç‰‡æ ‡é¢˜ <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="pub-title" placeholder="ç»™ä½ çš„ä½œå“èµ·ä¸ªç”ŸåŠ¨çš„åå­—...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary small">æ‰€å±æ¨¡å‹</label>
                                    <input type="text" class="form-control" id="pub-model" placeholder="ä½¿ç”¨çš„ AI æ¨¡å‹ (å¯ä¿®æ”¹)">
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold text-secondary small">å…³è”æ ‡ç­¾ (ç‚¹å‡»å¤šé€‰)</label>
                                    <div class="d-flex flex-wrap gap-2 mb-2 custom-scrollbar" id="pub-tags-container" style="max-height: 140px; overflow-y: auto; padding-bottom: 5px;">
                                        </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white"><i class="bi bi-plus-lg text-muted"></i></span>
                                        <input type="text" class="form-control" id="pub-custom-tag" placeholder="æ²¡æœ‰æƒ³è¦çš„æ ‡ç­¾ï¼Ÿè¾“å…¥åæŒ‰å›è½¦è¡¥å…… (æ”¯æŒé€—å·æ‰¹é‡è¾“å…¥)">
                                    </div>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-success rounded-pill fw-bold py-2 shadow-sm" onclick="confirmPublish()">
                                        <i class="bi bi-cloud-arrow-up me-2"></i>ç¡®è®¤å‘å¸ƒ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. è·å–åç«¯ä¼ æ¥çš„è¶…çº§é…ç½®å¯¹è±¡
    const AI_CONFIG = JSON.parse('{{ ai_config_json|safe }}');
    let currentFiles = []; 
    let maxImagesAllowed = 0;
    let lastSavedPaths = []; // æš‚å­˜æœ€æ–°ç”Ÿæˆçš„æœ¬åœ°å›¾ç‰‡è·¯å¾„
    let initialTagsForPublish = [];
    let allAvailableTags = [];    // ã€æ–°å¢ã€‘ä¿å­˜ç³»ç»Ÿé‡Œçš„æ‰€æœ‰æ ‡ç­¾
    let currentSelectedTags = new Set(); // ã€æ–°å¢ã€‘ä¿å­˜å½“å‰è¢«é€‰ä¸­çš„æ ‡ç­¾

    document.addEventListener('DOMContentLoaded', () => {
        initDynamicUI();
        setupDragAndDrop();
        // è§£æå…¨åº“æ ‡ç­¾
        try {
            allAvailableTags = JSON.parse('{{ all_tags_json|escapejs }}');
        } catch(e) {
            console.log("è§£æç³»ç»Ÿæ ‡ç­¾å¤±è´¥", e);
        }
        
        // ç»‘å®šè‡ªå®šä¹‰æ ‡ç­¾æ¡†çš„å›è½¦äº‹ä»¶
        const customTagInput = document.getElementById('pub-custom-tag');
        if (customTagInput) {
            customTagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // æ”¯æŒä¸­è‹±æ–‡é€—å·åŒæ—¶åˆ†éš”æ·»åŠ å¤šä¸ª
                    const newTags = this.value.split(/[,ï¼Œ]/); 
                    let added = false;
                    
                    newTags.forEach(tag => {
                        const t = tag.trim();
                        if (t && !currentSelectedTags.has(t)) {
                            currentSelectedTags.add(t);
                            if (!allAvailableTags.includes(t)) {
                                allAvailableTags.push(t);
                            }
                            added = true;
                        }
                    });
                    
                    if (added) {
                        this.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                        renderPublishTags(Array.from(currentSelectedTags)); // é‡æ–°æ¸²æŸ“æ ‡ç­¾äº‘
                    }
                }
            });
        }
        // ==========================================
        // ã€æ–°å¢ã€‘æ¥æ”¶å¹¶å¤„ç†ä»è¯¦æƒ…é¡µå¸¦å…¥çš„é¢„å¡«å……æ•°æ®
        // ==========================================
        try {
            // è§£æåç«¯æ³¨å…¥çš„ JSON æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æˆ–è€…ä¸ºç©ºåˆ™é»˜è®¤ä¸ºç©ºå¯¹è±¡
            const initialDataStr = '{{ initial_data_json|escapejs }}';
            if (initialDataStr && initialDataStr !== "{}") {
                const initialData = JSON.parse(initialDataStr);
                
                // 1. å¡«å……çº¯å‡€çš„æç¤ºè¯
                if (initialData.prompt) {
                    document.getElementById('ai-prompt').value = initialData.prompt;
                }
                
                // 2. å•ç‹¬ä¿å­˜æ ‡ç­¾ï¼Œä»…ä¾›å³ä¸‹è§’â€œå‘å¸ƒå¡ç‰‡â€å¼¹çª—é‡Œçš„æ ‡ç­¾äº‘ä½¿ç”¨ï¼Œä¸æ±¡æŸ“æç¤ºè¯æ–‡æœ¬æ¡†
                if (initialData.tags && initialData.tags.length > 0) {
                    initialTagsForPublish = initialData.tags; 
                }
                
                // 2. è‡ªåŠ¨æŠ“å–å¹¶å¡«å……å‚è€ƒå›¾
                if (initialData.reference_urls && initialData.reference_urls.length > 0) {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
                    Swal.fire({
                        title: 'æ­£åœ¨å¯¼å…¥å‚è€ƒå›¾...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    // å°†æ‰€æœ‰ç½‘ç»œ URL è½¬æ¢ä¸º File å¯¹è±¡
                    Promise.all(initialData.reference_urls.map(url => 
                        fetch(url)
                            .then(res => res.blob())
                            .then(blob => {
                                // æå–æ–‡ä»¶åæˆ–ä½¿ç”¨é»˜è®¤åç§°
                                const filename = url.split('/').pop().split('?')[0] || 'reference_image.jpg';
                                return new File([blob], filename, { type: blob.type || 'image/jpeg' });
                            })
                    )).then(files => {
                        // å…¼å®¹ä½ åŸæœ‰çš„ handleFiles é€»è¾‘
                        if (maxImagesAllowed === 1) {
                            currentFiles = [files[0]]; 
                        } else if (maxImagesAllowed > 1) {
                            currentFiles = [...currentFiles, ...files].slice(0, maxImagesAllowed); 
                        }
                        
                        // é‡æ–°æ¸²æŸ“ç¼©ç•¥å›¾
                        renderPreviews();
                        Swal.close();
                    }).catch(err => {
                        console.error("åŠ è½½å‚è€ƒå›¾å¤±è´¥:", err);
                        Swal.fire('å¯¼å…¥æç¤º', 'éƒ¨åˆ†å‚è€ƒå›¾å¯¼å…¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ ', 'warning');
                    });
                }
            }
        } catch(e) {
            console.log("æ— é¢„å¡«å……æ•°æ®æˆ–è§£æå¤±è´¥", e);
        }
    });

    // === æ ¸å¿ƒæ¸²æŸ“å¼•æ“ï¼šæ ¹æ®åç«¯é…ç½®ç”Ÿæˆ UI ===
    function initDynamicUI() {
        const tabsContainer = document.getElementById('dynamic-category-tabs');
        const cardsContainer = document.getElementById('dynamic-model-cards');
        
        // éå†ç”Ÿæˆ Tabs å’Œ å¯¹åº”çš„é¢æ¿
        AI_CONFIG.categories.forEach((cat, index) => {
            const isActive = index === 0 ? 'active' : '';
            
            // æ¸²æŸ“ Tab
            tabsContainer.innerHTML += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive}" data-bs-toggle="tab" data-bs-target="#tab-${cat.id}" 
                            type="button" onclick="switchCategory('${cat.id}')">${cat.title}</button>
                </li>
            `;
            
            // æ¸²æŸ“é¢æ¿å®¹å™¨
            const showClass = index === 0 ? 'show active' : '';
            let cardsHtml = `<div class="tab-pane fade ${showClass}" id="tab-${cat.id}" role="tabpanel"><div class="row g-2">`;
            
            // éå†æ¨¡å‹ï¼ŒæŠŠå±äºè¯¥åˆ†ç±»çš„æ¨¡å‹æ¸²æŸ“æˆå¡ç‰‡
            for (const [modelId, model] of Object.entries(AI_CONFIG.models)) {
                if (model.category === cat.id) {
                    cardsHtml += `
                        <div class="col-6">
                            <div class="model-card" id="card-${modelId}" onclick="selectModel('${modelId}', '${cat.id}', this)">
                                <div class="model-card-title">${model.title} <i class="bi bi-check-circle-fill check-icon" style="display:none;"></i></div>
                                <p class="model-card-desc">${model.desc}</p>
                            </div>
                        </div>
                    `;
                }
            }
            cardsHtml += `</div></div>`;
            cardsContainer.innerHTML += cardsHtml;
        });

        // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªåˆ†ç±»
        switchCategory(AI_CONFIG.categories[0].id);
    }

    function switchCategory(categoryId) {
        document.getElementById('ai-category-select').value = categoryId;
        
        // ä»é…ç½®ä¸­æ‰¾åˆ°å½“å‰åˆ†ç±»çš„å…ƒæ•°æ®
        const catConfig = AI_CONFIG.categories.find(c => c.id === categoryId);
        maxImagesAllowed = catConfig.img_max;

        const imgBlock = document.getElementById('ai-image-upload-block');
        const fileInput = document.getElementById('file-input-hidden');
        const imgHelp = document.getElementById('ai-img-help');

        if (maxImagesAllowed === 0) {
            imgBlock.style.display = 'none';
        } else {
            imgBlock.style.display = 'block';
            imgHelp.innerHTML = catConfig.img_help;
            if (maxImagesAllowed === 1) fileInput.removeAttribute('multiple');
            else fileInput.setAttribute('multiple', 'multiple');
        }
        
        currentFiles = [];
        renderPreviews();

        // è‡ªåŠ¨é€‰ä¸­è¯¥åˆ†ç±»ä¸‹çš„ç¬¬ä¸€ä¸ªå¡ç‰‡
        const activeTabPane = document.getElementById(`tab-${categoryId}`);
        const firstCard = activeTabPane.querySelector('.model-card');
        if (firstCard) firstCard.click();
    }

    function selectModel(modelId, categoryId, element) {
        document.querySelectorAll('.model-card').forEach(card => card.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('ai-model-select').value = modelId;
        
        // æ ¹æ®åç«¯é…ç½®æ¸²æŸ“å½“å‰æ¨¡å‹çš„åŠ¨æ€å‚æ•°
        renderDynamicParams(modelId);
    }

    // === åŠ¨æ€æ¸²æŸ“å‚æ•°æ§ä»¶ ===
    function renderDynamicParams(modelId) {
        const container = document.getElementById('dynamic-params-container');
        container.innerHTML = ''; 
        
        const params = AI_CONFIG.models[modelId].params;
        if (!params || params.length === 0) return; 

        let html = `<div class="p-3 bg-light rounded-3 border"><label class="form-label fw-bold text-secondary small mb-3"><i class="bi bi-gear-fill me-1"></i>æ¨¡å‹ä¸“å±å‚æ•°</label><div class="row g-3">`;

        params.forEach(param => {
            html += `<div class="col-12">`;
            if (param.type === 'select') {
                html += `<label class="form-label small text-muted mb-1">${param.label}</label>
                         <select class="form-select form-select-sm dynamic-param-input shadow-sm" data-param-id="${param.id}">`;
                param.options.forEach(opt => {
                    html += `<option value="${opt.value}" ${opt.value === param.default ? 'selected' : ''}>${opt.text}</option>`;
                });
                html += `</select>`;
            } else if (param.type === 'range') {
                // ã€æ ¸å¿ƒç®—æ³•ã€‘è®¡ç®—åˆå§‹çš„ç™¾åˆ†æ¯”ï¼Œç”¨äºæ¸²æŸ“é»˜è®¤çš„ç´«è‰²è¿›åº¦æ¡é•¿åº¦
                const percent = ((param.default - param.min) / (param.max - param.min)) * 100;
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label class="form-label small text-muted mb-0">${param.label}</label>
                        <span class="badge bg-white text-primary border border-primary" id="val-${param.id}">${param.default}</span>
                    </div>
                    
                    <input type="range" class="custom-range-slider dynamic-param-input" 
                           data-param-id="${param.id}" data-param-type="range"
                           min="${param.min}" max="${param.max}" step="${param.step}" value="${param.default}"
                           style="background-size: ${percent}% 100%;"
                           oninput="
                               document.getElementById('val-${param.id}').innerText = this.value;
                               this.style.backgroundSize = ((this.value - this.min) / (this.max - this.min)) * 100 + '% 100%';
                           ">
                `;
            }else if (param.type === 'checkbox') {
                const isChecked = param.default ? 'checked' : '';
                html += `
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input dynamic-param-input" type="checkbox" role="switch" 
                               id="param-${param.id}" data-param-id="${param.id}" data-param-type="checkbox" ${isChecked}>
                        <label class="form-check-label small text-muted fw-bold" for="param-${param.id}">${param.label}</label>
                    </div>`;
            }
            html += `</div>`;
        });
        html += `</div></div>`;
        container.innerHTML = html;
    }

    // æ‹–æ‹½ä¸é¢„è§ˆé€»è¾‘ 
    function setupDragAndDrop() {
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    }

    // === æ¸²æŸ“å¤šé€‰æ ‡ç­¾äº‘ ===
    function renderPublishTags(preSelectedTags) {
        const container = document.getElementById('pub-tags-container');
        container.innerHTML = '';
        
        // ç¡®ä¿é¢„é€‰æ ‡ç­¾è¢«åŠ å…¥åˆ° Set ä¸­
        preSelectedTags.forEach(t => currentSelectedTags.add(t));
        
        // æŠŠâ€œå…¨åº“æ ‡ç­¾â€å’Œâ€œé¢„å¸¦å…¥çš„æ ‡ç­¾â€åˆå¹¶å»é‡ (ä»¥é˜²é¢„é€‰æ ‡ç­¾è¿˜æ²¡å­˜è¿›æ•°æ®åº“)
        const combinedTags = Array.from(new Set([...allAvailableTags, ...preSelectedTags]));
        
        if (combinedTags.length === 0) {
            container.innerHTML = '<span class="text-muted small">æš‚æ— ç³»ç»Ÿæ ‡ç­¾ï¼Œè¯·åœ¨ä¸‹æ–¹æ‰‹åŠ¨æ·»åŠ </span>';
            return;
        }

        combinedTags.forEach(tag => {
            const badge = document.createElement('span');
            badge.className = 'pub-tag-badge';
            
            // åˆ¤æ–­æ˜¯å¦åº”è¯¥å¤„äºé«˜äº®(é€‰ä¸­)çŠ¶æ€
            if (currentSelectedTags.has(tag)) {
                badge.classList.add('active');
                badge.innerHTML = `<i class="bi bi-check2 me-1"></i>${tag}`; // æ‰“ä¸ªå‹¾
            } else {
                badge.textContent = tag;
            }
            
            // ç»‘å®šç‚¹å‡»åˆ‡æ¢é€»è¾‘
            badge.onclick = function() {
                if (currentSelectedTags.has(tag)) {
                    currentSelectedTags.delete(tag);
                    this.classList.remove('active');
                    this.textContent = tag; 
                } else {
                    currentSelectedTags.add(tag);
                    this.classList.add('active');
                    this.innerHTML = `<i class="bi bi-check2 me-1"></i>${tag}`;
                }
            };
            container.appendChild(badge);
        });
    }

    function handleFiles(files) {
        if (!files || files.length === 0 || maxImagesAllowed === 0) return;
        
        if (maxImagesAllowed === 1) {
            currentFiles = [files[0]]; 
        } else {
            currentFiles = [...currentFiles, ...Array.from(files)].slice(0, maxImagesAllowed); 
        }
        renderPreviews();
    }

    // === å¢å¼ºç‰ˆæ¸²æŸ“ç¼©ç•¥å›¾ (å¸¦åˆ é™¤æŒ‰é’®) ===
    function renderPreviews() {
        const container = document.getElementById('preview-container');
        container.innerHTML = ''; // æ¸…ç©ºæ—§è§†å›¾
        
        currentFiles.forEach((file, index) => {
            // 1. åˆ›å»ºåŒ…è£¹ <img> å’Œ <button> çš„å¤–å±‚å®¹å™¨
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-wrapper m-1';
            
            // 2. åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = document.createElement('img');
            img.className = 'preview-item shadow-sm';
            
            // å¼‚æ­¥åŠ è½½å›¾ç‰‡é¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; }
            reader.readAsDataURL(file);
            
            // 3. åˆ›å»ºçº¢è‰²çš„ X åˆ é™¤æŒ‰é’®
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn-remove-preview';
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            
            // ç‚¹å‡»åˆ é™¤æ—¶çš„é€»è¾‘
            removeBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation(); // æå…¶é‡è¦ï¼šé˜»æ­¢ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è¯¯è§¦åº•ä¸‹çš„ä¸Šä¼ æ¡†è§¦å‘æ–‡ä»¶é€‰æ‹©
                removeFile(index);
            };
            
            // ç»„è£…å¹¶å¡è¿›é¡µé¢
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
        });
    }
    // === ã€æ–°å¢ã€‘åˆ é™¤æŒ‡å®šæ–‡ä»¶çš„å‡½æ•° ===
    function removeFile(index) {
        // ä»æ•°ç»„ä¸­å‰”é™¤è¯¥æ–‡ä»¶
        currentFiles.splice(index, 1);
        // é‡æ–°æ¸²æŸ“é¢„è§ˆåŒº
        renderPreviews();
    }

    // === å¼€å§‹ç”Ÿæˆé€šä¿¡ ===
    function startGeneration() {
        const modelChoice = document.getElementById('ai-model-select').value;
        const promptText = document.getElementById('ai-prompt').value;

        if (maxImagesAllowed > 0 && currentFiles.length === 0) {
            Swal.fire('æç¤º', 'å½“å‰æ¨¡å‹å¿…é¡»ä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼', 'warning');
            return;
        }
        if (!promptText.trim()) {
            Swal.fire('æç¤º', 'è¯·è¾“å…¥ç”»é¢æè¿°ï¼', 'warning');
            return;
        }

        const btn = document.getElementById('btn-generate');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ç”Ÿæˆä¸­...';
        
        document.getElementById('canvas-idle').style.display = 'none';
        document.getElementById('publish-bar').style.display = 'none';
        const gallery = document.getElementById('result-gallery');
        if(gallery) {
            gallery.style.display = 'none';
            gallery.innerHTML = ''; 
        }
        document.getElementById('canvas-scanning').style.display = 'block';
        document.getElementById('canvas-loading').style.display = 'block';

        const formData = new FormData();
        formData.append('model_choice', modelChoice);
        formData.append('prompt', promptText);
        
        if (maxImagesAllowed > 0) {
            currentFiles.forEach(file => formData.append('base_images', file));
        }

        // æ”¶é›†æ‰€æœ‰åŠ¨æ€å‚æ•°
        document.querySelectorAll('.dynamic-param-input').forEach(input => {
            const paramId = input.getAttribute('data-param-id');
            const paramType = input.getAttribute('data-param-type');
            
            if (paramType === 'checkbox') {
                // å¤é€‰æ¡†å– checked å±æ€§ï¼Œè½¬æˆå­—ç¬¦ä¸² "true" æˆ– "false" å‘ç»™åç«¯
                formData.append(paramId, input.checked); 
            } else {
                formData.append(paramId, input.value);
            }
        });

        fetch('/api/generate-direct/', {
            method: 'POST',
            body: formData 
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                lastSavedPaths = data.saved_paths;
                document.getElementById('publish-bar').style.display = 'block';

                const gallery = document.getElementById('result-gallery');
                gallery.innerHTML = '';
                
                const imgCount = data.image_urls.length;

                // ==========================================
                // ã€ç»ˆææ’ç‰ˆä¿®å¤ã€‘ä½¿ç”¨ CSS Grid ç»å¯¹æ§åˆ¶ç½‘æ ¼
                // æµè§ˆå™¨ä¼šä¸¥æ ¼æ ¹æ® 1fr çš„æ¯”ä¾‹åˆ‡å‰²ç©ºé—´ï¼Œç»å¯¹ä¸ä¼šæº¢å‡º
                // ==========================================
                gallery.style.display = 'grid';
                
                if (imgCount === 1) {
                    // 1å¼ å›¾ï¼š1è¡Œ1åˆ—ï¼Œå¡«æ»¡
                    gallery.style.gridTemplateColumns = '1fr';
                    gallery.style.gridTemplateRows = '1fr';
                } else if (imgCount === 2) {
                    // 2å¼ å›¾ï¼š1è¡Œ2åˆ—ï¼Œå·¦å³å¹³åˆ†
                    gallery.style.gridTemplateColumns = '1fr 1fr';
                    gallery.style.gridTemplateRows = '1fr';
                } else {
                    // 3æˆ–4å¼ å›¾ï¼š2è¡Œ2åˆ— (æ ‡å‡†çš„å››å®«æ ¼)
                    gallery.style.gridTemplateColumns = '1fr 1fr';
                    gallery.style.gridTemplateRows = '1fr 1fr';
                }

                // éå† URL æ‹¼è£… HTML
                data.image_urls.forEach(url => {
                    gallery.innerHTML += `
                        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 16px; padding: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); overflow: hidden;">
                            <img src="${url}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
                        </div>
                    `;
                });
                
                Swal.fire({ 
                    title: 'ğŸ‰ ç”ŸæˆæˆåŠŸï¼', 
                    text: data.message, 
                    icon: 'success', 
                    toast: true, 
                    position: 'top-end', 
                    showConfirmButton: false, 
                    timer: 5000 
                });
            } else {
                document.getElementById('canvas-idle').style.display = 'block';
                Swal.fire('ç”Ÿæˆå¤±è´¥', data.message, 'error');
            }
        })
        .catch(error => {
            document.getElementById('canvas-idle').style.display = 'block';
            Swal.fire('è¯·æ±‚å¼‚å¸¸', 'ç½‘ç»œæˆ–æœåŠ¡ç«¯æŠ¥é”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stars me-2"></i>å¼€å§‹ç”Ÿæˆ';
            document.getElementById('canvas-scanning').style.display = 'none';
            document.getElementById('canvas-loading').style.display = 'none';
        });
    }
    // === 1. ç‚¹å‡»æ‚¬æµ®æŒ‰é’®ï¼Œå¼¹å‡ºä¿¡æ¯å¡«å†™æ¡†å¹¶é¢„å¡«å……æ•°æ® ===
    function publishCreation() {
        if (!lastSavedPaths || lastSavedPaths.length === 0) {
            Swal.fire('æç¤º', 'æ²¡æœ‰å¯å‘å¸ƒçš„å›¾ç‰‡ï¼Œè¯·å…ˆç”Ÿæˆï¼', 'warning');
            return;
        }

        const activeModelCard = document.querySelector('.model-card.active');
        const modelName = activeModelCard ? activeModelCard.querySelector('.model-card-title').innerText.trim() : document.getElementById('ai-model-select').value;
        
        const promptText = document.getElementById('ai-prompt').value.trim();
        let suggestedTitle = promptText ? promptText.substring(0, 15) : 'AI ç‹¬ç«‹åˆ›ä½œ';
        if (promptText.length > 15) suggestedTitle += '...';

        document.getElementById('pub-title').value = suggestedTitle;
        document.getElementById('pub-model').value = modelName;
        
        // ã€å…³é”®æ–°å¢ã€‘ï¼šè°ƒç”¨åˆšæ‰å†™çš„æ¸²æŸ“å‡½æ•°ï¼Œå¹¶å°†å¸¦å…¥çš„æ ‡ç­¾å–‚ç»™å®ƒï¼Œå®ƒä¼šè‡ªåŠ¨é«˜äº®
        renderPublishTags(initialTagsForPublish);

        new bootstrap.Modal(document.getElementById('publishModal')).show();
    }

    // === 2. åœ¨å¼¹çª—å†…ç‚¹å‡»â€œç¡®è®¤å‘å¸ƒâ€ï¼ŒçœŸæ­£å‘åç«¯å‘é€è¯·æ±‚ ===
    function confirmPublish() {
        const titleInput = document.getElementById('pub-title').value.trim();
        if (!titleInput) {
            Swal.fire('æç¤º', 'è¯·å¡«å†™å¡ç‰‡æ ‡é¢˜ï¼', 'warning');
            return;
        }

        const modalEl = document.getElementById('publishModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) modalInstance.hide();

        Swal.fire({
            title: 'æ­£åœ¨æ‰“åŒ…å¹¶å‘å¸ƒ...',
            text: 'è¯·ç¨å€™ï¼ŒæœåŠ¡å™¨æ­£åœ¨ç”Ÿæˆè®°å½•',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        const formData = new FormData();
        formData.append('prompt', document.getElementById('ai-prompt').value);
        formData.append('title', titleInput);
        formData.append('model_info', document.getElementById('pub-model').value.trim());
        
        // ã€å…³é”®ä¿®æ”¹ã€‘ï¼šä» currentSelectedTags é›†åˆä¸­æå–é€‰ä¸­çš„æ ‡ç­¾ï¼Œè½¬ä¸ºå­—ç¬¦ä¸²å‘ç»™åç«¯
        const finalTags = Array.from(currentSelectedTags).join(',');
        formData.append('tags', finalTags);
        
        lastSavedPaths.forEach(path => {
            formData.append('saved_paths', path);
        });

        if (currentFiles && currentFiles.length > 0) {
            currentFiles.forEach(file => {
                formData.append('references', file);
            });
        }

        fetch('/api/publish-studio/', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'ğŸ‰ å‘å¸ƒæˆåŠŸï¼',
                    text: 'å·²ä¿å­˜è‡³æ‚¨çš„æç¤ºè¯ç”»å»Šã€‚',
                    showCancelButton: true,
                    confirmButtonText: '<i class="bi bi-eye"></i> å‰å¾€æŸ¥çœ‹è¯¥å¡ç‰‡',
                    cancelButtonText: 'ç•™åœ¨æ­¤é¡µç»§ç»­åˆ›ä½œ',
                    confirmButtonColor: '#8a2be2'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.open(`/image/${data.group_id}/`, '_blank');
                    } else {
                        document.getElementById('publish-bar').style.display = 'none';
                    }
                });
            } else {
                Swal.fire('å‘å¸ƒå¤±è´¥', data.message, 'error');
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('è¯·æ±‚å¼‚å¸¸', 'ç½‘ç»œæˆ–æœåŠ¡ç«¯æŠ¥é”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
        });
    }
</script>
{% endblock %}