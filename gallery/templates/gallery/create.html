{% extends 'gallery/base.html' %}
{% load static %}

{% block title %}AI åˆ›ä½œå®¤ - Prompt Gallery{% endblock %}

{% block extra_css %}
<style>
    body { background-color: #f8f9fa; }
    
    /* å·¦ä¾§æ§åˆ¶å°æ ·å¼ */
    .control-panel {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        padding: 24px;
        height: calc(100vh - 100px); /* å‡å»å¯¼èˆªæ é«˜åº¦ */
        overflow-y: auto;
    }

    /* æ‹–æ‹½ä¸Šä¼ åŒºæ ·å¼ */
    .drag-drop-zone {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 30px 20px;
        text-align: center;
        background: #fdfdfd;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    .drag-drop-zone:hover, .drag-drop-zone.dragover {
        border-color: #8a2be2;
        background: #f6f0ff;
    }
    .drag-drop-zone i { font-size: 2rem; color: #adb5bd; transition: color 0.3s ease; }
    .drag-drop-zone:hover i { color: #8a2be2; }
    
    /* éšè—åŸç”Ÿæ–‡ä»¶è¾“å…¥æ¡† */
    #file-input-hidden { display: none; }

    /* ç¼©ç•¥å›¾é¢„è§ˆåŒº */
    #preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .preview-item {
        width: 60px; height: 60px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid #ddd;
    }

    /* å³ä¾§ç”»æ¿åŒºæ ·å¼ */
    .canvas-panel {
        background: #e9ecef;
        border-radius: 16px;
        height: calc(100vh - 100px);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }
    
    .canvas-placeholder {
        text-align: center;
        color: #adb5bd;
    }
    .canvas-placeholder i { font-size: 4rem; opacity: 0.5; }

    /* ç”Ÿæˆç»“æœå›¾ */
    #result-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    /* ç”Ÿæˆä¸­çš„æ‰«æåŠ¨ç”»å…‰æ•ˆ */
    .scanning-effect {
        display: none;
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(to bottom, rgba(138,43,226,0) 0%, rgba(138,43,226,0.1) 50%, rgba(138,43,226,0) 100%);
        background-size: 100% 200%;
        animation: scan 2s linear infinite;
        z-index: 10;
    }
    @keyframes scan {
        0% { background-position: 0 -100%; }
        100% { background-position: 0 100%; }
    }

    /* === ä¼˜åŒ–åçš„æ¨¡å‹é€‰æ‹©å¡ç‰‡æ ·å¼ === */
    .model-category-tabs .nav-link {
        border-radius: 30px;
        color: #6c757d;
        font-weight: 600;
        padding: 8px 16px;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    .model-category-tabs .nav-link.active {
        background-color: #8a2be2;
        color: white;
        box-shadow: 0 4px 10px rgba(138, 43, 226, 0.3);
    }
    .model-category-tabs .nav-link:hover:not(.active) {
        border-color: #dee2e6;
        background-color: #f8f9fa;
    }
    
    .model-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        background: #fff;
    }
    .model-card:hover {
        border-color: #bfa3ed;
        background: #faf8ff;
        transform: translateY(-2px);
    }
    .model-card.active {
        border-color: #8a2be2;
        background: #f4ecff;
        box-shadow: 0 4px 12px rgba(138, 43, 226, 0.15);
    }
    .model-card-title {
        font-weight: 700;
        font-size: 0.95rem;
        color: #343a40;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .model-card-desc {
        font-size: 0.75rem;
        color: #6c757d;
        margin: 0;
        line-height: 1.3;
    }
    .model-card.active .model-card-title { color: #8a2be2; }
    .model-card.active .check-icon { display: block !important; color: #8a2be2; }
    /* === é«˜çº§è‡ªå®šä¹‰æ»‘åŠ¨æ¡ (Range) æ ·å¼ === */
    .custom-range-slider {
        -webkit-appearance: none; /* éšè—åŸç”Ÿæ ·å¼ */
        appearance: none;
        width: 100%;
        height: 6px;
        background: #dee2e6; /* æœªå¡«å……éƒ¨åˆ†çš„ç°è‰²åº•è‰² */
        background-image: linear-gradient(#8a2be2, #8a2be2); /* å·²å¡«å……éƒ¨åˆ†çš„ç´«è‰² */
        background-repeat: no-repeat;
        border-radius: 5px;
        outline: none;
        margin-top: 5px;
        margin-bottom: 10px;
    }
    
    /* æ»‘å—æœ¬ä½“ (Webkit å†…æ ¸å¦‚ Chrome, Edge, Safari) */
    .custom-range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #8a2be2;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(138, 43, 226, 0.4);
        border: 3px solid #fff; /* åŠ ä¸€ä¸ªç™½è¾¹è®©å®ƒçœ‹èµ·æ¥æ›´ç²¾è‡´ */
        transition: transform 0.15s ease-in-out;
    }
    
    /* æ»‘å—æœ¬ä½“ (Firefox) */
    .custom-range-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #8a2be2;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(138, 43, 226, 0.4);
        border: 3px solid #fff;
        transition: transform 0.15s ease-in-out;
    }

    /* æ‚¬æµ®æ—¶çš„å¾®å¾®æ”¾å¤§æ•ˆæœ */
    .custom-range-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }
    .custom-range-slider::-moz-range-thumb:hover {
        transform: scale(1.2);
    }
    /* ç¼©ç•¥å›¾åŒ…è£…å™¨ (ä¸ºäº†ç›¸å¯¹å®šä½åˆ é™¤æŒ‰é’®) */
    .preview-wrapper {
        position: relative;
        display: inline-block;
    }

    /* åˆ é™¤æŒ‰é’®æ ·å¼ */
    .btn-remove-preview {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #dc3545; /* Bootstrap çš„å±é™©çº¢è‰² */
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: transform 0.2s ease, background 0.2s;
        z-index: 10;
    }
    
    .btn-remove-preview:hover {
        transform: scale(1.15);
        background: #bb2d3b;
    }
    /* === æ ‡ç­¾å¤šé€‰æ ·å¼ === */
    .pub-tag-badge {
        cursor: pointer;
        padding: 6px 14px;
        border-radius: 20px;
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.85rem;
        user-select: none;
        display: inline-flex;
        align-items: center;
    }
    .pub-tag-badge:hover {
        background-color: #e9ecef;
        transform: translateY(-1px);
    }
    .pub-tag-badge.active {
        background-color: #8a2be2;
        color: white;
        border-color: #8a2be2;
        box-shadow: 0 4px 10px rgba(138, 43, 226, 0.25);
    }
    /* === å‘å¸ƒä½œå“å¡ç‰‡æŒ‰é’®åŠ¨æ•ˆ === */
    .btn-publish-glow {
        /* é»˜è®¤æ’­æ”¾å‘¼å¸å‘å…‰åŠ¨ç”» */
        animation: pulseGlow 2s infinite cubic-bezier(0.4, 0, 0.2, 1);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
    }
    
    /* é¼ æ ‡æ‚¬æµ®æ—¶ï¼šåœæ­¢å‘¼å¸ï¼Œå‘ä¸Šæµ®åŠ¨å¹¶æ”¾å¤§ï¼Œå¢åŠ é˜´å½± */
    .btn-publish-glow:hover {
        transform: translateY(-5px) scale(1.05) !important;
        box-shadow: 0 15px 30px rgba(32, 201, 151, 0.4) !important;
        animation: none; /* æ‚¬åœæ—¶å–æ¶ˆå‘å…‰åŠ¨ç”»ï¼Œé¿å…è§†è§‰å†²çª */
    }

    /* é¼ æ ‡ç‚¹å‡»æ—¶ï¼šå¾®å¾®ç¼©å°ï¼Œäº§ç”ŸçœŸå®çš„æŒ‰å‹æ„Ÿ */
    .btn-publish-glow:active {
        transform: translateY(-2px) scale(0.98) !important;
        box-shadow: 0 8px 15px rgba(32, 201, 151, 0.3) !important;
    }

    /* å‘¼å¸å‘å…‰å…³é”®å¸§ */
    @keyframes pulseGlow {
        0% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
    }

    /* === ç”Ÿæˆç»“æœå¯é€‰å¡ç‰‡æ ·å¼ === */
    .gen-result-card {
        position: relative;
        cursor: pointer;
        border-radius: 16px;
        overflow: hidden;
        background: #fff;
        padding: 10px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        border: 3px solid transparent;
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        width: 100%; 
        height: 100%; 
        display: flex; 
        align-items: center; 
        justify-content: center;
    }

    /* é€‰ä¸­æ—¶çš„å¤–å‘å…‰å’Œè¾¹æ¡† */
    .gen-result-card.selected {
        border-color: #8a2be2;
        background: #f4ecff;
        box-shadow: 0 8px 25px rgba(138, 43, 226, 0.25);
    }

    /* å³ä¸Šè§’çš„å¤é€‰æ¡†å¾½ç«  */
    .gen-result-card .select-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 28px;
        height: 28px;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #adb5bd;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        z-index: 5;
    }

    .gen-result-card:hover .select-badge {
        transform: scale(1.1);
    }

    .gen-result-card.selected .select-badge {
        background: #8a2be2;
        border-color: #8a2be2;
    }

    .gen-result-card .select-badge i {
        color: white;
        font-size: 16px;
        display: none;
    }

    .gen-result-card.selected .select-badge i {
        display: block;
    }

    /* === AI æ ¸å¿ƒåŠ è½½åŠ¨ç”» === */
    .fluid-blob {
        width: 110px;
        height: 110px;
        background: linear-gradient(135deg, #8a2be2, #20c997, #0d6efd);
        background-size: 200% 200%;
        /* æ ¸å¿ƒï¼šé€šè¿‡ä¸æ–­å˜åŒ–çš„åœ†è§’å®ç°ç±»ä¼¼æ°´æ»´/æ¶²ä½“çš„æµä½“æ„Ÿ */
        animation: fluidShape 5s ease-in-out infinite, gradientShift 4s ease infinite;
        margin: 0 auto 20px auto;
        box-shadow: 0 10px 30px rgba(138, 43, 226, 0.4);
    }
    
    @keyframes fluidShape {
        0% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
        34% { border-radius: 70% 30% 50% 50% / 30% 30% 70% 70%; }
        67% { border-radius: 100% 60% 60% 100% / 100% 100% 60% 60%; }
        100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
    }
    @keyframes gradientShift { 
        0% { background-position: 0% 50%; } 
        50% { background-position: 100% 50%; } 
        100% { background-position: 0% 50%; } 
    }

    /* åŠ è½½æ–‡æœ¬æ’ç‰ˆ */
    .loading-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #343a40;
        margin-bottom: 8px;
    }
    .loading-timer {
        font-family: 'Courier New', Courier, monospace;
        font-size: 1.15rem;
        color: #8a2be2;
        font-weight: bold;
    }
    .loading-tips {
        margin-top: 25px;
        font-size: 0.9rem;
        color: #6c757d;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 20px;
        border-radius: 30px;
        display: inline-block;
        transition: opacity 0.5s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        border: 1px solid #e9ecef;
        max-width: 80%;
    }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes spin-reverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
    @keyframes pulse-core { 
        0% { transform: scale(0.8); box-shadow: 0 0 10px #8a2be2; } 
        100% { transform: scale(1.2); box-shadow: 0 0 25px #8a2be2, 0 0 40px #20c997; } 
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-4">
    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="control-panel custom-scrollbar">
                <h4 class="fw-bold mb-4"><i class="bi bi-sliders me-2" style="color:#8a2be2;"></i>åˆ›ä½œæ§åˆ¶å°</h4>
                
                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary small">1. æ ¸å¿ƒæ¨¡å‹å¼•æ“</label>
                    <input type="hidden" id="ai-model-select" value="">
                    <input type="hidden" id="ai-category-select" value="">
                    
                    <ul class="nav nav-pills nav-fill mb-3 model-category-tabs" id="dynamic-category-tabs" role="tablist"></ul>
                    <div class="tab-content" id="dynamic-model-cards"></div>
                </div>

                <div class="mb-4" id="ai-image-upload-block" style="display: none;">
                    <label class="form-label fw-bold text-secondary small d-flex justify-content-between">
                        <span>2. ä¸Šä¼ å‚è€ƒå›¾</span>
                        <span id="ai-img-help" class="text-primary" style="font-size: 0.8rem;"></span>
                    </label>
                    <div class="drag-drop-zone" id="drop-zone" onclick="document.getElementById('file-input-hidden').click()">
                        <i class="bi bi-cloud-arrow-up mb-2 d-block"></i>
                        <span class="text-muted fw-bold">ç‚¹å‡»é€‰æ‹©ï¼Œæˆ–å°†å›¾ç‰‡æ‹–æ‹½è‡³æ­¤</span>
                    </div>
                    <input type="file" id="file-input-hidden" accept="image/*" onchange="handleFiles(this.files)">
                    <div id="preview-container"></div>
                </div>

                <div class="mb-4" id="dynamic-params-container"></div>

                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary small">3. ç”»é¢æè¿° (Prompt)</label>
                    <textarea id="ai-prompt" class="form-control" rows="6" placeholder="è¯¦ç»†æè¿°ä½ æƒ³è¦çš„ç”»é¢ï¼Œå»ºè®®ä½¿ç”¨è‹±æ–‡ã€‚"></textarea>
                </div>

                <button id="btn-generate" class="btn btn-primary w-100 rounded-pill py-3 fw-bold fs-5 shadow-sm" style="background: linear-gradient(135deg, #8a2be2 0%, #4a00e0 100%); border:none;" onclick="startGeneration()">
                    <i class="bi bi-stars me-2"></i>å¼€å§‹ç”Ÿæˆ
                </button>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="canvas-panel">
                <div class="canvas-placeholder" id="canvas-idle">
                    <i class="bi bi-palette"></i>
                    <h3 class="mt-3 fw-bold">ä½ çš„åˆ›æ„ç”»å¸ƒ</h3>
                    <p>åœ¨å·¦ä¾§è°ƒæ•´å‚æ•°å¹¶ç‚¹å‡»ç”Ÿæˆï¼Œåœ¨æ­¤è§è¯å¥‡è¿¹ã€‚</p>
                </div>

                <div class="scanning-effect" id="canvas-scanning"></div>
                
                <div id="canvas-loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 11; text-align: center; width: 100%;">
                    <div class="fluid-blob"></div>
                    
                    <div class="loading-title">âœ¨ æ­£åœ¨äº‘ç«¯æ¸²æŸ“æ‚¨çš„ä¸“å±ç”»ä½œ</div>
                    
                    <div class="loading-timer">å·²ç­‰å¾…: <span id="loading-timer-sec">00:00</span></div>
                    
                    <div class="loading-tips" id="loading-tips">ğŸ’¡ å°è´´å£«ï¼šå‡†å¤‡ç”»å¸ƒä¸­...</div>
                </div>

                <div id="result-gallery" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; gap: 16px; z-index: 5;">
                </div>

                <div id="publish-bar" style="display: none; position: absolute; bottom: 30px; right: 30px; z-index: 20;" class="d-flex gap-3">
                    <button class="btn btn-primary rounded-pill px-4 py-2 shadow-lg fw-bold d-flex align-items-center" onclick="openAddToGroupModal()" style="border:none; transition: transform 0.2s;">
                        <i class="bi bi-collection-fill fs-5 me-2"></i>è¿½åŠ åˆ°ç°æœ‰ä½œå“
                    </button>
                    <button class="btn btn-success rounded-pill px-4 py-2 shadow-lg fw-bold d-flex align-items-center btn-publish-glow" onclick="publishCreation()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border:none;">
                        <i class="bi bi-box-arrow-up fs-5 me-2"></i>ä¿å­˜ä¸ºæ–°ä½œå“
                    </button>
                </div>
                <div class="modal fade" id="publishModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-4">
                            <div class="modal-header border-0 pb-0">
                                <h5 class="modal-title fw-bold"><i class="bi bi-send-check text-success me-2"></i>å‘å¸ƒä½œå“å¡ç‰‡</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body pt-4">
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary small">å¡ç‰‡æ ‡é¢˜ <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="pub-title" placeholder="ç»™ä½ çš„ä½œå“èµ·ä¸ªç”ŸåŠ¨çš„åå­—...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary small">æ‰€å±æ¨¡å‹</label>
                                    <input type="text" class="form-control" id="pub-model" placeholder="ä½¿ç”¨çš„ AI æ¨¡å‹ (å¯ä¿®æ”¹)">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-secondary small">å‡ºåœºäººç‰© (ç‚¹å‡»å¤šé€‰)</label>
                                    <div class="d-flex flex-wrap gap-2 mb-2 custom-scrollbar" id="pub-chars-container" style="max-height: 100px; overflow-y: auto; padding-bottom: 5px;">
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white"><i class="bi bi-person-plus text-muted"></i></span>
                                        <input type="text" class="form-control" id="pub-custom-char" placeholder="è¾“å…¥äººç‰©åæŒ‰å›è½¦è¡¥å…… (æ”¯æŒé€—å·æ‰¹é‡)">
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold text-secondary small">å…³è”æ ‡ç­¾ (ç‚¹å‡»å¤šé€‰)</label>
                                    <div class="d-flex flex-wrap gap-2 mb-2 custom-scrollbar" id="pub-tags-container" style="max-height: 140px; overflow-y: auto; padding-bottom: 5px;">
                                        </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white"><i class="bi bi-plus-lg text-muted"></i></span>
                                        <input type="text" class="form-control" id="pub-custom-tag" placeholder="æ²¡æœ‰æƒ³è¦çš„æ ‡ç­¾ï¼Ÿè¾“å…¥åæŒ‰å›è½¦è¡¥å…… (æ”¯æŒé€—å·æ‰¹é‡è¾“å…¥)">
                                    </div>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-success rounded-pill fw-bold py-2 shadow-sm" onclick="confirmPublish()">
                                        <i class="bi bi-cloud-arrow-up me-2"></i>ç¡®è®¤å‘å¸ƒ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="addToGroupModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content border-0 shadow-lg rounded-4">
                            <div class="modal-header border-0 pb-0">
                                <h5 class="modal-title fw-bold"><i class="bi bi-magic text-primary me-2"></i>é€‰æ‹©ç›®æ ‡ä½œå“ (æŒ‰ç›¸ä¼¼åº¦æ’åº)</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body pt-3">
                                <p class="text-muted small mb-3">ç³»ç»Ÿå·²æ ¹æ®æ‚¨å½“å‰ä½¿ç”¨çš„ Prompt è®¡ç®—äº†å…¨åº“ç›¸ä¼¼åº¦ï¼š</p>
                                <div id="similarGroupsContainer" class="list-group custom-scrollbar" style="max-height: 450px; overflow-y: auto;">
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. è·å–åç«¯ä¼ æ¥çš„è¶…çº§é…ç½®å¯¹è±¡
    const AI_CONFIG = JSON.parse('{{ ai_config_json|safe }}');
    let currentFiles = []; 
    let maxImagesAllowed = 0;
    let lastSavedPaths = []; // æš‚å­˜æœ€æ–°ç”Ÿæˆçš„æœ¬åœ°å›¾ç‰‡è·¯å¾„
    let initialTagsForPublish = [];
    let initialCharsForPublish = [];
    let allAvailableTags = [];
    let allAvailableChars = [];
    let currentSelectedTags = new Set(); // ã€æ–°å¢ã€‘ä¿å­˜å½“å‰è¢«é€‰ä¸­çš„æ ‡ç­¾
    let currentSelectedChars = new Set();

    document.addEventListener('DOMContentLoaded', () => {
        initDynamicUI();
        setupDragAndDrop();
        // è§£æå…¨åº“æ ‡ç­¾
        try {
            allAvailableTags = JSON.parse('{{ all_tags_json|escapejs }}');
            allAvailableChars = JSON.parse('{{ all_chars_json|escapejs }}'); // ã€æ–°å¢ã€‘
        } catch(e) { console.log("è§£æç³»ç»Ÿæ ‡ç­¾å¤±è´¥", e); }

        // ã€æ–°å¢ã€‘ç»‘å®šäººç‰©è‡ªå®šä¹‰è¾“å…¥æ¡†çš„å›è½¦äº‹ä»¶
        const customCharInput = document.getElementById('pub-custom-char');
        if (customCharInput) {
            customCharInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newChars = this.value.split(/[,ï¼Œ]/); 
                    let added = false;
                    newChars.forEach(char => {
                        const c = char.trim();
                        if (c && !currentSelectedChars.has(c)) {
                            currentSelectedChars.add(c);
                            if (!allAvailableChars.includes(c)) allAvailableChars.push(c);
                            added = true;
                        }
                    });
                    if (added) {
                        this.value = '';
                        renderPublishChars(Array.from(currentSelectedChars));
                    }
                }
            });
        }
        
        // ç»‘å®šè‡ªå®šä¹‰æ ‡ç­¾æ¡†çš„å›è½¦äº‹ä»¶
        const customTagInput = document.getElementById('pub-custom-tag');
        if (customTagInput) {
            customTagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // æ”¯æŒä¸­è‹±æ–‡é€—å·åŒæ—¶åˆ†éš”æ·»åŠ å¤šä¸ª
                    const newTags = this.value.split(/[,ï¼Œ]/); 
                    let added = false;
                    
                    newTags.forEach(tag => {
                        const t = tag.trim();
                        if (t && !currentSelectedTags.has(t)) {
                            currentSelectedTags.add(t);
                            if (!allAvailableTags.includes(t)) {
                                allAvailableTags.push(t);
                            }
                            added = true;
                        }
                    });
                    
                    if (added) {
                        this.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                        renderPublishTags(Array.from(currentSelectedTags)); // é‡æ–°æ¸²æŸ“æ ‡ç­¾äº‘
                    }
                }
            });
        }
        // ==========================================
        // ã€æ–°å¢ã€‘æ¥æ”¶å¹¶å¤„ç†ä»è¯¦æƒ…é¡µå¸¦å…¥çš„é¢„å¡«å……æ•°æ®
        // ==========================================
        try {
            // è§£æåç«¯æ³¨å…¥çš„ JSON æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æˆ–è€…ä¸ºç©ºåˆ™é»˜è®¤ä¸ºç©ºå¯¹è±¡
            const initialDataStr = '{{ initial_data_json|escapejs }}';
            if (initialDataStr && initialDataStr !== "{}") {
                const initialData = JSON.parse(initialDataStr);
                
                // 1. å¡«å……çº¯å‡€çš„æç¤ºè¯
                if (initialData.prompt) {
                    document.getElementById('ai-prompt').value = initialData.prompt;
                }
                
                // 2. å•ç‹¬ä¿å­˜æ ‡ç­¾ï¼Œä»…ä¾›å³ä¸‹è§’â€œå‘å¸ƒå¡ç‰‡â€å¼¹çª—é‡Œçš„æ ‡ç­¾äº‘ä½¿ç”¨ï¼Œä¸æ±¡æŸ“æç¤ºè¯æ–‡æœ¬æ¡†
                if (initialData.tags && initialData.tags.length > 0) {
                    initialTagsForPublish = initialData.tags; 
                }
                if (initialData.characters && initialData.characters.length > 0) {
                    initialCharsForPublish = initialData.characters; 
                }
                let modelToastMsg = null;
                
                // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ model_info å­˜åœ¨ä¸”ç¡®å®æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œé˜²æ­¢ null.trim() æŠ¥é”™å´©æºƒ
                if (initialData.model_info && typeof initialData.model_info === 'string') {
                    const dbModelName = initialData.model_info.trim().toLowerCase();
                    console.log("ğŸ‘‰ [æ¨¡å‹åŒ¹é…æµ‹è¯•] ä»å¡ç‰‡è¯»å–åˆ°çš„æ¨¡å‹åæ˜¯:", dbModelName);
                    
                    let targetModelId = null;
                    let targetCategoryId = null;

                    for (const [key, model] of Object.entries(AI_CONFIG.models)) {
                        if (model.title && model.title.trim().toLowerCase() === dbModelName) {
                            targetModelId = key;
                            targetCategoryId = model.category;
                            break;
                        }
                    }

                    if (targetModelId) {
                        console.log("âœ… [æ¨¡å‹åŒ¹é…æµ‹è¯•] æˆåŠŸåŒ¹é…åˆ°äº‘ç«¯æ¨¡å‹ï¼ŒID:", targetModelId);
                        switchCategory(targetCategoryId);
                        const targetCard = document.getElementById(`card-${targetModelId}`);
                        if (targetCard) targetCard.click();
                        
                        modelToastMsg = {
                            icon: 'success',
                            title: `å·²ä¸ºæ‚¨è‡ªåŠ¨åŒ¹é…æ¨¡å‹ï¼š${initialData.model_info}`
                        };
                    } else {
                        console.log("âŒ [æ¨¡å‹åŒ¹é…æµ‹è¯•] åŒ¹é…å¤±è´¥ï¼Œäº‘ç«¯å¤§æ¨¡å‹åˆ—è¡¨é‡Œæ²¡æœ‰è¿™ä¸ªåå­—ã€‚");
                        modelToastMsg = {
                            icon: 'info',
                            title: `æ¨¡å‹ã€${initialData.model_info}ã€‘æš‚ä¸æ”¯æŒäº‘ç«¯è°ƒç”¨ï¼Œå·²é€‰æ‹©é»˜è®¤æ¨¡å‹ã€‚`
                        };
                    }
                } else {
                    console.log("â„¹ï¸ [æ¨¡å‹åŒ¹é…æµ‹è¯•] å¡ç‰‡æ•°æ®ä¸­æ²¡æœ‰å¸¦å…¥æ¨¡å‹æ ‡ç­¾ï¼Œè·³è¿‡åŒ¹é…ã€‚");
                }

                // å®šä¹‰ä¸€ä¸ªä¸“å±çš„å¼¹çª—æ’­æ”¾å‡½æ•°ï¼Œå½»åº•é¿å¼€åŠ¨ç”»å†²çª
                const fireModelToast = () => {
                    if (modelToastMsg) {
                        console.log("ğŸ“¢ [æ¨¡å‹åŒ¹é…æµ‹è¯•] å‡†å¤‡å¼¹å‡ºæç¤ºæ¡†...");
                        setTimeout(() => {
                            Swal.fire({
                                toast: true, position: 'top', showConfirmButton: false, timer: 4500,
                                icon: modelToastMsg.icon, title: modelToastMsg.title
                            });
                        }, 600); // å»¶è¿ŸåŠ åˆ° 600 æ¯«ç§’ï¼Œç¡®ä¿¡ä¸Šä¸€ä¸ªå…¨å±å¼¹çª—å·²ç»å½»åº•æ¶ˆå¤±
                    }
                };

                // 2. è‡ªåŠ¨æŠ“å–å¹¶å¡«å……å‚è€ƒå›¾
                if (initialData.reference_urls && initialData.reference_urls.length > 0) {
                    Swal.fire({
                        title: 'æ­£åœ¨å¯¼å…¥å‚è€ƒå›¾...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    Promise.all(initialData.reference_urls.map(url => 
                        fetch(url)
                            .then(res => res.blob())
                            .then(blob => {
                                const filename = url.split('/').pop().split('?')[0] || 'reference_image.jpg';
                                return new File([blob], filename, { type: blob.type || 'image/jpeg' });
                            })
                    )).then(files => {
                        if (maxImagesAllowed === 1) {
                            currentFiles = [files[0]]; 
                        } else if (maxImagesAllowed > 1) {
                            currentFiles = [...currentFiles, ...files].slice(0, maxImagesAllowed); 
                        }
                        renderPreviews();
                        
                        // å…³é—­åŠ è½½å¼¹çª—ï¼Œå¹¶è°ƒç”¨æˆ‘ä»¬å†™å¥½çš„å»¶è¿Ÿåå¸å‡½æ•°
                        Swal.close();
                        fireModelToast();
                        
                    }).catch(err => {
                        console.error("åŠ è½½å‚è€ƒå›¾å¤±è´¥:", err);
                        Swal.fire('å¯¼å…¥æç¤º', 'éƒ¨åˆ†å‚è€ƒå›¾å¯¼å…¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ ', 'warning');
                    });
                } else {
                    // æ²¡æœ‰å‚è€ƒå›¾ï¼Œç›´æ¥å¼¹æ¨¡å‹æç¤º
                    fireModelToast();
                }
            }
        } catch(e) {
            console.error("âŒ æ— é¢„å¡«å……æ•°æ®æˆ–è§£æå¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…:", e);
        }

        // ==========================================
        // ã€æ–°å¢ã€‘ç›‘å¬åŠ¨æ€å‚æ•°çš„æ”¹å˜ (æ”¯æŒ select å’Œ range)
        // ==========================================
        const dynamicContainer = document.getElementById('dynamic-params-container');
        
        // æå–å‡ºä¸€ä¸ªé€šç”¨å¤„ç†å‡½æ•°
        function handleDynamicInput(e) {
            if (e.target.classList.contains('dynamic-param-input')) {
                const modelChoice = document.getElementById('ai-model-select').value;
                if (modelChoice.toLowerCase().includes('seedream')) {
                    const paramId = e.target.getAttribute('data-param-id');
                    
                    if (paramId === 'max_images' || paramId === 'num_images') {
                        updateSeedreamPrompt(e.target.value);
                    } else if (paramId === 'prompt_aspect_ratio') {
                        // ç›‘å¬åˆ°ä¸‹æ‹‰æ¡†åˆ‡æ¢ï¼Œå®æ—¶æ›´æ–°åç¼€
                        updateSeedreamAspectRatio(e.target.value);
                    }
                }
            }
        }

        // åŒæ—¶ç›‘å¬ input(æ‹–åŠ¨ä¸­) å’Œ change(æ¾å¼€/ä¸‹æ‹‰æ”¹å˜)
        dynamicContainer.addEventListener('input', handleDynamicInput);
        dynamicContainer.addEventListener('change', handleDynamicInput);
    });

    // === é’ˆå¯¹ seedream æ¨¡å‹çš„ç‰¹æ®Šå¤„ç†å‡½æ•° ===
    function updateSeedreamPrompt(count) {
        const promptInput = document.getElementById('ai-prompt');
        let text = promptInput.value;
        // æ­£åˆ™åŒ¹é…ï¼šä»¥â€œç”Ÿæˆâ€å¼€å¤´ï¼Œä¸­é—´æ˜¯ä»»æ„æ•°å­—ï¼Œç´§è·Ÿâ€œå¼ å›¾ç‰‡ï¼šâ€
        const prefixRegex = /^ç”Ÿæˆ\d+å¼ å›¾ç‰‡ï¼š/;
        
        if (prefixRegex.test(text)) {
            // å¦‚æœå·²ç»æœ‰å‰ç¼€äº†ï¼Œæ›¿æ¢æ‰æ•°å­—
            promptInput.value = text.replace(prefixRegex, `ç”Ÿæˆ${count}å¼ å›¾ç‰‡ï¼š`);
        } else {
            // å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥åŠ åœ¨æœ€å‰é¢
            promptInput.value = `ç”Ÿæˆ${count}å¼ å›¾ç‰‡ï¼š` + text;
        }
    }

    function removeSeedreamPrompt() {
        const promptInput = document.getElementById('ai-prompt');
        const prefixRegex = /^ç”Ÿæˆ\d+å¼ å›¾ç‰‡ï¼š/;
        if (prefixRegex.test(promptInput.value)) {
            // åˆ‡æ¢æ¨¡å‹æ—¶ï¼Œè‡ªåŠ¨æ¸…ç†æ‰è¿™ä¸ªå‰ç¼€
            promptInput.value = promptInput.value.replace(prefixRegex, '');
        }
    }

    // === é’ˆå¯¹ seedream æ¨¡å‹çš„ç‰¹æ®Šå¤„ç†å‡½æ•° (å®½é«˜æ¯”) ===
    function updateSeedreamAspectRatio(ratio) {
        const promptInput = document.getElementById('ai-prompt');
        let text = promptInput.value;
        // æ­£åˆ™åŒ¹é…ï¼šä»»æ„ä½ç½®çš„ "ï¼Œç”»é¢æ¯”ä¾‹ï¼šX:Y" æˆ– " ç”»é¢æ¯”ä¾‹ï¼šX:Y"
        const ratioRegex = /(?:ï¼Œ|\s)*ç”»é¢æ¯”ä¾‹ï¼š\d+:\d+/g;

        // æ— è®ºå¦‚ä½•ï¼Œå…ˆæ¸…ç†æ‰æ—§çš„æ¯”ä¾‹æ–‡æœ¬
        text = text.replace(ratioRegex, '').trim();

        if (ratio !== 'none') {
            // å¦‚æœé€‰æ‹©äº†æ¯”ä¾‹ï¼Œåˆ™åœ¨æç¤ºè¯æœ«å°¾è¿½åŠ 
            if (text.length > 0) {
                text += `ï¼Œç”»é¢æ¯”ä¾‹ï¼š${ratio}`;
            } else {
                text = `ç”»é¢æ¯”ä¾‹ï¼š${ratio}`;
            }
        }
        promptInput.value = text;
    }

    function removeSeedreamAspectRatio() {
        const promptInput = document.getElementById('ai-prompt');
        const ratioRegex = /(?:ï¼Œ|\s)*ç”»é¢æ¯”ä¾‹ï¼š\d+:\d+/g;
        // åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å‹æ—¶ï¼Œè‡ªåŠ¨æ¸…ç†æ‰è¿™ä¸ªåç¼€
        promptInput.value = promptInput.value.replace(ratioRegex, '').trim();
    }

    // === æ ¸å¿ƒæ¸²æŸ“å¼•æ“ï¼šæ ¹æ®åç«¯é…ç½®ç”Ÿæˆ UI ===
    function initDynamicUI() {
        const tabsContainer = document.getElementById('dynamic-category-tabs');
        const cardsContainer = document.getElementById('dynamic-model-cards');
        
        // éå†ç”Ÿæˆ Tabs å’Œ å¯¹åº”çš„é¢æ¿
        AI_CONFIG.categories.forEach((cat, index) => {
            const isActive = index === 0 ? 'active' : '';
            
            // æ¸²æŸ“ Tab
            tabsContainer.innerHTML += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive}" data-bs-toggle="tab" data-bs-target="#tab-${cat.id}" 
                            type="button" onclick="switchCategory('${cat.id}')">${cat.title}</button>
                </li>
            `;
            
            // æ¸²æŸ“é¢æ¿å®¹å™¨
            const showClass = index === 0 ? 'show active' : '';
            let cardsHtml = `<div class="tab-pane fade ${showClass}" id="tab-${cat.id}" role="tabpanel"><div class="row g-2">`;
            
            // éå†æ¨¡å‹ï¼ŒæŠŠå±äºè¯¥åˆ†ç±»çš„æ¨¡å‹æ¸²æŸ“æˆå¡ç‰‡
            for (const [modelId, model] of Object.entries(AI_CONFIG.models)) {
                if (model.category === cat.id) {
                    cardsHtml += `
                        <div class="col-6">
                            <div class="model-card" id="card-${modelId}" onclick="selectModel('${modelId}', '${cat.id}', this)">
                                <div class="model-card-title">${model.title} <i class="bi bi-check-circle-fill check-icon" style="display:none;"></i></div>
                                <p class="model-card-desc">${model.desc}</p>
                            </div>
                        </div>
                    `;
                }
            }
            cardsHtml += `</div></div>`;
            cardsContainer.innerHTML += cardsHtml;
        });

        // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªåˆ†ç±»
        switchCategory(AI_CONFIG.categories[0].id);
    }

    function switchCategory(categoryId) {
        document.getElementById('ai-category-select').value = categoryId;
        
        // ä»é…ç½®ä¸­æ‰¾åˆ°å½“å‰åˆ†ç±»çš„å…ƒæ•°æ®
        const catConfig = AI_CONFIG.categories.find(c => c.id === categoryId);
        maxImagesAllowed = catConfig.img_max;

        const imgBlock = document.getElementById('ai-image-upload-block');
        const fileInput = document.getElementById('file-input-hidden');
        const imgHelp = document.getElementById('ai-img-help');

        if (maxImagesAllowed === 0) {
            imgBlock.style.display = 'none';
        } else {
            imgBlock.style.display = 'block';
            imgHelp.innerHTML = catConfig.img_help;
            if (maxImagesAllowed === 1) fileInput.removeAttribute('multiple');
            else fileInput.setAttribute('multiple', 'multiple');
        }
        
        currentFiles = [];
        renderPreviews();

        // è‡ªåŠ¨é€‰ä¸­è¯¥åˆ†ç±»ä¸‹çš„ç¬¬ä¸€ä¸ªå¡ç‰‡
        const activeTabPane = document.getElementById(`tab-${categoryId}`);
        const firstCard = activeTabPane.querySelector('.model-card');
        if (firstCard) firstCard.click();
    }

    function selectModel(modelId, categoryId, element) {
        document.querySelectorAll('.model-card').forEach(card => card.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('ai-model-select').value = modelId;
        
        // æ ¹æ®åç«¯é…ç½®æ¸²æŸ“å½“å‰æ¨¡å‹çš„åŠ¨æ€å‚æ•°
        renderDynamicParams(modelId);
    }

    // === åŠ¨æ€æ¸²æŸ“å‚æ•°æ§ä»¶ ===
    function renderDynamicParams(modelId) {
        const container = document.getElementById('dynamic-params-container');
        container.innerHTML = ''; 
        
        const params = AI_CONFIG.models[modelId].params;
        if (!params || params.length === 0) return; 

        let html = `<div class="p-3 bg-light rounded-3 border"><label class="form-label fw-bold text-secondary small mb-3"><i class="bi bi-gear-fill me-1"></i>æ¨¡å‹ä¸“å±å‚æ•°</label><div class="row g-3">`;

        params.forEach(param => {
            html += `<div class="col-12">`;
            if (param.type === 'select') {
                html += `<label class="form-label small text-muted mb-1">${param.label}</label>
                         <select class="form-select form-select-sm dynamic-param-input shadow-sm" data-param-id="${param.id}">`;
                param.options.forEach(opt => {
                    html += `<option value="${opt.value}" ${opt.value === param.default ? 'selected' : ''}>${opt.text}</option>`;
                });
                html += `</select>`;
            } else if (param.type === 'range') {
                // ã€æ ¸å¿ƒç®—æ³•ã€‘è®¡ç®—åˆå§‹çš„ç™¾åˆ†æ¯”ï¼Œç”¨äºæ¸²æŸ“é»˜è®¤çš„ç´«è‰²è¿›åº¦æ¡é•¿åº¦
                const percent = ((param.default - param.min) / (param.max - param.min)) * 100;
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label class="form-label small text-muted mb-0">${param.label}</label>
                        <span class="badge bg-white text-primary border border-primary" id="val-${param.id}">${param.default}</span>
                    </div>
                    
                    <input type="range" class="custom-range-slider dynamic-param-input" 
                           data-param-id="${param.id}" data-param-type="range"
                           min="${param.min}" max="${param.max}" step="${param.step}" value="${param.default}"
                           style="background-size: ${percent}% 100%;"
                           oninput="
                               document.getElementById('val-${param.id}').innerText = this.value;
                               this.style.backgroundSize = ((this.value - this.min) / (this.max - this.min)) * 100 + '% 100%';
                           ">
                `;
            }else if (param.type === 'checkbox') {
                const isChecked = param.default ? 'checked' : '';
                html += `
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input dynamic-param-input" type="checkbox" role="switch" 
                               id="param-${param.id}" data-param-id="${param.id}" data-param-type="checkbox" ${isChecked}>
                        <label class="form-check-label small text-muted fw-bold" for="param-${param.id}">${param.label}</label>
                    </div>`;
            }
            html += `</div>`;
        });
        html += `</div></div>`;
        container.innerHTML = html;
        // ==========================================
    // ã€æ–°å¢ã€‘æ¨¡å‹åˆ‡æ¢æ—¶ï¼Œè‡ªåŠ¨å¤„ç† seedream çš„å‰ç¼€
    // ==========================================
    if (modelId.toLowerCase().includes('seedream')) {
            // 1. å¤„ç†ç”Ÿæˆæ•°é‡å‰ç¼€
            const numInput = container.querySelector('.dynamic-param-input[data-param-id="max_images"], .dynamic-param-input[data-param-id="num_images"]');
            if (numInput) {
                updateSeedreamPrompt(numInput.value);
            }
            
            // 2. å¤„ç†ç”»é¢æ¯”ä¾‹åç¼€
            const ratioInput = container.querySelector('.dynamic-param-input[data-param-id="prompt_aspect_ratio"]');
            if (ratioInput) {
                updateSeedreamAspectRatio(ratioInput.value);
            }
        } else {
            removeSeedreamPrompt();
            removeSeedreamAspectRatio(); // åˆ‡æ¢åˆ°åˆ«çš„æ¨¡å‹ï¼Œä¸€å¹¶æ¸…ç†
        }
    }

    // æ‹–æ‹½ä¸é¢„è§ˆé€»è¾‘ 
    function setupDragAndDrop() {
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    }

    // === æ¸²æŸ“å¤šé€‰æ ‡ç­¾äº‘ ===
    function renderPublishTags(preSelectedTags) {
        const container = document.getElementById('pub-tags-container');
        container.innerHTML = '';
        
        // ç¡®ä¿é¢„é€‰æ ‡ç­¾è¢«åŠ å…¥åˆ° Set ä¸­
        preSelectedTags.forEach(t => currentSelectedTags.add(t));
        
        // æŠŠâ€œå…¨åº“æ ‡ç­¾â€å’Œâ€œé¢„å¸¦å…¥çš„æ ‡ç­¾â€åˆå¹¶å»é‡ (ä»¥é˜²é¢„é€‰æ ‡ç­¾è¿˜æ²¡å­˜è¿›æ•°æ®åº“)
        const combinedTags = Array.from(new Set([...allAvailableTags, ...preSelectedTags]));
        
        if (combinedTags.length === 0) {
            container.innerHTML = '<span class="text-muted small">æš‚æ— ç³»ç»Ÿæ ‡ç­¾ï¼Œè¯·åœ¨ä¸‹æ–¹æ‰‹åŠ¨æ·»åŠ </span>';
            return;
        }

        combinedTags.forEach(tag => {
            const badge = document.createElement('span');
            badge.className = 'pub-tag-badge';
            
            // åˆ¤æ–­æ˜¯å¦åº”è¯¥å¤„äºé«˜äº®(é€‰ä¸­)çŠ¶æ€
            if (currentSelectedTags.has(tag)) {
                badge.classList.add('active');
                badge.innerHTML = `<i class="bi bi-check2 me-1"></i>${tag}`; // æ‰“ä¸ªå‹¾
            } else {
                badge.textContent = tag;
            }
            
            // ç»‘å®šç‚¹å‡»åˆ‡æ¢é€»è¾‘
            badge.onclick = function() {
                if (currentSelectedTags.has(tag)) {
                    currentSelectedTags.delete(tag);
                    this.classList.remove('active');
                    this.textContent = tag; 
                } else {
                    currentSelectedTags.add(tag);
                    this.classList.add('active');
                    this.innerHTML = `<i class="bi bi-check2 me-1"></i>${tag}`;
                }
            };
            container.appendChild(badge);
        });
    }

    // ã€æ–°å¢ã€‘æ¸²æŸ“äººç‰©äº‘
    function renderPublishChars(preSelectedChars) {
        const container = document.getElementById('pub-chars-container');
        container.innerHTML = '';
        
        preSelectedChars.forEach(c => currentSelectedChars.add(c));
        const combinedChars = Array.from(new Set([...allAvailableChars, ...preSelectedChars]));
        
        if (combinedChars.length === 0) {
            container.innerHTML = '<span class="text-muted small">æš‚æ— è®°å½•äººç‰©ï¼Œè¯·åœ¨ä¸‹æ–¹æ‰‹åŠ¨æ·»åŠ </span>';
            return;
        }

        combinedChars.forEach(char => {
            const badge = document.createElement('span');
            badge.className = 'pub-tag-badge'; // å¤ç”¨ä½ çš„åŸæœ‰æ ·å¼
            
            if (currentSelectedChars.has(char)) {
                // äººç‰©é€‰ä¸­æ—¶ç»™ä¸ªä¸åŒé¢œè‰²çš„åŒºåˆ†ï¼ˆæ¯”å¦‚ Bootstrap çš„ info è“ï¼‰
                badge.className = 'badge bg-info text-dark rounded-pill px-3 py-2 cursor-pointer shadow-sm';
                badge.innerHTML = `<i class="bi bi-person-check-fill me-1"></i>${char}`;
            } else {
                badge.innerHTML = `<i class="bi bi-person me-1"></i>${char}`;
            }
            
            badge.onclick = function() {
                if (currentSelectedChars.has(char)) {
                    currentSelectedChars.delete(char);
                    this.className = 'pub-tag-badge';
                    this.innerHTML = `<i class="bi bi-person me-1"></i>${char}`;
                } else {
                    currentSelectedChars.add(char);
                    this.className = 'badge bg-info text-dark rounded-pill px-3 py-2 cursor-pointer shadow-sm';
                    this.innerHTML = `<i class="bi bi-person-check-fill me-1"></i>${char}`;
                }
            };
            container.appendChild(badge);
        });
    }

    function handleFiles(files) {
        if (!files || files.length === 0 || maxImagesAllowed === 0) return;
        
        if (maxImagesAllowed === 1) {
            currentFiles = [files[0]]; 
        } else {
            currentFiles = [...currentFiles, ...Array.from(files)].slice(0, maxImagesAllowed); 
        }
        renderPreviews();
    }

    // === å¢å¼ºç‰ˆæ¸²æŸ“ç¼©ç•¥å›¾ (å¸¦åˆ é™¤æŒ‰é’®) ===
    function renderPreviews() {
        const container = document.getElementById('preview-container');
        container.innerHTML = ''; // æ¸…ç©ºæ—§è§†å›¾
        
        currentFiles.forEach((file, index) => {
            // 1. åˆ›å»ºåŒ…è£¹ <img> å’Œ <button> çš„å¤–å±‚å®¹å™¨
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-wrapper m-1';
            
            // 2. åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = document.createElement('img');
            img.className = 'preview-item shadow-sm';
            
            // å¼‚æ­¥åŠ è½½å›¾ç‰‡é¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; }
            reader.readAsDataURL(file);
            
            // 3. åˆ›å»ºçº¢è‰²çš„ X åˆ é™¤æŒ‰é’®
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn-remove-preview';
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            
            // ç‚¹å‡»åˆ é™¤æ—¶çš„é€»è¾‘
            removeBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation(); // æå…¶é‡è¦ï¼šé˜»æ­¢ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è¯¯è§¦åº•ä¸‹çš„ä¸Šä¼ æ¡†è§¦å‘æ–‡ä»¶é€‰æ‹©
                removeFile(index);
            };
            
            // ç»„è£…å¹¶å¡è¿›é¡µé¢
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
        });
    }
    // === ã€æ–°å¢ã€‘åˆ é™¤æŒ‡å®šæ–‡ä»¶çš„å‡½æ•° ===
    function removeFile(index) {
        // ä»æ•°ç»„ä¸­å‰”é™¤è¯¥æ–‡ä»¶
        currentFiles.splice(index, 1);
        // é‡æ–°æ¸²æŸ“é¢„è§ˆåŒº
        renderPreviews();
    }

    // åˆ‡æ¢å›¾ç‰‡çš„é€‰ä¸­çŠ¶æ€
    function toggleGenResultSelect(element) {
        element.classList.toggle('selected');
    }

    // è·å–å½“å‰è¢«é€‰ä¸­çš„å›¾ç‰‡è·¯å¾„æ•°ç»„
    function getSelectedSavedPaths() {
        const selectedCards = document.querySelectorAll('.gen-result-card.selected');
        const paths = [];
        selectedCards.forEach(card => {
            paths.push(card.getAttribute('data-path'));
        });
        return paths;
    }

    // === å¼€å§‹ç”Ÿæˆé€šä¿¡ ===
    function startGeneration() {
        const modelChoice = document.getElementById('ai-model-select').value;
        const promptText = document.getElementById('ai-prompt').value;

        if (maxImagesAllowed > 0 && currentFiles.length === 0) {
            Swal.fire('æç¤º', 'å½“å‰æ¨¡å‹å¿…é¡»ä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼', 'warning');
            return;
        }
        if (!promptText.trim()) {
            Swal.fire('æç¤º', 'è¯·è¾“å…¥ç”»é¢æè¿°ï¼', 'warning');
            return;
        }

        const btn = document.getElementById('btn-generate');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ç”Ÿæˆä¸­...';
        
        document.getElementById('canvas-idle').style.display = 'none';
        document.getElementById('publish-bar').style.display = 'none';
        const gallery = document.getElementById('result-gallery');
        if(gallery) {
            gallery.style.display = 'none';
            gallery.innerHTML = ''; 
        }
        document.getElementById('canvas-scanning').style.display = 'block';
        document.getElementById('canvas-loading').style.display = 'block';

        // ==========================================
        // å¯åŠ¨è®¡æ—¶å™¨ä¸å°è´´å£«è½®æ’­
        // ==========================================
        const promptTips = [
            "ğŸ’¡ å°è´´å£«ï¼šæƒ³è¦å¤§ç‰‡æ„Ÿï¼Ÿå°è¯•åœ¨æç¤ºè¯åŠ å…¥ã€Œä¸è¾¾å°”æ•ˆåº”ã€ã€ã€Œé€†å…‰ã€æˆ–ã€Œç”µå½±çº§ä½“ç§¯å…‰ã€ã€‚",
            "ğŸ’¡ å°è´´å£«ï¼šé‡åˆ°æŠ¥é”™ï¼Ÿå¯èƒ½æ˜¯ä¸å°å¿ƒè§¦å‘äº†å®‰å…¨è¯ï¼Œå°è¯•æ¢ä¸ªæ›´å§”å©‰çš„è¯´æ³•å§ã€‚",
            "ğŸ’¡ å°è´´å£«ï¼šä¸çŸ¥é“æ€ä¹ˆé€‰å°ºå¯¸ï¼Ÿäººç‰©è‚–åƒæ¨è 3:4ï¼Œé£æ™¯å’Œå®½å±å£çº¸æ¨è 16:9ã€‚",
            "ğŸ’¡ å°è´´å£«ï¼šå¤šå›¾èåˆæ—¶ï¼Œä¸Šä¼ ä¸¤å¼ é£æ ¼å·®å¼‚å¤§çš„å›¾ç‰‡ï¼Œå¯èƒ½ä¼šæœ‰å·¨å¤§çš„æƒŠå–œï¼",
            "ğŸ’¡ å°è´´å£«ï¼šåœ¨æç¤ºè¯å¼€å¤´æ˜ç¡®ã€Œä¸»ä½“ã€å’Œã€Œç¯å¢ƒã€ï¼Œèƒ½å¤§å¹…æé«˜ AI çš„ç†è§£å‡†ç¡®åº¦ã€‚",
            "ğŸ’¡ å°è´´å£«ï¼šåŠ å…¥ã€Œèƒ¶ç‰‡è´¨æ„Ÿã€ã€ã€Œå®ä¸½æ¥é£æ ¼ã€æˆ–ã€Œå™ªç‚¹ã€ï¼Œèƒ½è®©ç”»é¢å……æ»¡å¤å¤æ°›å›´ã€‚"
        ];
        
        let elapsedSeconds = 0;
        let tipIndex = 0;
        const timerElement = document.getElementById('loading-timer-sec');
        const tipsElement = document.getElementById('loading-tips');
        
        // é‡ç½®åˆå§‹çŠ¶æ€
        timerElement.innerText = "00:00";
        tipsElement.innerText = promptTips[0];
        tipsElement.style.opacity = 1;

        // æ ¸å¿ƒè®¡æ—¶ä¸è½®æ’­å™¨ (æ¯ç§’æ‰§è¡Œä¸€æ¬¡)
        const loadingInterval = setInterval(() => {
            elapsedSeconds++;
            
            // 1. æ›´æ–°çœŸå®ç­‰å¾…æ—¶é—´ (00:05 æ ¼å¼)
            const m = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
            const s = (elapsedSeconds % 60).toString().padStart(2, '0');
            timerElement.innerText = `${m}:${s}`;

            // 2. æ¯éš” 4 ç§’åˆ‡æ¢ä¸€æ¡å°è´´å£«
            if (elapsedSeconds % 4 === 0) {
                tipsElement.style.opacity = 0; // å…ˆæ·¡å‡º
                setTimeout(() => {
                    tipIndex++;
                    tipsElement.innerText = promptTips[tipIndex % promptTips.length];
                    tipsElement.style.opacity = 1; // å†æ·¡å…¥
                }, 500); 
            }
        }, 1000);

        const formData = new FormData();
        formData.append('model_choice', modelChoice);
        formData.append('prompt', promptText);
        
        if (maxImagesAllowed > 0) {
            currentFiles.forEach(file => formData.append('base_images', file));
        }

        // æ”¶é›†æ‰€æœ‰åŠ¨æ€å‚æ•°
        document.querySelectorAll('.dynamic-param-input').forEach(input => {
            const paramId = input.getAttribute('data-param-id');
            const paramType = input.getAttribute('data-param-type');

            // ã€æ–°å¢æ‹¦æˆªã€‘ï¼šç»å¯¹ä¸è¦æŠŠè¿™ä¸ªè™šæ‹Ÿå‚æ•°å‘ç»™äº‘ç«¯ API
            if (paramId === 'prompt_aspect_ratio') return;
            if (paramType === 'checkbox') {
                // å¤é€‰æ¡†å– checked å±æ€§ï¼Œè½¬æˆå­—ç¬¦ä¸² "true" æˆ– "false" å‘ç»™åç«¯
                formData.append(paramId, input.checked); 
            } else {
                formData.append(paramId, input.value);
            }
        });

        fetch('/api/generate-direct/', {
            method: 'POST',
            body: formData 
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(loadingInterval); // æˆåŠŸåæ¸…é™¤è½®æ’­åŠ¨ç”»
            if (data.status === 'success') {
                lastSavedPaths = data.saved_paths;
                document.getElementById('publish-bar').style.display = 'block';

                const gallery = document.getElementById('result-gallery');
                gallery.innerHTML = '';
                
                const imgCount = data.image_urls.length;

                // ==========================================
                // ã€ç»ˆææ’ç‰ˆä¿®å¤ã€‘ä½¿ç”¨ CSS Grid ç»å¯¹æ§åˆ¶ç½‘æ ¼
                // æµè§ˆå™¨ä¼šä¸¥æ ¼æ ¹æ® 1fr çš„æ¯”ä¾‹åˆ‡å‰²ç©ºé—´ï¼Œç»å¯¹ä¸ä¼šæº¢å‡º
                // ==========================================
                gallery.style.display = 'grid';
                
                if (imgCount === 1) {
                    // 1å¼ å›¾ï¼š1è¡Œ1åˆ—ï¼Œå¡«æ»¡
                    gallery.style.gridTemplateColumns = '1fr';
                    gallery.style.gridTemplateRows = '1fr';
                } else if (imgCount === 2) {
                    // 2å¼ å›¾ï¼š1è¡Œ2åˆ—ï¼Œå·¦å³å¹³åˆ†
                    gallery.style.gridTemplateColumns = '1fr 1fr';
                    gallery.style.gridTemplateRows = '1fr';
                } else {
                    // 3æˆ–4å¼ å›¾ï¼š2è¡Œ2åˆ— (æ ‡å‡†çš„å››å®«æ ¼)
                    gallery.style.gridTemplateColumns = '1fr 1fr';
                    gallery.style.gridTemplateRows = '1fr 1fr';
                }

                // éå† URL æ‹¼è£… HTML (å¸¦æœ‰é€‰æ‹©åŠŸèƒ½ï¼Œé»˜è®¤å…¨é€‰)
                data.image_urls.forEach((url, index) => {
                    const localPath = data.saved_paths[index]; // è·å–å¯¹åº”çš„æœ¬åœ°å­˜å‚¨è·¯å¾„
                    gallery.innerHTML += `
                        <div class="gen-result-card selected" data-path="${localPath}" onclick="toggleGenResultSelect(this)">
                            <img src="${url}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
                            <div class="select-badge"><i class="bi bi-check-lg"></i></div>
                        </div>
                    `;
                });
                
                Swal.fire({ 
                    title: 'ğŸ‰ ç”ŸæˆæˆåŠŸï¼', 
                    text: data.message, 
                    icon: 'success', 
                    toast: true, 
                    position: 'top-end', 
                    showConfirmButton: false, 
                    timer: 5000 
                });
            } else {
                document.getElementById('canvas-idle').style.display = 'block';
                Swal.fire('ç”Ÿæˆå¤±è´¥', data.message, 'error');
            }
        })
        .catch(error => {
            clearInterval(loadingInterval);
            document.getElementById('canvas-idle').style.display = 'block';
            Swal.fire('è¯·æ±‚å¼‚å¸¸', 'ç½‘ç»œæˆ–æœåŠ¡ç«¯æŠ¥é”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
        })
        .finally(() => {
            clearInterval(loadingInterval);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stars me-2"></i>å¼€å§‹ç”Ÿæˆ';
            document.getElementById('canvas-scanning').style.display = 'none';
            document.getElementById('canvas-loading').style.display = 'none';
        });
    }
    // === 1. ç‚¹å‡»æ‚¬æµ®æŒ‰é’®ï¼Œå¼¹å‡ºä¿¡æ¯å¡«å†™æ¡†å¹¶é¢„å¡«å……æ•°æ® ===
    function publishCreation() {
        const selectedPaths = getSelectedSavedPaths();
    if (selectedPaths.length === 0) {
        Swal.fire('æç¤º', 'è¯·è‡³å°‘åœ¨ç”»æ¿ä¸­å‹¾é€‰ä¸€å¼ è¦ä¿å­˜çš„å›¾ç‰‡ï¼', 'warning');
        return;
    }

    const activeModelCard = document.querySelector('.model-card.active');
    const modelName = activeModelCard ? activeModelCard.querySelector('.model-card-title').innerText.trim() : document.getElementById('ai-model-select').value;
    
    // å¡«å……æ¨¡å‹åç§°
    document.getElementById('pub-model').value = modelName;
    
    // è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œä¼ å…¥åˆå§‹åŒ–æ ‡ç­¾ï¼Œæ­¤æ—¶æ¨¡å‹æ ‡ç­¾ä¼šè‡ªåŠ¨é«˜äº®æ‰“å‹¾
    renderPublishTags(initialTagsForPublish);
    renderPublishChars(initialCharsForPublish);
    // ã€ä¿®å¤2ã€‘ï¼šå¼‚æ­¥è°ƒç”¨åç«¯å¤§æ¨¡å‹ç”Ÿæˆæ ‡é¢˜å¹¶å›æ˜¾åˆ°è¾“å…¥æ¡†
    const promptText = document.getElementById('ai-prompt').value.trim();
    const titleInput = document.getElementById('pub-title');
    
    if (promptText) {
        titleInput.value = "æ­£åœ¨ç”± AI æ™ºèƒ½æ¦‚æ‹¬æ ‡é¢˜...";
        titleInput.disabled = true; // æš‚æ—¶ç¦ç”¨ï¼Œé˜²æ­¢ç”¨æˆ·åœ¨ç”ŸæˆæœŸé—´ä¹±æ•²
        
        // å‘èµ·å¼‚æ­¥è¯·æ±‚è·å–æ ‡é¢˜
        fetch('/api/generate-title/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: promptText })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success' && data.title) {
                titleInput.value = data.title;
            } else {
                titleInput.value = ""; 
                titleInput.placeholder = "è‡ªåŠ¨æ¦‚æ‹¬å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥";
            }
        })
        .catch(err => {
            titleInput.value = "";
            titleInput.placeholder = "è¯·æ‰‹åŠ¨è¾“å…¥æ ‡é¢˜";
        })
        .finally(() => {
            titleInput.disabled = false; // æ¢å¤å¯ç¼–è¾‘çŠ¶æ€
        });
    } else {
        titleInput.value = "";
        titleInput.placeholder = "è¯·è¾“å…¥æ ‡é¢˜...";
    }

    // å¼¹å‡ºå¼¹çª—
    new bootstrap.Modal(document.getElementById('publishModal')).show();
    }

    // === 2. åœ¨å¼¹çª—å†…ç‚¹å‡»â€œç¡®è®¤å‘å¸ƒâ€ï¼ŒçœŸæ­£å‘åç«¯å‘é€è¯·æ±‚ ===
    function confirmPublish() {
        const titleInput = document.getElementById('pub-title').value.trim();
        const modalEl = document.getElementById('publishModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) modalInstance.hide();

        Swal.fire({
            title: 'æ­£åœ¨æ‰“åŒ…å¹¶å‘å¸ƒ...',
            text: 'è¯·ç¨å€™ï¼ŒæœåŠ¡å™¨æ­£åœ¨ç”Ÿæˆè®°å½•',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        const formData = new FormData();
        formData.append('prompt', document.getElementById('ai-prompt').value);
        formData.append('title', titleInput);
        formData.append('model_info', document.getElementById('pub-model').value.trim());
        
        // ä» currentSelectedTags é›†åˆä¸­æå–é€‰ä¸­çš„æ ‡ç­¾ï¼Œè½¬ä¸ºå­—ç¬¦ä¸²å‘ç»™åç«¯
        const finalTags = Array.from(currentSelectedTags).join(',');
        formData.append('tags', finalTags);
        const finalChars = Array.from(currentSelectedChars).join(',');
        formData.append('characters', finalChars);
        
        // åªæŠŠé€‰ä¸­çš„å›¾ç‰‡è·¯å¾„å¡è¿›è¡¨å•
        const selectedPaths = getSelectedSavedPaths();
        selectedPaths.forEach(path => {
            formData.append('saved_paths', path);
        });

        if (currentFiles && currentFiles.length > 0) {
            currentFiles.forEach(file => {
                formData.append('references', file);
            });
        }

        fetch('/api/publish-studio/', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'ğŸ‰ å‘å¸ƒæˆåŠŸï¼',
                    text: 'å·²ä¿å­˜è‡³æ‚¨çš„æç¤ºè¯ç”»å»Šã€‚',
                    showCancelButton: true,
                    confirmButtonText: '<i class="bi bi-eye"></i> å‰å¾€æŸ¥çœ‹è¯¥å¡ç‰‡',
                    cancelButtonText: 'ç•™åœ¨æ­¤é¡µç»§ç»­åˆ›ä½œ',
                    confirmButtonColor: '#8a2be2'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.open(`/image/${data.group_id}/`, '_blank');
                    } else {
                        document.getElementById('publish-bar').style.display = 'none';
                    }
                });
            } else {
                Swal.fire('å‘å¸ƒå¤±è´¥', data.message, 'error');
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('è¯·æ±‚å¼‚å¸¸', 'ç½‘ç»œæˆ–æœåŠ¡ç«¯æŠ¥é”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
        });
    }
    // === è¿½åŠ åˆ°ç°æœ‰ç»„çš„æ ¸å¿ƒé€»è¾‘ ===
    function openAddToGroupModal() {
        const selectedPaths = getSelectedSavedPaths();
        if (selectedPaths.length === 0) {
            Swal.fire('æç¤º', 'è¯·è‡³å°‘åœ¨ç”»æ¿ä¸­å‹¾é€‰ä¸€å¼ è¦è¿½åŠ çš„å›¾ç‰‡ï¼', 'warning');
            return;
        }
        
        new bootstrap.Modal(document.getElementById('addToGroupModal')).show();
        fetchSimilarGroupsForAppend();
    }

    function fetchSimilarGroupsForAppend() {
        const promptText = document.getElementById('ai-prompt').value.trim();
        const container = document.getElementById('similarGroupsContainer');
        const activeModelCard = document.querySelector('.model-card.active');
        const currentModelName = activeModelCard ? activeModelCard.querySelector('.model-card-title').innerText.trim() : '';
        container.innerHTML = '<div class="text-center text-muted py-5"><div class="spinner-border text-primary mb-3"></div><br>æ­£åœ¨è®¡ç®—å…¨åº“æç¤ºè¯ç›¸ä¼¼åº¦...</div>';

        fetch('/api/get-similar-groups-by-prompt/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: promptText })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                renderSimilarGroups(data.results, currentModelName);
            } else {
                container.innerHTML = `<div class="text-center text-danger py-4">æ£€ç´¢å¤±è´¥: ${data.message}</div>`;
            }
        })
        .catch(err => {
            console.error(err);
            container.innerHTML = '<div class="text-center text-danger py-4">ç½‘ç»œè¯·æ±‚å¼‚å¸¸</div>';
        });
    }

    function renderSimilarGroups(groups, currentModelName) {
        const container = document.getElementById('similarGroupsContainer');
        if (!groups || groups.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4">æš‚æ— å†å²ä½œå“ã€‚</div>';
            return;
        }

        let html = '';
        groups.forEach(group => {
            // 1. æ¸²æŸ“å°é¢å›¾
            const coverHtml = group.cover_url 
                ? `<img src="${group.cover_url}" class="rounded shadow-sm" style="width: 70px; height: 70px; object-fit: cover;">`
                : `<div class="rounded bg-light shadow-sm d-flex align-items-center justify-content-center text-muted" style="width: 70px; height: 70px;"><i class="bi bi-image fs-4"></i></div>`;

            // 2. ç›¸ä¼¼åº¦æ ‡ç­¾é¢œè‰²åˆ¤å®š
            let badgeClass = 'bg-secondary';
            let simValue = parseInt(group.similarity);
            if(simValue > 80) badgeClass = 'bg-danger';
            else if(simValue > 50) badgeClass = 'bg-warning text-dark';
            else if(simValue > 20) badgeClass = 'bg-primary';

            // 3. ã€ä¿®æ”¹ã€‘å¤„ç†æ¨¡å‹æ ‡ç­¾ UIï¼Œå¹¶åŠ å…¥â€œåŒæ¬¾æ¨¡å‹â€çš„é«˜äº®é€»è¾‘
            let isModelMatch = false;
            if (currentModelName && group.model_info && currentModelName.toLowerCase() === group.model_info.toLowerCase()) {
                isModelMatch = true;
            }

            let modelBadge = '';
            if (group.model_info && group.model_info !== 'æ— æ¨¡å‹') {
                if (isModelMatch) {
                    // ç‰¹æ®ŠUIï¼šå½“å‰åŒæ¬¾æ¨¡å‹ï¼ˆç´«è‰²æ¸å˜å‘å…‰æ ·å¼ï¼Œè·ŸæŒ‰é’®é£æ ¼ç»Ÿä¸€ï¼‰
                    modelBadge = `<span class="badge text-white fw-bold me-2 shadow" style="background: linear-gradient(135deg, #8a2be2 0%, #4a00e0 100%); font-size: 0.75rem;"><i class="bi bi-cpu-fill me-1"></i>${group.model_info} (åŒæ¬¾)</span>`;
                } else {
                    // æ™®é€šæ¨¡å‹æ ·å¼
                    modelBadge = `<span class="badge bg-secondary fw-normal me-2" style="font-size: 0.75rem;"><i class="bi bi-cpu me-1"></i>${group.model_info}</span>`;
                }
            } else {
                modelBadge = `<span class="badge bg-light text-secondary border fw-normal me-2" style="font-size: 0.75rem;">æ— æ¨¡å‹</span>`;
            }

            // 4. ã€é‡ç‚¹æ–°å¢ã€‘ï¼šéå†ç”Ÿæˆäººç‰©å°è“æ ‡
            let charBadges = '';
            if (group.characters && group.characters.length > 0) {
                group.characters.forEach(char => {
                    charBadges += `<span class="badge bg-info text-dark fw-normal me-2" style="font-size: 0.75rem;"><i class="bi bi-person-fill me-1"></i>${char}</span>`;
                });
            }

            // 4. ç»„è£…æœ€ç»ˆçš„å¡ç‰‡ HTML
            html += `
            <a href="javascript:void(0)" class="list-group-item list-group-item-action d-flex gap-3 align-items-center py-3" onclick="confirmAppendToGroup(${group.id}, '${group.title}')">
                ${coverHtml}
                <div class="flex-grow-1 overflow-hidden">
                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 fw-bold text-truncate" style="max-width: 70%;">${group.title}</h6>
                        <span class="badge ${badgeClass} rounded-pill">ç›¸ä¼¼åº¦ ${group.similarity}</span>
                    </div>
                    <div class="mb-0 text-truncate mt-1 d-flex align-items-center">
                        ${modelBadge}
                        ${charBadges} <span class="small text-muted text-truncate">${group.prompt_text}</span>
                    </div>
                </div>
            </a>`;;
        });
        container.innerHTML = html;
    }

    function confirmAppendToGroup(groupId, groupTitle) {
        Swal.fire({
            title: 'ç¡®è®¤è¿½åŠ ?',
            html: `å³å°†æŠŠæ–°ç”Ÿæˆçš„å›¾ç‰‡æ”¶å½•è¿›ä½œå“<br><strong class="text-primary">${groupTitle}</strong>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ç¡®è®¤è¿½åŠ ',
            cancelButtonText: 'å–æ¶ˆ',
            confirmButtonColor: '#8a2be2'
        }).then((result) => {
            if (result.isConfirmed) {
                executeAppendRequest(groupId);
            }
        });
    }

    function executeAppendRequest(groupId) {
        const modalEl = document.getElementById('addToGroupModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) modalInstance.hide();

        Swal.fire({
            title: 'æ­£åœ¨æ‰“åŒ…å¹¶è¿½åŠ ...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        const formData = new FormData();
        formData.append('group_id', groupId);
        
        // ã€å…³é”®ä¿®æ”¹ã€‘åªæŠŠé€‰ä¸­çš„å›¾ç‰‡è·¯å¾„å¡è¿›è¡¨å•
        const selectedPaths = getSelectedSavedPaths();
        selectedPaths.forEach(path => {
            formData.append('saved_paths', path);
        });

        fetch('/api/append-to-existing-group/', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'ğŸ‰ è¿½åŠ æˆåŠŸï¼',
                    text: data.message,
                    showCancelButton: true,
                    confirmButtonText: '<i class="bi bi-eye"></i> å‰å¾€æŸ¥çœ‹',
                    cancelButtonText: 'ç•™åœ¨æ­¤é¡µç»§ç»­åˆ›ä½œ',
                    confirmButtonColor: '#8a2be2'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.open(`/image/${data.group_id}/`, '_blank');
                    } else {
                        // å¦‚æœç•™åœ¨æ­¤é¡µï¼Œå¯ä»¥æ¸…ç©ºæˆ–è€…ä¿æŒç°çŠ¶
                        document.getElementById('publish-bar').style.display = 'none';
                    }
                });
            } else {
                Swal.fire('è¿½åŠ å¤±è´¥', data.message, 'error');
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('è¯·æ±‚å¼‚å¸¸', 'ç½‘ç»œæˆ–æœåŠ¡ç«¯æŠ¥é”™', 'error');
        });
    }
</script>
{% endblock %}